# 数据库 CLI 工具使用指南

## 🎯 概述

数据库 CLI 工具是一个现代化的交互式命令行界面，旨在简化数据库管理操作。它取代了 package.json 中繁多的 db 相关脚本，提供统一、直观的用户体验。

## 🚀 快速开始

### 启动交互式界面

```bash
pnpm db:cli
```

### 查看数据库状态

```bash
pnpm db:status
```

### 快速生成开发数据

```bash
pnpm db:quick
```

## 🎨 用户体验特性

### 📱 美观的交互界面

- **彩色菜单** - 使用图标和颜色区分不同功能模块
- **分层导航** - 清晰的菜单层级，支持返回上级
- **实时反馈** - 操作过程中的进度指示和状态更新
- **智能提示** - 每个选项都有详细的功能说明

### 🛡️ 安全机制

- **操作确认** - 危险操作（如数据清理、重置）需要用户确认
- **参数验证** - 自动验证用户输入的参数
- **优雅中断** - 支持 Ctrl+C 安全退出
- **错误恢复** - 友好的错误信息和修复建议

### ⚡ 性能优化

- **智能检测** - 自动检测环境状态，提供个性化建议
- **并行执行** - 支持并行的数据库操作
- **进度显示** - 长时间操作显示进度条或加载动画
- **缓存机制** - 避免重复的系统检查

## 📋 功能模块详解

### 🗄️ 数据库管理

#### 🚀 初始化数据库

- **功能**：完整的数据库设置流程
- **步骤**：格式化 Schema → 生成客户端 → 推送架构
- **适用场景**：项目首次设置、环境重建

#### 📊 查看数据统计

- **功能**：显示数据库中各表的详细统计信息
- **包含内容**：用户数量、授权码分布、访问日志统计等
- **适用场景**：监控数据增长、验证数据生成结果

#### ✅ 验证数据完整性

- **功能**：检查数据完整性和业务逻辑一致性
- **验证内容**：外键关系、必填字段、业务规则
- **适用场景**：数据迁移后验证、定期健康检查

### 🌱 种子数据管理

#### 🎯 快速开发数据

- **功能**：一键生成适合日常开发的测试数据
- **特点**：数据量适中、覆盖主要场景
- **包含**：管理员、示例组织、测试用户、授权码、访问日志

#### 📋 完整数据集

- **功能**：根据环境生成完整的测试数据集
- **环境选择**：
  - 🛠️ **开发环境**：丰富的测试数据，包含各种边界情况
  - 🧪 **测试环境**：标准化数据集，确保测试一致性
  - 🚀 **生产环境**：最小化必要数据，仅创建管理员账号

#### 分模块数据生成

- **👤 仅管理员账号**：创建系统初始管理员
- **🏢 仅组织架构**：创建组织和部门层级结构
- **👥 仅用户数据**：生成测试用户并分配到组织
- **🎫 仅授权码数据**：生成各种状态的授权码
- **📝 仅访问日志**：为授权码生成访问记录

#### 🧹 清理测试数据

- **智能清理**：可选择保留管理员账号
- **安全确认**：多重确认防止误操作
- **批量操作**：支持按类型选择性清理

### 🔧 Prisma 工具集

#### 🎨 格式化架构文件

- **功能**：自动格式化 `schema.prisma` 文件
- **特点**：统一代码风格、修复语法问题

#### ⚡ 生成客户端

- **标准生成**：包含完整查询引擎的客户端
- **生产生成**：不包含查询引擎，适合部署环境

#### 📤 推送架构

- **功能**：将架构变更推送到数据库
- **安全提示**：警告可能的数据丢失风险

#### 🎛️ Prisma Studio

- **功能**：启动可视化数据库管理界面
- **特点**：图形化数据浏览和编辑

#### 🔄 重置数据库

- **功能**：完全重置数据库结构
- **安全机制**：多重确认，警告数据丢失

### 📊 数据库状态检查

#### 全面健康检查

- **项目配置**：检查必要的配置文件
- **Prisma 状态**：验证 Schema 和客户端状态
- **数据库连接**：测试连接状态和响应时间
- **内容统计**：显示各表的数据分布

#### 健康度评分

- **评分系统**：0-100 分的健康度评分
- **可视化指示**：🟢🟡🟠🔴 颜色区分健康状态
- **修复建议**：针对问题提供具体的修复步骤

## 🎮 使用示例

### 日常开发工作流

#### 场景一：新项目启动

```bash
# 1. 检查项目状态
pnpm db:status

# 2. 初始化数据库
pnpm db:cli
# 选择: 数据库管理 → 初始化数据库

# 3. 生成开发数据
# 选择: 种子数据管理 → 快速开发数据
```

#### 场景二：数据重置

```bash
# 1. 启动CLI
pnpm db:cli

# 2. 清理数据
# 选择: 种子数据管理 → 清理测试数据
# 确认: 保留管理员账号？是

# 3. 重新生成
# 选择: 种子数据管理 → 快速开发数据
```

#### 场景三：生产环境部署

```bash
# 1. 初始化数据库
pnpm db:cli --init

# 2. 创建管理员
pnpm db:cli
# 选择: 种子数据管理 → 完整数据集 → 生产环境
```

### 高级使用场景

#### 场景四：自定义数据生成

```bash
pnpm db:cli
# 1. 选择: 种子数据管理 → 仅用户数据
# 2. 选择选项: 自定义数量
# 3. 输入: 100（用户数量）
# 4. 选择: 强制执行、生成真实访问模式
```

#### 场景五：数据库维护

```bash
pnpm db:cli
# 1. 选择: Prisma 工具 → 格式化架构文件
# 2. 选择: Prisma 工具 → 生成客户端
# 3. 选择: 数据库管理 → 验证数据完整性
```

## 💡 最佳实践

### 🎯 开发阶段

- **日常开发**：使用 `pnpm db:quick` 快速生成数据
- **功能测试**：使用特定模块生成针对性测试数据
- **数据清理**：定期清理，保持数据库整洁

### 🚀 部署阶段

- **环境准备**：使用 `pnpm db:status` 检查环境状态
- **数据初始化**：根据环境选择合适的数据集
- **健康检查**：部署后验证数据完整性

### 🔧 维护阶段

- **定期检查**：使用状态检查功能监控数据库健康
- **性能监控**：通过统计信息了解数据增长趋势
- **问题诊断**：利用详细的错误信息快速定位问题

## 🛠️ 命令行模式

除了交互式界面，还支持直接的命令行操作：

```bash
# 显示帮助
pnpm db:cli --help

# 快速操作
pnpm db:cli --status        # 显示状态
pnpm db:cli --init          # 初始化数据库
pnpm db:cli --seed quick    # 快速生成数据
pnpm db:cli --clean         # 清理数据
pnpm db:cli --stats         # 显示统计

# 环境变量支持
ADMIN_EMAIL=admin@company.com pnpm db:cli --seed admin
```

## 🎨 界面预览

### 主菜单

```
🗄️  数据库管理 CLI 工具
════════════════════════════════════════
这个工具帮助您管理数据库相关的操作
──────────────────────────────────────────

? 请选择操作: (Use arrow keys)
❯ 🗄️  数据库管理
  🌱 种子数据管理
  🔧 Prisma 工具
  📊 数据库状态检查
  ❌ 退出
```

### 状态检查结果

```
📊 数据库状态详细报告
══════════════════════════════════════════════════
→ 📋 项目配置检查:
┌───────────────┬─────────┐
│ 配置项        │ 状态    │
├───────────────┼─────────┤
│ 环境配置文件  │ ✅ 存在 │
│ Prisma Schema │ ✅ 存在 │
│ 种子脚本      │ ✅ 存在 │
└───────────────┴─────────┘

→ 🎯 健康检查总结:
   总体健康度: 🟢 100/100
```

## 🔧 技术架构

### 核心技术栈

- **inquirer** - 交互式命令行界面
- **chalk** - 彩色终端输出
- **consola** - 美观的日志系统
- **commander** - 命令行参数解析
- **table** - 表格格式化

### 文件结构

```
db/
├── scripts/
│   ├── utils.mjs      # 共享工具函数
│   ├── cli.mjs        # 主CLI界面
│   └── status.mjs     # 状态检查脚本
└── README.md          # 详细文档
```

### 设计原则

- **用户体验优先** - 直观、美观、易用
- **安全第一** - 危险操作需确认
- **模块化** - 功能独立、易于扩展
- **错误友好** - 清晰的错误信息和修复建议

## 🆘 故障排除

### 常见问题

**Q: CLI 工具无法启动**

```bash
# 检查 Node.js 版本（需要 16+）
node --version

# 重新安装依赖
pnpm install

# 检查文件权限
chmod +x db/scripts/*.mjs
```

**Q: 交互界面显示异常**

```bash
# 检查终端支持
echo $TERM

# 使用命令行模式
pnpm db:cli --help
```

**Q: 数据库操作失败**

```bash
# 检查数据库状态
pnpm db:status

# 检查环境配置
cat .env | grep DATABASE_URL
```

### 获取支持

- 🔍 运行 `pnpm db:status` 获取诊断信息
- 📖 查看 `db/README.md` 了解详细功能
- 🆘 使用 `pnpm db:cli --help` 查看所有选项

## 🎉 总结

数据库 CLI 工具将原本复杂的 package.json 脚本整合为统一的交互式界面，大大提升了开发效率和用户体验。通过直观的菜单导航、安全的操作确认和详细的状态反馈，让数据库管理变得简单而高效。

主要优势：

- 🎯 **简化操作** - 一个命令替代十几个脚本
- 🛡️ **安全可靠** - 多重确认防止误操作
- 📊 **可视化** - 美观的表格和状态显示
- 🚀 **高效便捷** - 交互式选择，无需记忆复杂命令
- 🔧 **易于扩展** - 模块化设计，便于添加新功能
