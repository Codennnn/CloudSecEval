# Docker éƒ¨ç½²æŒ‡å—

æœ¬ç›®å½•åŒ…å«äº†é¡¹ç›®çš„ Docker éƒ¨ç½²ç›¸å…³æ–‡ä»¶å’Œè„šæœ¬ã€‚

## åŠŸèƒ½ç‰¹ç‚¹

- âœ… **è·¨å¹³å°å…¼å®¹** - åœ¨ Windowsã€macOSã€Linux ä¸Šè¡Œä¸ºä¸€è‡´
- ğŸ¨ **å½©è‰²è¾“å‡º** - ä½¿ç”¨ chalk åº“æä¾›ç¾è§‚çš„å½©è‰²è¾“å‡º
- ğŸ¤ **ç”¨æˆ·äº¤äº’** - æ”¯æŒç¡®è®¤æç¤ºã€è¾“å…¥éªŒè¯ç­‰äº¤äº’åŠŸèƒ½
- ğŸ”§ **æ›´å¥½çš„é”™è¯¯å¤„ç†** - ç»“æ„åŒ–çš„å¼‚å¸¸å¤„ç†å’Œè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- ğŸ“¦ **æ¨¡å—åŒ–è®¾è®¡** - å…±ç”¨å·¥å…·å‡½æ•°ï¼Œä»£ç å¤ç”¨æ€§é«˜
- ğŸš€ **å¼‚æ­¥æ”¯æŒ** - åŸç”Ÿæ”¯æŒ Promise/async-await

## æ–‡ä»¶è¯´æ˜

### ç›®å½•ç»“æ„

```
docker/
â”œâ”€â”€ README.md                 # ä½¿ç”¨è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ Dockerfile               # Docker é•œåƒæ„å»ºæ–‡ä»¶
â”œâ”€â”€ docker-compose.yml       # å¼€å‘ç¯å¢ƒ Docker Compose é…ç½®
â”œâ”€â”€ docker-compose.prod.yml  # ç”Ÿäº§ç¯å¢ƒ Docker Compose é…ç½®
â””â”€â”€ scripts/                 # ç®¡ç†è„šæœ¬ç›®å½•
    â”œâ”€â”€ utils.mjs            # å·¥å…·å‡½æ•°
    â”œâ”€â”€ build.mjs            # æ„å»ºè„šæœ¬
    â”œâ”€â”€ publish.mjs          # å‘å¸ƒè„šæœ¬
    â”œâ”€â”€ start.mjs            # å¯åŠ¨è„šæœ¬
    â”œâ”€â”€ stop.mjs             # åœæ­¢è„šæœ¬
    â”œâ”€â”€ status.mjs           # çŠ¶æ€æŸ¥çœ‹
    â”œâ”€â”€ logs.mjs             # æ—¥å¿—æŸ¥çœ‹
    â”œâ”€â”€ install.mjs          # ç¯å¢ƒæ£€æŸ¥
    â””â”€â”€ inspect-image.mjs    # é•œåƒæ£€æŸ¥
```

### é…ç½®æ–‡ä»¶

- `Dockerfile` - Docker é•œåƒæ„å»ºæ–‡ä»¶
- `docker-compose.yml` - å¼€å‘ç¯å¢ƒ Docker Compose é…ç½®
- `docker-compose.prod.yml` - ç”Ÿäº§ç¯å¢ƒ Docker Compose é…ç½®

### ç®¡ç†è„šæœ¬

ä½äº `scripts/` ç›®å½•ä¸‹çš„ç®¡ç†è„šæœ¬ï¼š

| è„šæœ¬                | åŠŸèƒ½     | è¯´æ˜                                   |
| ------------------- | -------- | -------------------------------------- |
| `start.mjs`         | å¯åŠ¨æœåŠ¡ | å¸¦å¥åº·æ£€æŸ¥çš„å¯åŠ¨è„šæœ¬                   |
| `stop.mjs`          | åœæ­¢æœåŠ¡ | åœæ­¢ Docker å®¹å™¨                       |
| `status.mjs`        | æŸ¥çœ‹çŠ¶æ€ | æ˜¾ç¤ºæœåŠ¡çŠ¶æ€å’Œé…ç½®ä¿¡æ¯                 |
| `logs.mjs`          | æŸ¥çœ‹æ—¥å¿— | å®æ—¶æŸ¥çœ‹åº”ç”¨æ—¥å¿—                       |
| `build.mjs`         | é•œåƒæ„å»º | ç‹¬ç«‹çš„æ„å»ºè„šæœ¬ï¼Œæ”¯æŒå¤šå¹³å°å’Œäº¤äº’å¼æ„å»º |
| `publish.mjs`       | é•œåƒå‘å¸ƒ | ä¸“æ³¨äºå‘å¸ƒå·²æ„å»ºçš„é•œåƒ                 |
| `install.mjs`       | ç¯å¢ƒæ£€æŸ¥ | æ£€æŸ¥ Docker ç¯å¢ƒå’Œä¾èµ–                 |
| `inspect-image.mjs` | é•œåƒæ£€æŸ¥ | æŸ¥çœ‹é•œåƒæ¶æ„å’Œè¯¦ç»†ä¿¡æ¯                 |
| `utils.mjs`         | å·¥å…·å‡½æ•° | å…±äº«çš„å·¥å…·å‡½æ•°å’Œå¸¸é‡å®šä¹‰               |

## å®‰è£…å’Œè®¾ç½®

### 1. å®‰è£…ä¾èµ–

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
pnpm install
```

### 2. æ£€æŸ¥ç¯å¢ƒ

```bash
# æ£€æŸ¥ Docker è„šæœ¬ç¯å¢ƒ
pnpm docker:install
```

## å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨å¼€å‘ç¯å¢ƒ

```bash
# ä½¿ç”¨ pnpm è„šæœ¬å¯åŠ¨ï¼ˆæ¨èï¼‰
pnpm docker:start

# æˆ–ç›´æ¥è¿è¡Œ Node.js è„šæœ¬
node docker/scripts/start.mjs

# æˆ–ç›´æ¥ä½¿ç”¨ Docker Compose
docker compose -f docker/docker-compose.yml up -d --build
```

### ğŸ—ï¸ æŒ‡å®šå¹³å°æ¶æ„æ„å»º

#### ä½¿ç”¨ Docker Compose

```bash
# é»˜è®¤æ„å»ºï¼ˆlinux/amd64ï¼‰
docker compose -f docker/docker-compose.yml up --build

# æŒ‡å®š ARM64 æ¶æ„ï¼ˆApple Siliconï¼‰
DOCKER_PLATFORM=linux/arm64 docker compose -f docker/docker-compose.yml up --build

# æŒ‡å®š ARM v7 æ¶æ„ï¼ˆæ ‘è“æ´¾ï¼‰
DOCKER_PLATFORM=linux/arm/v7 docker compose -f docker/docker-compose.yml up --build
```

#### æ”¯æŒçš„å¹³å°æ¶æ„

| å¹³å°           | è¯´æ˜                | é€‚ç”¨åœºæ™¯                  |
| -------------- | ------------------- | ------------------------- |
| `linux/amd64`  | x86_64 æ¶æ„ï¼ˆé»˜è®¤ï¼‰ | æ ‡å‡†æœåŠ¡å™¨ã€äº‘å¹³å°        |
| `linux/arm64`  | ARM64 æ¶æ„          | Apple Siliconã€ARM æœåŠ¡å™¨ |
| `linux/arm/v7` | ARM v7 æ¶æ„         | æ ‘è“æ´¾ã€åµŒå…¥å¼è®¾å¤‡        |

#### ç¯å¢ƒå˜é‡æ–¹å¼

```bash
# åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®
echo "DOCKER_PLATFORM=linux/arm64" >> .env

# ä¸´æ—¶è®¾ç½®
export DOCKER_PLATFORM=linux/arm64
docker compose -f docker/docker-compose.yml up --build
```

### ğŸ” æŸ¥çœ‹é•œåƒæ¶æ„

æ„å»ºå®Œæˆåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æŸ¥çœ‹é•œåƒçš„æ¶æ„ä¿¡æ¯ï¼š

#### ä½¿ç”¨ä¸“ç”¨è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# æŸ¥çœ‹æŒ‡å®šé•œåƒçš„è¯¦ç»†æ¶æ„ä¿¡æ¯
pnpm docker:inspect <é•œåƒåç§°>
pnpm docker:inspect docker-app:latest

# åˆ—å‡ºæ‰€æœ‰é•œåƒåŠå…¶æ¶æ„
pnpm docker:inspect --list

# æˆ–ç›´æ¥ä½¿ç”¨è„šæœ¬
node docker/scripts/inspect-image.mjs docker-app:latest
node docker/scripts/inspect-image.mjs --list
```

#### ä½¿ç”¨ Docker å‘½ä»¤

```bash
# æŸ¥çœ‹é•œåƒæ¶æ„
docker inspect <é•œåƒåç§°> --format='{{.Architecture}}'

# æŸ¥çœ‹å¹³å°ä¿¡æ¯
docker inspect <é•œåƒåç§°> --format='{{.Os}}/{{.Architecture}}'

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
docker inspect <é•œåƒåç§°> | jq -r '.[0] | {Os, Architecture, Size, Created}'
```

### 2. æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹è¯¦ç»†çŠ¶æ€
pnpm docker:status

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
pnpm docker:logs
```

### 3. åœæ­¢æœåŠ¡

```bash
pnpm docker:stop
```

## é•œåƒæ„å»ºå’Œå‘å¸ƒ

### ğŸ—ï¸ é•œåƒæ„å»º

é¡¹ç›®æä¾›äº†åŠŸèƒ½å®Œæ•´çš„é•œåƒæ„å»ºè„šæœ¬ï¼Œæ”¯æŒå¤šå¹³å°æ„å»ºå’Œäº¤äº’å¼æ“ä½œã€‚

#### ğŸ¯ æ„å»ºè„šæœ¬ç‰¹æ€§

- **äº¤äº’å¼æ„å»º** - å¼•å¯¼å¼æ„å»ºæµç¨‹ï¼Œé€‚åˆæ–°æ‰‹
- **å¤šå¹³å°æ”¯æŒ** - æ”¯æŒ AMD64ã€ARM64 ç­‰å¤šç§æ¶æ„
- **çµæ´»æ ‡ç­¾** - æ”¯æŒæœ¬åœ°ã€å¸¦æ ‡ç­¾ã€å¤šæ ‡ç­¾æ„å»º
- **Docker Buildx** - è‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨ Buildx è¿›è¡Œå¤šå¹³å°æ„å»º

#### ğŸ“‹ æ„å»ºå‘½ä»¤

```bash
# ä¸»èœå•é€‰æ‹©ï¼ˆæ¨èï¼‰
pnpm docker:build

# ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œé€‰é¡¹
node docker/scripts/build.mjs --local                # æœ¬åœ°æ„å»º
node docker/scripts/build.mjs --tagged -v 1.2.3     # å¸¦æ ‡ç­¾æ„å»º
node docker/scripts/build.mjs --tagged -v 1.2.3 -p linux/amd64,linux/arm64  # å¤šå¹³å°æ„å»º
node docker/scripts/build.mjs --list                 # æŸ¥çœ‹æœ¬åœ°é•œåƒ
node docker/scripts/build.mjs --cleanup              # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
```

#### ğŸ”§ æ„å»ºé€‰é¡¹

| é€‰é¡¹               | è¯´æ˜                 |
| ------------------ | -------------------- |
| `--local`          | æœ¬åœ°æ„å»ºæ¨¡å¼         |
| `--tagged`         | å¸¦æ ‡ç­¾æ„å»ºæ¨¡å¼       |
| `--multi`          | å¤šæ ‡ç­¾æ„å»ºæ¨¡å¼       |
| `-v, --version`    | æŒ‡å®šç‰ˆæœ¬å·           |
| `-t, --tag`        | æŒ‡å®šè‡ªå®šä¹‰æ ‡ç­¾       |
| `-l, --latest`     | åŒæ—¶æ„å»º latest æ ‡ç­¾ |
| `-p, --platform`   | æŒ‡å®šç›®æ ‡å¹³å°æ¶æ„     |
| `-f, --dockerfile` | æŒ‡å®š Dockerfile è·¯å¾„ |
| `--list`           | åˆ—å‡ºæœ¬åœ°é•œåƒ         |
| `--cleanup`        | æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ     |
| `--interactive`    | äº¤äº’å¼æ„å»º           |

### ğŸš€ é•œåƒå‘å¸ƒ

é¡¹ç›®æ”¯æŒå°†é•œåƒå‘å¸ƒåˆ° Docker Hubï¼ˆç”¨æˆ·åï¼šleokuchonï¼‰ã€‚

#### ğŸ¯ å‘å¸ƒè„šæœ¬

æ–°ç‰ˆæœ¬çš„å‘å¸ƒè„šæœ¬ä¸“æ³¨äºå‘å¸ƒå·²æ„å»ºçš„é•œåƒï¼Œæä¾›æ›´ç²¾ç¡®çš„æ§åˆ¶ï¼š

```bash
# ä¸»èœå•é€‰æ‹©ï¼ˆæ¨èï¼‰
pnpm docker:publish

# ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œé€‰é¡¹
node docker/scripts/publish.mjs --list                           # æŸ¥çœ‹å¯å‘å¸ƒçš„é•œåƒ
node docker/scripts/publish.mjs -i leokuchon/nest-api:1.2.3      # å‘å¸ƒæŒ‡å®šé•œåƒ
node docker/scripts/publish.mjs -i leokuchon/nest-api:1.2.3 -i leokuchon/nest-api:latest  # å‘å¸ƒå¤šä¸ªé•œåƒ
node docker/scripts/publish.mjs --quick -i leokuchon/nest-api:1.2.3     # å¿«é€Ÿå‘å¸ƒ
node docker/scripts/publish.mjs --full -i leokuchon/nest-api:1.2.3 -c   # å®Œæ•´å‘å¸ƒï¼ˆåŒ…å«ç¡®è®¤å’Œæ¸…ç†ï¼‰
node docker/scripts/publish.mjs --full -f -i leokuchon/nest-api:1.2.3   # å¼ºåˆ¶å‘å¸ƒï¼ˆè·³è¿‡ç¡®è®¤ï¼‰
```

#### ğŸ”§ å‘å¸ƒé€‰é¡¹

| é€‰é¡¹            | è¯´æ˜               |
| --------------- | ------------------ |
| `--quick`       | å¿«é€Ÿå‘å¸ƒæ¨¡å¼       |
| `--full`        | å®Œæ•´å‘å¸ƒæ¨¡å¼       |
| `-i, --image`   | æŒ‡å®šè¦å‘å¸ƒçš„é•œåƒ   |
| `-c, --cleanup` | å‘å¸ƒåæ¸…ç†æœ¬åœ°é•œåƒ |
| `-f, --force`   | è·³è¿‡ç¡®è®¤æç¤º       |
| `--list`        | åˆ—å‡ºå¯å‘å¸ƒçš„é•œåƒ   |
| `--interactive` | äº¤äº’å¼å‘å¸ƒ         |

#### ğŸš€ å¿«é€Ÿå‘å¸ƒ vs ğŸ”§ å®Œæ•´å‘å¸ƒ

**å¿«é€Ÿå‘å¸ƒæ¨¡å¼ï¼š**

- é€‚åˆå¼€å‘æµ‹è¯•é˜¶æ®µ
- æ— éœ€ç¡®è®¤ï¼Œå¿«é€Ÿæ‰§è¡Œ
- ç›´æ¥æ¨é€æŒ‡å®šé•œåƒ
- æ— é¢å¤–æ£€æŸ¥å’Œæ¸…ç†

**å®Œæ•´å‘å¸ƒæ¨¡å¼ï¼š**

- é€‚åˆç”Ÿäº§ç¯å¢ƒ
- åŒ…å«ç™»å½•æ£€æŸ¥å’Œç”¨æˆ·ç¡®è®¤
- å¯é€‰æ¸…ç†æœ¬åœ°é•œåƒ
- è¯¦ç»†çš„æ¨é€æ—¥å¿—å’Œé”™è¯¯å¤„ç†

### ğŸ”„ å®Œæ•´å·¥ä½œæµç¤ºä¾‹

#### ğŸ¯ å¼€å‘å·¥ä½œæµ

```bash
# 1. æœ¬åœ°æ„å»ºæµ‹è¯•
pnpm docker:build
# é€‰æ‹©: ğŸ—ï¸ æ„å»ºé•œåƒ
# é€‰æ‹©: ğŸ  æœ¬åœ°æ„å»º

# 2. æœ¬åœ°æµ‹è¯•
docker run -p 8000:8000 --env-file .env nest-api:local

# 3. æµ‹è¯•é€šè¿‡åæ„å»ºå¸¦æ ‡ç­¾çš„é•œåƒ
pnpm docker:build
# é€‰æ‹©: ğŸ—ï¸ æ„å»ºé•œåƒ
# é€‰æ‹©: ğŸ·ï¸ å¸¦æ ‡ç­¾æ„å»º

# 4. æŸ¥çœ‹æ„å»ºçš„é•œåƒ
pnpm docker:build
# é€‰æ‹©: ğŸ“‹ åˆ—å‡ºé•œåƒ

# 5. å‘å¸ƒåˆ° Docker Hub
pnpm docker:publish
# é€‰æ‹©: ğŸš€ å‘å¸ƒé•œåƒ

# 6. æ¸…ç†æœ¬åœ°é•œåƒ
pnpm docker:build
# é€‰æ‹©: ğŸ—‘ï¸ æ¸…ç†é•œåƒ
```

#### ğŸš€ ç”Ÿäº§å‘å¸ƒæµç¨‹

```bash
# 1. ä¸»èœå•æ„å»ºï¼ˆæ¨èï¼‰
pnpm docker:build
# é€‰æ‹©: ğŸ—ï¸ æ„å»ºé•œåƒ
# é€‰æ‹©: ğŸ·ï¸ å¸¦æ ‡ç­¾æ„å»º
# ç‰ˆæœ¬: 1.2.3
# å¹³å°: linux/amd64,linux/arm64
# latest: æ˜¯

# 2. ä¸»èœå•å‘å¸ƒï¼ˆæ¨èï¼‰
pnpm docker:publish
# é€‰æ‹©: ğŸš€ å‘å¸ƒé•œåƒ
# é€‰æ‹©è¦å‘å¸ƒçš„é•œåƒ
# é€‰æ‹©: ğŸ”§ å®Œæ•´å‘å¸ƒ
# æ¸…ç†: æ˜¯
```

#### âš¡ å¿«é€Ÿå‘å¸ƒæµç¨‹

```bash
# ä¸€é”®æ„å»ºå¹¶å‘å¸ƒ
pnpm docker:build --tagged -v 1.2.3 -l && pnpm docker:publish --quick -i leokuchon/nest-api:1.2.3 -i leokuchon/nest-api:latest
```

### ä½¿ç”¨å‘å¸ƒçš„é•œåƒ

#### å¼€å‘ç¯å¢ƒ

ä¿®æ”¹ `docker-compose.yml` æ–‡ä»¶ï¼š

```yaml
services:
  app:
    # æ³¨é‡Šæ‰ build éƒ¨åˆ†
    # build:
    #   context: ..
    #   dockerfile: docker/Dockerfile

    # å¯ç”¨ image éƒ¨åˆ†
    image: leokuchon/nest-api:latest
```

#### ç”Ÿäº§ç¯å¢ƒ

```bash
# ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒé…ç½®
docker compose -f docker/docker-compose.prod.yml up -d

# æˆ–ç›´æ¥è¿è¡Œé•œåƒ
docker run -d \
  --name nest-api \
  -p 8000:8000 \
  --env-file .env \
  leokuchon/nest-api:latest
```

## è¯¦ç»†åŠŸèƒ½è¯´æ˜

### ğŸš€ start.mjs - å¯åŠ¨æœåŠ¡

**æ–°åŠŸèƒ½** - æ”¯æŒé•œåƒé€‰æ‹©å’Œå¤šç§å¯åŠ¨æ–¹å¼ï¼

**ä¸»è¦åŠŸèƒ½**ï¼š

- **æ™ºèƒ½é•œåƒé€‰æ‹©** - è‡ªåŠ¨æ£€æµ‹æœ¬åœ°å¯ç”¨é•œåƒï¼Œæä¾›é€‰æ‹©ç•Œé¢
- **ä¸¤ç§å¯åŠ¨æ–¹å¼** - æ”¯æŒé•œåƒæ¨¡å¼å’Œæ„å»ºæ¨¡å¼
- **äº¤äº’å¼ç•Œé¢** - ç”¨æˆ·å‹å¥½çš„ä¸»èœå•é€‰æ‹©
- **å¥åº·æ£€æŸ¥** - ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨å¹¶éªŒè¯å¯ç”¨æ€§
- **è¯¦ç»†è¯Šæ–­** - å¯åŠ¨å¤±è´¥æ—¶æä¾›å®Œæ•´çš„æ•…éšœæ’é™¤ä¿¡æ¯

**å¯åŠ¨æ–¹å¼**ï¼š

1. **é•œåƒæ¨¡å¼** - ä½¿ç”¨ç°æœ‰é•œåƒç›´æ¥å¯åŠ¨å®¹å™¨
   - æ”¯æŒæœ¬åœ°æ„å»ºé•œåƒ (`nest-api:*`)
   - æ”¯æŒè¿œç¨‹é•œåƒ (`leokuchon/nest-api:*`)
   - è‡ªåŠ¨ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸ

2. **æ„å»ºæ¨¡å¼** - ä½¿ç”¨ Docker Compose æ„å»ºå¹¶å¯åŠ¨
   - ä»æºä»£ç æ„å»ºé•œåƒ
   - å®Œæ•´çš„æœåŠ¡ç¼–æ’
   - é€‚åˆå¼€å‘å’Œæµ‹è¯•

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```bash
# ä¸»èœå•é€‰æ‹©ï¼ˆæ¨èï¼‰
pnpm docker:start

# åˆ—å‡ºå¯ç”¨é•œåƒ
pnpm docker:start --list

# ä½¿ç”¨æŒ‡å®šé•œåƒå¯åŠ¨
pnpm docker:start -i leokuchon/nest-api:1.2.3

# ä½¿ç”¨æ„å»ºæ¨¡å¼å¯åŠ¨
pnpm docker:start --build
```

**ç‰¹ç‚¹**ï¼š

- è‡ªåŠ¨æ£€æµ‹ç«¯å£å·å’Œç¯å¢ƒé…ç½®
- å®æ—¶å¥åº·æ£€æŸ¥å’ŒçŠ¶æ€ç›‘æ§
- æ”¯æŒä¸¤ç§æ—¥å¿—æŸ¥çœ‹æ–¹å¼
- è¯¦ç»†çš„é”™è¯¯è¯Šæ–­ä¿¡æ¯
- å‘ä¸‹å…¼å®¹ç°æœ‰å·¥ä½œæµç¨‹

### ğŸ”´ stop.mjs - åœæ­¢æœåŠ¡

åŠŸèƒ½ï¼š

- åœæ­¢ Docker å®¹å™¨
- æ˜¾ç¤ºå½“å‰è¿è¡Œçš„å®¹å™¨
- æ£€æŸ¥æ˜¯å¦æœ‰ç›¸å…³å®¹å™¨ä»åœ¨è¿è¡Œ

### ğŸ“Š status.mjs - æŸ¥çœ‹çŠ¶æ€

åŠŸèƒ½ï¼š

- æ˜¾ç¤ºé…ç½®ä¿¡æ¯ï¼ˆç«¯å£ã€ç¯å¢ƒæ–‡ä»¶ï¼‰
- æ£€æŸ¥ Docker å®¹å™¨çŠ¶æ€
- æµ‹è¯•æœåŠ¡è¿æ¥
- æ˜¾ç¤º API å“åº”ä¿¡æ¯
- åˆ—å‡ºå¯ç”¨å‘½ä»¤

### ğŸ“ logs.mjs - æŸ¥çœ‹æ—¥å¿—

åŠŸèƒ½ï¼š

- å®æ—¶æŸ¥çœ‹åº”ç”¨æ—¥å¿—
- æ”¯æŒ Ctrl+C é€€å‡º
- æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€

### ğŸš¢ publish.mjs - å‘å¸ƒé•œåƒ

å®Œæ•´çš„é•œåƒå‘å¸ƒæµç¨‹ï¼ŒåŠŸèƒ½ï¼š

- è‡ªåŠ¨æ£€æŸ¥ Docker ç™»å½•çŠ¶æ€
- æ”¯æŒç‰ˆæœ¬å·è‡ªåŠ¨è·å–æˆ–æ‰‹åŠ¨æŒ‡å®š
- å¯é€‰æ¨é€ latest æ ‡ç­¾
- å¯é€‰æ¸…ç†æœ¬åœ°é•œåƒ
- ç”¨æˆ·ç¡®è®¤æç¤º
- è¯¦ç»†çš„æ„å»ºå’Œæ¨é€æ—¥å¿—

### ğŸ—ï¸ build.mjs - é•œåƒæ„å»ºè„šæœ¬

ä¸“æ³¨äºé•œåƒæ„å»ºçš„ç‹¬ç«‹è„šæœ¬ï¼Œç‰¹ç‚¹ï¼š

- **äº¤äº’å¼æ„å»º** - å¼•å¯¼å¼æ„å»ºæµç¨‹ï¼Œç”¨æˆ·å‹å¥½
- **å¤šå¹³å°æ”¯æŒ** - æ”¯æŒ AMD64ã€ARM64 ç­‰å¤šç§æ¶æ„
- **çµæ´»æ ‡ç­¾ç®¡ç†** - æ”¯æŒæœ¬åœ°ã€å¸¦æ ‡ç­¾ã€å¤šæ ‡ç­¾æ„å»º
- **Docker Buildx é›†æˆ** - è‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨ Buildx

### ğŸš€ publish.mjs - é•œåƒå‘å¸ƒè„šæœ¬

ä¸“æ³¨äºå‘å¸ƒå·²æ„å»ºé•œåƒçš„è„šæœ¬ï¼Œç‰¹ç‚¹ï¼š

- **é•œåƒé€‰æ‹©** - å¯ä»¥é€‰æ‹©æœ¬åœ°å·²æ„å»ºçš„é•œåƒè¿›è¡Œå‘å¸ƒ
- **æœ¬åœ°æ ‡ç­¾å¤„ç†** - è‡ªåŠ¨ä¸ºæœ¬åœ°é•œåƒåˆ›å»ºè¿œç¨‹æ ‡ç­¾
- **æ‰¹é‡å‘å¸ƒ** - æ”¯æŒä¸€æ¬¡å‘å¸ƒå¤šä¸ªé•œåƒ
- **ç²¾ç¡®æ§åˆ¶** - åªå‘å¸ƒæŒ‡å®šçš„é•œåƒï¼Œé¿å…è¯¯æ“ä½œ

## ç¯å¢ƒå˜é‡é…ç½®

ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# åº”ç”¨é…ç½®
PORT=8000
NODE_ENV=production

# æ•°æ®åº“é…ç½®
DATABASE_URL="prisma+postgres://accelerate.prisma-data.net/?api_key=your_api_key"

# JWT é…ç½®
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=1w

# ç®¡ç†å‘˜é…ç½®
ADMIN_EMAIL=admin@yourcompany.com
ADMIN_PASSWORD=your_secure_password
ADMIN_NAME=System Admin
```

## ä¾èµ–ç®¡ç†

### ç»Ÿä¸€ä¾èµ–ç®¡ç†

Docker è„šæœ¬ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•çš„ `package.json` æ¥ç®¡ç†ä¾èµ–ã€‚

### ä¼˜åŠ¿

- âœ… **ç»Ÿä¸€ç®¡ç†** - æ‰€æœ‰ä¾èµ–åœ¨æ ¹ç›®å½•ç»Ÿä¸€ç®¡ç†
- âœ… **é¿å…é‡å¤** - ä¸ä¼šæœ‰é‡å¤çš„ node_modules
- âœ… **ç‰ˆæœ¬ä¸€è‡´** - ç¡®ä¿æ•´ä¸ªé¡¹ç›®ä½¿ç”¨ç›¸åŒç‰ˆæœ¬çš„ä¾èµ–
- âœ… **ç®€åŒ–ç»´æŠ¤** - åªéœ€ç»´æŠ¤ä¸€ä¸ª package.json

### ä¾èµ–åŒ…è¯´æ˜

| åŒ…å        | ç”¨é€”                     |
| ----------- | ------------------------ |
| `chalk`     | å½©è‰²è¾“å‡º                 |
| `consola`   | ç°ä»£åŒ–çš„æ—¥å¿—è¾“å‡ºåº“       |
| `inquirer`  | ç”¨æˆ·äº¤äº’ï¼ˆç¡®è®¤ã€è¾“å…¥ç­‰ï¼‰ |
| `fetch`     | HTTP è¯·æ±‚ï¼ˆå¥åº·æ£€æŸ¥ï¼ŒåŸç”Ÿï¼‰ |
| `dotenv`    | ç¯å¢ƒå˜é‡å¤„ç†             |
| `commander` | å‘½ä»¤è¡Œå‚æ•°è§£æ           |

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å®¹å™¨å¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥ `.env` æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”é…ç½®æ­£ç¡®
   - æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š`pnpm docker:logs`

2. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   - éªŒè¯ `DATABASE_URL` æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥ç½‘ç»œè¿æ¥

3. **ç«¯å£å†²çª**
   - ä¿®æ”¹ `.env` æ–‡ä»¶ä¸­çš„ `PORT` å€¼
   - æˆ–ä¿®æ”¹ docker-compose.yml ä¸­çš„ç«¯å£æ˜ å°„

4. **é•œåƒå‘å¸ƒå¤±è´¥**
   - ç¡®ä¿å·²ç™»å½• Docker Hubï¼š`docker login`
   - æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œæƒé™

5. **Node.js ç‰ˆæœ¬è¿‡ä½**
   - é”™è¯¯ï¼šNode.js ç‰ˆæœ¬è¿‡ä½ï¼Œéœ€è¦ 18.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬
   - è§£å†³ï¼šå‡çº§ Node.js åˆ° 18.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬

6. **ä¾èµ–å®‰è£…å¤±è´¥**

   ```bash
   # æ¸…ç†å¹¶é‡æ–°å®‰è£…
   rm -rf node_modules package-lock.json
   pnpm install
   ```

### è°ƒè¯•å‘½ä»¤

```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker ps -a

# æŸ¥çœ‹é•œåƒåˆ—è¡¨
docker images

# è¿›å…¥å®¹å™¨è°ƒè¯•
docker exec -it nest_api /bin/bash

# æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯
docker inspect nest_api
```

## è‡ªåŠ¨åŒ–éƒ¨ç½²

é¡¹ç›®é…ç½®äº† GitHub Actions å·¥ä½œæµï¼Œå¯ä»¥è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒé•œåƒã€‚

### é…ç½®æ­¥éª¤

1. åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  Secretsï¼š
   - `DOCKER_USERNAME`: leokuchon
   - `DOCKER_PASSWORD`: Docker Hub å¯†ç æˆ–è®¿é—®ä»¤ç‰Œ

2. æ¨é€ä»£ç åˆ°ä¸»åˆ†æ”¯æˆ–åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾å³å¯è§¦å‘è‡ªåŠ¨å‘å¸ƒ

### è§¦å‘æ¡ä»¶

- æ¨é€åˆ° `main` æˆ– `master` åˆ†æ”¯
- åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ `v1.2.3`ï¼‰

## é•œåƒä¿¡æ¯

- **Docker Hub åœ°å€**: https://hub.docker.com/r/leokuchon/nest-api
- **ç”¨æˆ·å**: leokuchon
- **é•œåƒå**: nest-api

### å¯ç”¨æ ‡ç­¾

- `latest`: æœ€æ–°ç¨³å®šç‰ˆæœ¬
- `v1.2.3`: å…·ä½“ç‰ˆæœ¬å·
- `main`: ä¸»åˆ†æ”¯æœ€æ–°æ„å»º

## æ›´å¤šä¿¡æ¯

è¯¦ç»†çš„éƒ¨ç½²è¯´æ˜è¯·å‚è€ƒé¡¹ç›®æ ¹ç›®å½•çš„ `docs/å¼€å‘æŒ‡å—.md` æ–‡ä»¶ã€‚

## è·¯å¾„å¸¸é‡ä½¿ç”¨æŒ‡å—

### ğŸ“ ç»Ÿä¸€è·¯å¾„ç®¡ç†

ä¸ºäº†æ–¹ä¾¿ç»´æŠ¤å’Œä¿®æ”¹ï¼Œé¡¹ç›®ä¸­çš„ Docker Compose æ–‡ä»¶è·¯å¾„å·²ç»Ÿä¸€ä¸ºå¸¸é‡ç®¡ç†ã€‚

#### ğŸ”§ å¯ç”¨å¸¸é‡

åœ¨ `utils.mjs` ä¸­å®šä¹‰äº†ä»¥ä¸‹è·¯å¾„å¸¸é‡ï¼š

```javascript
// é¡¹ç›®æ ¹ç›®å½•è·¯å¾„
export const PROJECT_ROOT = join(__dirname, "..");

// Docker Compose æ–‡ä»¶è·¯å¾„å¸¸é‡
export const DOCKER_COMPOSE_FILE = "docker/docker-compose.yml";
export const DOCKER_COMPOSE_PROD_FILE = "docker/docker-compose.prod.yml";
```

#### ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹

**åœ¨è„šæœ¬ä¸­ä½¿ç”¨å¸¸é‡ï¼š**

```javascript
import {
  DOCKER_COMPOSE_FILE,
  DOCKER_COMPOSE_PROD_FILE,
  PROJECT_ROOT,
  dockerCompose,
} from "./utils.mjs";
import { join } from "path";

// ä½¿ç”¨å¼€å‘ç¯å¢ƒé…ç½®
await dockerCompose.up(DOCKER_COMPOSE_FILE, "--build -d");

// ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒé…ç½®
await dockerCompose.up(DOCKER_COMPOSE_PROD_FILE, "-d");

// ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•è·¯å¾„
const envFilePath = join(PROJECT_ROOT, ".env");
const packagePath = join(PROJECT_ROOT, "package.json");
```

**ä½¿ç”¨ä¾¿æ·å·¥å…·å‡½æ•°ï¼š**

```javascript
import { composeUtils } from "./utils.mjs";

// å¯åŠ¨å¼€å‘ç¯å¢ƒ
await composeUtils.startDev();

// å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
await composeUtils.startProd();

// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
const fileStatus = composeUtils.checkFiles();
console.log("å¼€å‘ç¯å¢ƒæ–‡ä»¶:", fileStatus.devFile);
console.log("ç”Ÿäº§ç¯å¢ƒæ–‡ä»¶:", fileStatus.prodFile);
```

#### âœ… ä¼˜åŠ¿

- **ç»Ÿä¸€ç®¡ç†** - æ‰€æœ‰è·¯å¾„åœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰ï¼Œä¾¿äºç»´æŠ¤
- **é¿å…é‡å¤** - å‡å°‘ç¡¬ç¼–ç è·¯å¾„çš„é‡å¤å‡ºç°
- **æ˜“äºä¿®æ”¹** - åªéœ€ä¿®æ”¹å¸¸é‡å®šä¹‰å³å¯æ›´æ–°æ‰€æœ‰å¼•ç”¨
- **ç±»å‹å®‰å…¨** - å‡å°‘è·¯å¾„æ‹¼å†™é”™è¯¯çš„å¯èƒ½æ€§

#### ğŸ”„ è¿ç§»è¯´æ˜

å¦‚æœæ‚¨éœ€è¦ä¿®æ”¹ Docker Compose æ–‡ä»¶çš„è·¯å¾„ï¼Œåªéœ€ï¼š

1. ä¿®æ”¹ `utils.mjs` ä¸­çš„å¸¸é‡å®šä¹‰
2. æ‰€æœ‰ä½¿ç”¨è¿™äº›å¸¸é‡çš„è„šæœ¬ä¼šè‡ªåŠ¨ä½¿ç”¨æ–°è·¯å¾„
3. æ‰‹åŠ¨æ›´æ–°æ–‡æ¡£ä¸­çš„ç¤ºä¾‹å‘½ä»¤ï¼ˆå¦‚æœéœ€è¦ï¼‰

**ç¤ºä¾‹ï¼š**

```javascript
// ä¿®æ”¹å‰
export const DOCKER_COMPOSE_FILE = "docker/docker-compose.yml";

// ä¿®æ”¹åï¼ˆå¦‚æœæ‚¨æƒ³å°†æ–‡ä»¶ç§»åŠ¨åˆ°å…¶ä»–ä½ç½®ï¼‰
export const DOCKER_COMPOSE_FILE = "compose/docker-compose.yml";
```

ä¿®æ”¹åï¼Œæ‰€æœ‰è„šæœ¬éƒ½ä¼šè‡ªåŠ¨ä½¿ç”¨æ–°çš„è·¯å¾„ã€‚
