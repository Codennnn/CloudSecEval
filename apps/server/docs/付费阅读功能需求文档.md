# 📄 任务规划文档：付费阅读功能（基于邮箱 + 授权码）

## 🎯 项目目标

实现一个轻量但安全的「付费内容访问控制后端服务」，用户无需注册登录账号，仅通过邮箱绑定授权码进行访问验证。具备防止授权码滥用与基本追踪能力。

---

## 🧩 功能模块划分

### 1. 授权数据模型设计（Prisma）

**任务目标**：
定义授权码数据结构，用于绑定邮箱、控制访问次数与监控风险行为。

**字段要求**：

- `email`（string）：用户邮箱
- `code`（string）：唯一授权码
- `verified`（boolean）：邮箱是否验证通过
- `usageCount`（int）：访问次数
- `lastIP`（string）：最近使用 IP
- `lastUA`（string）：最近使用设备指纹
- `locked`（boolean）：是否被封禁
- `createdAt`（datetime）：创建时间

---

### 2. 邮箱验证码发送接口（`/request-code`）

**任务目标**：
发送验证码到用户邮箱以验证邮箱真实性。

**功能说明**：

- 接收邮箱地址
- 生成 6 位验证码（数字）
- 将验证码临时存储（内存或 Redis）
- 调用邮件服务发送验证码
- 返回发送成功或错误信息

---

### 3. 邮箱验证与授权码生成接口（`/verify-email`）

**任务目标**：
验证邮箱验证码，并生成唯一授权码绑定该邮箱。

**功能说明**：

- 接收邮箱和验证码
- 对验证码进行校验
- 成功后生成授权码（如 `ABCD-EFGH-IJKL-MNOP-Q`）
- 将邮箱 + 授权码写入数据库
- 返回授权码供前端展示或记录

---

### 4. 授权校验接口（`/check-license`）

**任务目标**：
校验用户提交的邮箱 + 授权码是否匹配，并检测是否为异常设备或行为。

**功能说明**：

- 接收：邮箱、授权码、IP、User-Agent
- 检查是否匹配数据库中记录
- 检测是否为新设备/切换设备/被封禁
- 返回授权结果与状态标识（如 `isRiskyAccess`）

---

### 75. 访问日志记录接口（可选：`/log-access`）

**任务目标**：
记录用户成功访问页面后的使用日志，辅助风控分析。

**字段建议**：

- 邮箱
- 授权码
- 页面路径
- 访问时间
- IP + UA
- 是否为风险访问

---

## 🔒 防滥用机制（建议实现）

| 机制                 | 说明                                 |
| -------------------- | ------------------------------------ |
| 授权码绑定邮箱       | 授权码必须配合绑定邮箱使用，独立无效 |
| 首次使用绑定设备信息 | 记录首次使用的 IP 和 UA              |
| 多设备访问检测       | 若检测到频繁切换 IP/UA → 锁定授权码  |
| 使用次数限制         | 每日最多访问次数限制，防止批量抓取   |
| 邮箱验证流程         | 发送验证码，避免乱填邮箱获取授权码   |

---

## ✅ 验收标准

- [ ] 用户能通过邮箱成功领取授权码
- [ ] 用户访问页面时需通过邮箱 + 授权码验证
- [ ] 能检测并阻止授权码在多个设备上的异常使用
- [ ] 所有授权操作与访问行为均有记录可查

---

## 🧩 开发顺序建议

1. 创建 Prisma 模型
2. 实现验证码发送 + 邮箱验证 + 授权码生成
3. 实现授权校验接口
4. 开发前端验证表单组件
5. 接入 SSR 页面保护逻辑
6. 实现访问日志记录（可选）
