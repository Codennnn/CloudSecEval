# 付费阅读服务开发指南

## 项目概述

### 项目介绍

本项目是一个基于 NestJS 框架开发的付费阅读服务后端 API，专注于提供用户管理、JWT 认证和授权码访问控制功能。项目采用 TypeScript 开发，使用 PostgreSQL 数据库和 Prisma ORM，为付费内容提供安全可靠的访问控制机制。

### 技术栈

- **后端框架**：NestJS 11.x（基于 Node.js 的企业级框架）
- **编程语言**：TypeScript 5.x
- **数据库**：PostgreSQL + Prisma ORM
- **构建工具**：SWC（加速 TypeScript 编译）
- **包管理器**：pnpm
- **认证**：基于 JWT（JSON Web Token）
- **授权控制**：自定义授权码机制
- **API 文档**：Swagger/OpenAPI

## 开发环境准备

### 必要软件

- **Node.js**：20.x 或更高版本
- **pnpm**：9.x 或更高版本
- **Git**：最新版
- **IDE**：推荐使用 VSCode、WebStorm 或 Cursor
- **Docker**：用于本地开发环境的 PostgreSQL 数据库

### 推荐扩展（VSCode）

- Prisma：提供 schema 语法高亮和自动完成
- ESLint：代码规范检查
- Prettier：代码格式化
- NestJS Snippets：快速生成代码片段

## 项目结构

项目结构是 SaaS 平台 API 的骨架，详细的目录结构和功能说明已经单独整理到[项目结构说明](./项目结构说明.md)文档中，请参考该文档了解完整的项目架构。

## 首次开发设置

### 克隆项目并安装依赖

```bash
# 克隆项目
git clone [项目仓库URL]
cd [项目目录]

# 安装依赖
pnpm install
```

### 配置环境变量

项目已包含开发环境配置文件 `.env.development`，包含所有必要的配置：

```bash
# 应用配置
NODE_ENV=development
PORT=8007

# 数据库配置
DATABASE_URL=postgresql://postgres:dev_password@localhost:5433/nest_api_dev?schema=public

# JWT 配置
JWT_SECRET=your-jwt-secret-key
JWT_EXPIRES_IN=1w

# 管理员账号
ADMIN_EMAIL=admin@example.com
ADMIN_PASSWORD=admin123
ADMIN_NAME=Admin
```

> **注意**：生产环境需要创建独立的 `.env` 文件，并修改相应的敏感信息。

### 启动数据库和初始化

项目使用 Docker 提供本地开发数据库：

```bash
# 启动 PostgreSQL 数据库
pnpm db:dev:up

# 初始化数据库（格式化 schema、生成客户端、推送到数据库）
pnpm db:init

# 或使用一键命令（启动数据库并初始化）
pnpm dev:db
```

## 开发工作流

### 启动开发服务器

```bash
# 自动生成 Prisma 客户端并启动开发服务器
pnpm dev

# 或者仅启动开发服务器（如果已生成 Prisma 客户端）
pnpm start:dev
```

服务器默认运行在 `http://localhost:8007`，API 文档可在 `http://localhost:8007/docs` 访问。

### 数据库操作

```bash
# 查看/编辑数据库内容（Prisma Studio）
pnpm studio

# 更新数据模型后同步数据库（开发环境）
pnpm prisma:push

# 创建迁移（生产环境）
pnpm prisma:dev
```

更多 Prisma 相关命令和详细说明请参考 [Prisma 命令指南](./Prisma命令指南.md)。

### 使用数据库种子脚本

系统提供了种子脚本功能，用于初始化必要的基础数据，如初始管理员账号：

```bash
# 运行所有种子脚本
pnpm db:seed

# 只创建管理员账号
pnpm db:seed:admin

# 数据库初始化并填充基础数据
pnpm db:init && pnpm db:seed
```

详细说明和自定义方法请参考 [数据库种子脚本使用指南](./数据库种子脚本使用指南.md)。

### 代码规范检查和格式化

```bash
# 运行 ESLint 检查代码
pnpm lint

# 格式化代码
pnpm format
```

## 项目架构详解

### 模块结构

项目遵循 NestJS 的模块化架构，主要模块包括：

- **AppModule**：应用程序的根模块
- **AuthModule**：用户认证和授权
- **UsersModule**：用户管理相关功能
- **LicenseModule**：授权码管理
- **MailModule**：邮件发送服务（基于 Resend）
- **StatisticsModule**：数据统计和分析
- **PrismaModule**：提供数据库访问服务（全局）
- **CommonModule**：通用功能（守卫、拦截器、工具等）

### 数据库模型

主要数据模型包括：

- **User**：用户实体
- **Organization**：组织/团队实体
- **UserOrganization**：用户-组织关联（多对多）

详细的数据结构请参考 `prisma/schema.prisma` 文件或 [数据模型设计](./数据模型设计.md) 文档。

### 依赖注入与服务

NestJS 使用依赖注入模式。重要服务包括：

- **PrismaService**：负责数据库连接和操作
- **UsersService**：处理用户相关业务逻辑
- **OrganizationsService**：处理组织相关业务逻辑

## 开发指南

### 创建新模块

```bash
# 使用 NestJS CLI 创建新模块
npx nest generate module <模块名>

# 创建控制器
npx nest generate controller <模块名>

# 创建服务
npx nest generate service <模块名>
```

### Mail 模块开发

#### 邮件服务集成

Mail 模块基于 Resend 服务，提供以下功能：

- 授权码发送邮件
- 安全警告邮件
- 账户锁定通知
- 过期提醒邮件

#### 使用示例

```typescript
// 在服务中注入 MailService
constructor(private readonly mailService: MailService) {}

// 发送授权码邮件
await this.mailService.sendLicenseCode({
  to: 'user@example.com',
  licenseCode: 'ABCD-EFGH-IJKL',
  expiresAt: new Date()
});

// 发送安全警告
await this.mailService.sendSecurityWarning({
  to: 'user@example.com',
  suspiciousActivity: '异常登录检测',
  timestamp: new Date()
});
```

### Statistics 模块开发

#### 统计功能概述

Statistics 模块提供全面的数据分析功能：

- 用户统计（注册、活跃度、地理分布）
- 授权码统计（使用情况、趋势分析）
- 收入统计和财务分析
- 访问统计和性能监控
- 风险分析和安全监控

#### 开发新统计功能

1. 在 `StatisticsService` 中添加业务逻辑
2. 在 `StatisticsRepository` 中实现数据查询
3. 在 `StatisticsController` 中添加 API 接口
4. 更新相应的 DTO 定义

```typescript
// 示例：添加新的统计方法
@Get('custom-metric')
@ApiOperation({ summary: '获取自定义指标' })
async getCustomMetric(@Query() query: StatisticsQueryDto) {
  return this.statisticsService.getCustomMetric(query);
}
```

### 添加新的数据模型

1. 在 `prisma/schema.prisma` 中定义新模型
2. 运行 `pnpm prisma:generate` 生成 Prisma 客户端
3. 运行 `pnpm prisma:push` 更新数据库结构

### 编写测试

```bash
# 运行单元测试
pnpm test

# 运行端到端测试
pnpm test:e2e

# 以监视模式运行测试
pnpm test:watch
```

## 部署流程

### 生产环境构建

```bash
# 构建应用
pnpm build

# 启动生产服务
pnpm start:prod
```

### 数据库迁移

```bash
# 部署迁移
pnpm prisma:deploy
```

### Docker 部署

项目提供了完整的 Docker 部署方案，支持单容器部署和 Docker Compose 编排部署两种方式。

#### 方式一：使用 Docker Compose（推荐）

项目已配置使用 Prisma Accelerate 云数据库，无需本地数据库服务。

**1. 使用便捷脚本（推荐）**

```bash
# 启动服务（自动构建镜像）
./docker/start.sh

# 查看实时日志
./docker/logs.sh

# 停止服务
./docker/stop.sh
```

**2. 直接使用 Docker Compose**

```bash
# 构建并启动服务
docker compose -f docker/docker-compose.yml up -d --build

# 查看服务状态
docker compose -f docker/docker-compose.yml ps

# 查看应用日志
docker compose -f docker/docker-compose.yml logs -f app

# 停止服务
docker compose -f docker/docker-compose.yml down
```

#### 方式二：单独构建 Docker 镜像

如果您需要更灵活的部署方式，可以单独构建应用镜像。

**1. 构建镜像**

```bash
# 在项目根目录执行
docker build -f docker/Dockerfile -t nest-api:latest .
```

**2. 运行容器**

```bash
# 使用 .env 文件运行（推荐）
docker run -d \
  --name nest-api \
  -p 8000:8000 \
  --env-file .env \
  nest-api:latest

# 或者直接指定环境变量
docker run -d \
  --name nest-api \
  -p 8000:8000 \
  -e DATABASE_URL="your_database_url" \
  -e JWT_SECRET="your_jwt_secret" \
  -e NODE_ENV="production" \
  nest-api:latest
```

#### 环境变量配置

Docker 部署时可以通过环境变量配置应用：

**核心配置**

- `DATABASE_URL`：Prisma Accelerate 数据库连接字符串
- `JWT_SECRET`：JWT 密钥
- `JWT_EXPIRES_IN`：JWT 过期时间
- `NODE_ENV`：运行环境（production/development）

**应用配置**

- `PORT`：应用端口（默认 8000）
- `ADMIN_EMAIL`：初始管理员邮箱
- `ADMIN_PASSWORD`：初始管理员密码
- `ADMIN_NAME`：初始管理员姓名

**示例 .env 文件**

```env
# 应用配置
PORT=8000
NODE_ENV=production

# 数据库配置（Prisma Accelerate）
DATABASE_URL="prisma+postgres://accelerate.prisma-data.net/?api_key=your_api_key"

# JWT 配置
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=1w

# 初始管理员配置
ADMIN_EMAIL=admin@yourcompany.com
ADMIN_PASSWORD=your_secure_password
ADMIN_NAME=System Admin
```

#### 部署注意事项

**1. 数据库配置**

- 使用 Prisma Accelerate 云数据库，无需本地数据库服务
- 确保 API 密钥有效且网络连接正常

**2. 安全配置**

- 使用强密码的管理员账号
- 保护好 JWT 密钥和数据库 API 密钥
- 考虑使用 Docker secrets 管理敏感信息

**3. 网络配置**

- 默认应用运行在 8000 端口
- 可以通过修改 `docker-compose.yml` 中的端口映射来更改外部访问端口

**4. 便捷脚本**

- `docker/start.sh`：一键启动服务
- `docker/stop.sh`：停止服务
- `docker/logs.sh`：查看日志
- `docker/README.md`：详细使用说明

#### 生产环境优化建议

**1. 环境变量管理**

- 使用 `.env` 文件或环境变量管理工具
- 避免在 docker-compose.yml 中硬编码敏感信息

**2. 反向代理**

- 使用 Nginx 或 Traefik 作为反向代理
- 配置 SSL 证书和域名

**3. 监控和日志**

- 配置日志收集（如 ELK Stack）
- 设置应用监控（如 Prometheus + Grafana）

**4. 备份策略**

- 定期备份 Prisma Accelerate 数据库
- 配置自动备份脚本

### Docker 镜像发布

项目支持将 Docker 镜像发布到 Docker Hub，便于在不同环境中部署。

#### 手动发布

**1. 使用发布脚本（推荐）**

```bash
# 完整发布流程（带参数选项）
./docker/publish.sh

# 发布当前版本并打 latest 标签
./docker/publish.sh -l

# 发布指定版本
./docker/publish.sh -v 1.2.3

# 发布后清理本地镜像
./docker/publish.sh -l -c

# 查看帮助
./docker/publish.sh -h
```

**2. 快速发布**

```bash
# 使用快速发布脚本
./docker/quick-publish.sh

# 发布指定版本
./docker/quick-publish.sh 1.2.3
```

#### 自动发布（GitHub Actions）

项目配置了 GitHub Actions 工作流，在以下情况下自动构建和发布镜像：

- 推送到 `main` 或 `master` 分支
- 创建版本标签（如 `v1.2.3`）

**配置步骤**：

1. 在 GitHub 仓库的 Settings → Secrets and variables → Actions 中添加：
   - `DOCKER_USERNAME`：Docker Hub 用户名
   - `DOCKER_PASSWORD`：Docker Hub 密码或访问令牌

2. 推送代码到主分支或创建版本标签即可触发自动发布

#### 使用发布的镜像

**开发环境**：

```bash
# 修改 docker-compose.yml，注释掉 build 部分，启用 image 部分
docker compose -f docker/docker-compose.yml up -d
```

**生产环境**：

```bash
# 使用生产环境配置
docker compose -f docker/docker-compose.prod.yml up -d

# 或直接拉取镜像运行
docker pull leokuchon/nest-api:latest
docker run -d --name nest-api -p 8000:8000 --env-file .env leokuchon/nest-api:latest
```

#### 镜像版本管理

- `latest`：最新的稳定版本
- `v1.2.3`：具体的版本号
- `main`：主分支的最新构建

**Docker Hub 地址**：https://hub.docker.com/r/leokuchon/nest-api

## 常见问题与解决方案

### Prisma 客户端生成失败

**问题**：Prisma 客户端生成时出现错误。

**解决方案**：

1. 检查 `.env` 文件中的 `DATABASE_URL` 是否正确
2. 确保 `prisma/schema.prisma` 文件语法正确
3. 尝试运行 `npx prisma generate --debug` 查看详细错误

### 数据库连接问题

**问题**：应用启动时报告数据库连接错误。

**解决方案**：

1. 验证 Prisma Accelerate API 密钥是否有效
2. 检查网络连接
3. 查看 Prisma 日志获取详细信息

## 相关资源与文档

- [NestJS 官方文档](https://docs.nestjs.com/)
- [Prisma 文档](https://www.prisma.io/docs/)
- [TypeScript 文档](https://www.typescriptlang.org/docs/)
- [PostgreSQL 文档](https://www.postgresql.org/docs/)
