# 环境变量配置指南

## 概述

本项目使用 NestJS 的 `@nestjs/config` 模块来管理环境变量，支持多环境配置、类型安全和验证。

## 环境变量文件优先级

系统会按以下优先级加载环境变量文件：

1. `.env.local` (最高优先级，本地开发专用)
2. `.env.${NODE_ENV}` (环境特定配置)
3. `.env` (默认配置)

## 环境变量配置示例

### 基础配置

```bash
# 应用配置
NODE_ENV=development
PORT=8000

# CORS 配置
CORS_ORIGIN=http://localhost:3000,http://localhost:5173,https://yourdomain.com
CORS_CREDENTIALS=true
```

### 数据库配置

```bash
# 数据库配置 (Prisma Accelerate)
DATABASE_URL="prisma+postgres://accelerate.prisma-data.net/?api_key=your_api_key"

# 传统数据库配置 (可选，用于非 Prisma Accelerate 环境)
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_USERNAME=your_username
DATABASE_PASSWORD=your_password
DATABASE_NAME=your_database
DATABASE_SSL=false
```

### JWT 配置

```bash
# JWT 配置
JWT_SECRET=your_jwt_secret_key_here
JWT_EXPIRES_IN=1w
JWT_REFRESH_SECRET=your_refresh_secret_key_here
JWT_REFRESH_EXPIRES_IN=7d
```

### 管理员配置

```bash
# 管理员配置
ADMIN_EMAIL=admin@example.com
ADMIN_PASSWORD=Admin@123
ADMIN_NAME=系统管理员
```

### Redis 配置

```bash
# Redis 配置 (可选)
REDIS_HOST=localhost
REDIS_PORT=6379
```

### 邮件配置

#### Resend 邮件服务（推荐）

```env
# Resend 邮件服务配置
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxxxxxxx
RESEND_FROM_EMAIL=noreply@yourdomain.com
RESEND_FROM_NAME=Your App Name
```

#### 传统 SMTP 配置（备选）

```env
# 邮件服务配置
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USER=your-email@gmail.com
MAIL_PASS=your-app-password
MAIL_FROM=noreply@yourapp.com
```

### 第三方服务配置

```bash
# AWS 配置 (可选)
AWS_ACCESS_KEY_ID=your_aws_access_key
AWS_SECRET_ACCESS_KEY=your_aws_secret_key
AWS_REGION=us-east-1
AWS_S3_BUCKET=your-bucket-name
```

## 配置验证

项目使用 Zod 进行环境变量验证，确保所有必需的配置项都存在且格式正确。

### 验证规则

- `NODE_ENV`: 必须是 `development`、`production` 或 `test`
- `PORT`: 必须是数字，默认 8000
- `DATABASE_URL`: 必需，数据库连接字符串
- `JWT_SECRET`: 必需，JWT 密钥
- `ADMIN_EMAIL`: 必需，管理员邮箱格式
- `ADMIN_PASSWORD`: 必需，最少 6 位字符

### 验证失败处理

如果环境变量验证失败，应用将无法启动，并显示详细的错误信息。

## 配置命名空间

项目使用配置命名空间来组织不同类型的配置：

### 数据库配置 (`database`)

```typescript
export const databaseConfig = registerAs('database', () => ({
  url: process.env.DATABASE_URL,
  host: process.env.DB_HOST,
  port: parseInt(process.env.DB_PORT, 10) || 5432,
  username: process.env.DB_USERNAME,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  ssl: process.env.DATABASE_SSL === 'true',
}));
```

### JWT 配置 (`jwt`)

```typescript
export const jwtConfig = registerAs('jwt', () => ({
  secret: process.env.JWT_SECRET,
  expiresIn: process.env.JWT_EXPIRES_IN || '1w',
  refreshSecret: process.env.JWT_REFRESH_SECRET,
  refreshExpiresIn: process.env.JWT_REFRESH_EXPIRES_IN || '7d',
}));
```

### 邮件配置 (`mail`)

```typescript
export const mailConfig = registerAs('mail', () => ({
  resend: {
    apiKey: process.env.RESEND_API_KEY,
    fromEmail: process.env.RESEND_FROM_EMAIL,
    fromName: process.env.RESEND_FROM_NAME,
  },
  smtp: {
    host: process.env.MAIL_HOST,
    port: parseInt(process.env.MAIL_PORT, 10) || 587,
    user: process.env.MAIL_USER,
    pass: process.env.MAIL_PASS,
    from: process.env.MAIL_FROM,
  },
}));
```

### 应用配置 (`app`)

```typescript
export const appConfig = registerAs('app', () => ({
  port: parseInt(process.env.PORT, 10) || 8000,
  env: process.env.NODE_ENV || 'development',
  adminEmail: process.env.ADMIN_EMAIL,
  adminPassword: process.env.ADMIN_PASSWORD,
  adminName: process.env.ADMIN_NAME,
  upload: {
    maxSize: 10 * 1024 * 1024, // 10MB
    allowedTypes: ['image/jpeg', 'image/png', 'image/gif'],
  },
  redis: {
    host: process.env.REDIS_HOST || 'localhost',
    port: parseInt(process.env.REDIS_PORT, 10) || 6379,
  },
}));
```

## 在代码中使用配置

### 使用 ConfigService

```typescript
import { ConfigService } from "@nestjs/config";
import { Injectable } from "@nestjs/common";

@Injectable()
export class SomeService {
  constructor(private configService: ConfigService) {}

  getDbConfig() {
    return this.configService.get("database");
  }
}
```

### 使用命名空间配置

```typescript
import { Inject, Injectable } from "@nestjs/common";
import { ConfigType } from "@nestjs/config";
import { jwtConfig } from "~/config";

@Injectable()
export class AuthService {
  constructor(
    @Inject(jwtConfig.KEY)
    private jwtConf: ConfigType<typeof jwtConfig>
  ) {}

  getSecret() {
    return this.jwtConf.secret;
  }
}
```

## 安全最佳实践

1. **不要提交 .env 文件**：确保 .env 文件在 .gitignore 中
2. **使用强密钥**：JWT 密钥应该足够复杂和随机
3. **环境隔离**：不同环境使用不同的密钥和配置
4. **定期轮换**：定期更换密钥和密码
5. **最小权限原则**：数据库用户只给必要权限

## 故障排除

### 常见错误

1. **配置验证失败**：检查环境变量是否符合验证规则
2. **配置文件未找到**：确保 .env 文件存在且路径正确
3. **数据库连接失败**：检查 DATABASE_URL 是否正确
4. **JWT 验证失败**：确保 JWT_SECRET 在所有实例中一致

### 调试技巧

1. 启用开发环境日志查看配置加载过程
2. 使用 `console.log` 输出配置值进行调试
3. 检查环境变量是否正确设置：`process.env.VARIABLE_NAME`

## 部署注意事项

### Docker 部署

在 Docker 环境中，可以通过以下方式设置环境变量：

1. 使用 `.env` 文件：`--env-file .env`
2. 直接设置：`-e NODE_ENV=production`
3. 在 docker-compose.yml 中配置

### 云平台部署

不同云平台有不同的环境变量设置方式：

- **Heroku**: 使用 Config Vars
- **AWS**: 使用 Systems Manager Parameter Store 或 Secrets Manager
- **Google Cloud**: 使用 Secret Manager
- **Azure**: 使用 Key Vault

## 扩展配置

如需添加新的配置项：

1. 在 `validation.schema.ts` 中添加 Zod 验证规则
2. 在相应的配置文件中添加配置项
3. 更新类型定义
4. 在需要的地方注入使用

## 参考链接

- [NestJS Configuration](https://docs.nestjs.com/techniques/configuration)
- [Zod Validation](https://zod.dev/)
- [dotenv Documentation](https://github.com/motdotla/dotenv)
