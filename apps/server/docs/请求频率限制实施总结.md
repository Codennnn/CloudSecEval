# 请求频率限制实施总结

## 📋 实施概览

本次为 NestJS API Server 成功引入了基于 `@nestjs/throttler` 的请求频率限制功能，采用内存存储方式，支持基于用户 ID 和 IP 地址的差异化限流策略。

## 🎯 已完成的功能

### 1. 基础设施

#### 1.1 依赖安装

- ✅ 安装了 `@nestjs/throttler@6.4.0`

#### 1.2 共享常量

- ✅ 创建 `packages/constants/src/throttler.ts`
  - 定义时间窗口常量（1分钟、5分钟、15分钟、1小时）
  - 定义各业务场景的限流配置
  - 导出到 `@mono/constants` 包供全局使用

#### 1.3 配置系统

- ✅ 创建 `throttler.config.ts` 配置文件
- ✅ 更新 `config.module.ts` 加载配置
- ✅ 更新 `config.service.ts` 添加 throttler getter
- ✅ 更新 `validation.schema.ts` 添加环境变量验证
- ✅ 更新 `types.ts` 添加 ThrottlerConfig 类型

### 2. 核心功能模块

#### 2.1 Throttler 模块

**位置**: `src/modules/throttler/`

**结构**:

```
throttler/
├── decorators/
│   ├── skip-throttle.decorator.ts    # 跳过限流装饰器
│   └── custom-throttle.decorator.ts  # 自定义限流装饰器
├── guards/
│   └── custom-throttler.guard.ts     # 自定义守卫
├── filters/
│   └── throttler-exception.filter.ts # 异常过滤器
└── throttler.module.ts                # 模块定义
```

#### 2.2 自定义守卫 (`CustomThrottlerGuard`)

**功能**:

- 支持基于用户 ID 的限流（已认证用户）
- 支持基于 IP 地址的限流（未认证用户）
- 自动识别代理环境下的真实 IP（支持 `X-Forwarded-For` 和 `X-Real-IP` 头）

**限流键生成策略**:

- 已认证: `user-{userId}`
- 未认证: `ip-{ipAddress}`

#### 2.3 异常过滤器 (`ThrottlerExceptionFilter`)

**功能**:

- 捕获 `ThrottlerException` 异常
- 返回统一的业务错误响应格式
- 提供友好的错误信息和重置时间

**响应格式**:

```json
{
  "code": 429,
  "message": "请求过于频繁，请稍后再试",
  "businessCode": 20500,
  "timestamp": "2025-09-30T12:00:00.000Z",
  "path": "/api/auth/login",
  "extraData": {
    "resetAt": "2025-09-30T12:01:00.000Z"
  }
}
```

### 3. 业务集成

#### 3.1 全局守卫注册

在 `app.module.ts` 中注册，守卫执行顺序：

1. `DisabledApiGuard` - 检查接口是否被禁用
2. `CustomThrottlerGuard` - **频率限制（新增）**
3. `JwtAuthGuard` - JWT 认证
4. `PermissionsGuard` - 权限检查

#### 3.2 已应用限流的接口

**认证模块** (`auth.controller.ts`):

- `POST /auth/register` - 5 次/15分钟
- `POST /auth/login` - 10 次/分钟
- `POST /auth/refresh-token` - 20 次/分钟
- `POST /auth/request-password-reset` - 5 次/15分钟
- `POST /auth/reset-password` - 10 次/小时
- `PATCH /auth/change-password` - 10 次/15分钟

**文件上传模块** (`uploads.controller.ts`):

- `POST /uploads/single` - 20 次/分钟
- `POST /uploads/multiple` - 10 次/分钟
- `GET /uploads/download/:id` - 50 次/分钟
- `DELETE /uploads/stored` - 10 次/分钟（批量删除）

**健康检查模块** (`health.controller.ts`):

- 所有健康检查接口 - **跳过限流** (`@SkipThrottle()`)

## ⚙️ 配置说明

### 环境变量

添加到 `.env.example`:

```bash
# 请求频率限制配置
THROTTLE_ENABLED=true                    # 是否启用（默认: true）
THROTTLE_TTL=60000                       # 时间窗口（毫秒，默认: 60秒）
THROTTLE_LIMIT=100                       # 请求次数（开发: 100, 生产: 60）
THROTTLE_SKIP_IF_BEHIND_PROXY=false     # 是否跳过代理请求
```

### 默认配置

**开发环境**:

- 全局限制: 100 次/分钟

**生产环境**:

- 全局限制: 60 次/分钟

## 🚀 使用指南

### 1. 跳过限流

```typescript
@Get('health')
@SkipThrottle()
async healthCheck() {
  return { status: 'ok' }
}
```

### 2. 自定义限流

```typescript
import { THROTTLE_CONFIG } from '@mono/constants'
import { Throttle } from '~/modules/throttler/decorators/custom-throttle.decorator'

@Post('login')
@Throttle({ default: THROTTLE_CONFIG.AUTH.LOGIN })  // 10次/分钟
async login() {
  // ...
}
```

### 3. 动态限流

```typescript
@Post('export')
@Throttle({
  default: {
    limit: 5,      // 5次
    ttl: 60000     // 1分钟
  }
})
async export() {
  // ...
}
```

## 📊 限流策略一览

| 业务场景     | 限制   | 时间窗口 | 常量路径                                      |
| ------------ | ------ | -------- | --------------------------------------------- |
| **认证相关** |        |          |                                               |
| 登录         | 10 次  | 1 分钟   | `THROTTLE_CONFIG.AUTH.LOGIN`                  |
| 注册         | 5 次   | 15 分钟  | `THROTTLE_CONFIG.AUTH.REGISTER`               |
| 密码重置请求 | 5 次   | 15 分钟  | `THROTTLE_CONFIG.AUTH.PASSWORD_RESET_REQUEST` |
| 密码重置     | 10 次  | 1 小时   | `THROTTLE_CONFIG.AUTH.PASSWORD_RESET`         |
| 刷新令牌     | 20 次  | 1 分钟   | `THROTTLE_CONFIG.AUTH.REFRESH_TOKEN`          |
| 修改密码     | 10 次  | 15 分钟  | `THROTTLE_CONFIG.AUTH.CHANGE_PASSWORD`        |
| **文件操作** |        |          |                                               |
| 单文件上传   | 20 次  | 1 分钟   | `THROTTLE_CONFIG.UPLOAD.SINGLE`               |
| 批量上传     | 10 次  | 1 分钟   | `THROTTLE_CONFIG.UPLOAD.MULTIPLE`             |
| 文件下载     | 50 次  | 1 分钟   | `THROTTLE_CONFIG.UPLOAD.DOWNLOAD`             |
| **数据操作** |        |          |                                               |
| 创建操作     | 30 次  | 1 分钟   | `THROTTLE_CONFIG.DATA.CREATE`                 |
| 批量删除     | 10 次  | 1 分钟   | `THROTTLE_CONFIG.DATA.BATCH_DELETE`           |
| 导出操作     | 5 次   | 1 分钟   | `THROTTLE_CONFIG.DATA.EXPORT`                 |
| **查询操作** |        |          |                                               |
| 列表查询     | 100 次 | 1 分钟   | `THROTTLE_CONFIG.QUERY.LIST`                  |
| 详情查询     | 150 次 | 1 分钟   | `THROTTLE_CONFIG.QUERY.DETAIL`                |

## 🔍 技术细节

### 存储方式

- **当前**: 内存存储（单实例部署）
- **未来**: 可扩展为 Redis 存储（分布式部署）

### 识别维度

- **已认证用户**: 基于 `userId`（从 JWT token 中提取）
- **未认证用户**: 基于 `IP 地址`（支持代理环境）

### IP 获取优先级

1. `X-Forwarded-For` 头（取第一个）
2. `X-Real-IP` 头
3. `request.ip` 或 `request.socket.remoteAddress`
4. 回退值: `'unknown'`

## ✅ 质量保证

### Lint 检查

- ✅ ESLint 检查通过
- ✅ TypeScript 类型检查通过

### 代码质量

- ✅ 完整的 TypeScript 类型支持
- ✅ 详细的 JSDoc 注释
- ✅ 符合项目代码规范

## 📝 文件清单

### 新增文件

```
packages/constants/src/
  └── throttler.ts                                  # 共享常量

apps/server/src/
  ├── config/
  │   ├── configurations/throttler.config.ts        # 配置文件
  │   └── schemas/types.ts                          # 类型定义（已更新）
  └── modules/throttler/
      ├── decorators/
      │   ├── skip-throttle.decorator.ts
      │   └── custom-throttle.decorator.ts
      ├── guards/
      │   └── custom-throttler.guard.ts
      ├── filters/
      │   └── throttler-exception.filter.ts
      └── throttler.module.ts
```

### 修改文件

```
packages/constants/src/
  └── index.ts                                      # 导出 throttler 常量

apps/server/src/
  ├── app.module.ts                                 # 注册全局守卫
  ├── config/
  │   ├── config.module.ts                          # 加载 throttler 配置
  │   ├── services/config.service.ts                # 添加 throttler getter
  │   └── schemas/
  │       ├── types.ts                              # 添加 ThrottlerConfig 类型
  │       └── validation.schema.ts                  # 添加环境变量验证
  └── modules/
      ├── auth/auth.controller.ts                   # 应用限流装饰器
      ├── uploads/uploads.controller.ts             # 应用限流装饰器
      └── health/health.controller.ts               # 跳过限流
```

## 🎉 总结

✅ **成功完成**: 基础设施、核心功能、业务适配三个阶段  
✅ **代码质量**: 所有 lint 检查通过，类型安全  
✅ **模块化设计**: 符合项目架构理念，易于维护和扩展  
✅ **业务友好**: 差异化限流策略，友好的错误提示  
✅ **可扩展性**: 预留 Redis 扩展接口，支持未来分布式部署

---

**实施时间**: 2025-09-30  
**状态**: ✅ 已完成并通过所有检查
