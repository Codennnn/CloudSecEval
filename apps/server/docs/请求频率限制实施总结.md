# è¯·æ±‚é¢‘ç‡é™åˆ¶å®æ–½æ€»ç»“

## ğŸ“‹ å®æ–½æ¦‚è§ˆ

æœ¬æ¬¡ä¸º NestJS API Server æˆåŠŸå¼•å…¥äº†åŸºäº `@nestjs/throttler` çš„è¯·æ±‚é¢‘ç‡é™åˆ¶åŠŸèƒ½ï¼Œé‡‡ç”¨å†…å­˜å­˜å‚¨æ–¹å¼ï¼Œæ”¯æŒåŸºäºç”¨æˆ· ID å’Œ IP åœ°å€çš„å·®å¼‚åŒ–é™æµç­–ç•¥ã€‚

## ğŸ¯ å·²å®Œæˆçš„åŠŸèƒ½

### 1. åŸºç¡€è®¾æ–½

#### 1.1 ä¾èµ–å®‰è£…

- âœ… å®‰è£…äº† `@nestjs/throttler@6.4.0`

#### 1.2 å…±äº«å¸¸é‡

- âœ… åˆ›å»º `packages/constants/src/throttler.ts`
  - å®šä¹‰æ—¶é—´çª—å£å¸¸é‡ï¼ˆ1åˆ†é’Ÿã€5åˆ†é’Ÿã€15åˆ†é’Ÿã€1å°æ—¶ï¼‰
  - å®šä¹‰å„ä¸šåŠ¡åœºæ™¯çš„é™æµé…ç½®
  - å¯¼å‡ºåˆ° `@mono/constants` åŒ…ä¾›å…¨å±€ä½¿ç”¨

#### 1.3 é…ç½®ç³»ç»Ÿ

- âœ… åˆ›å»º `throttler.config.ts` é…ç½®æ–‡ä»¶
- âœ… æ›´æ–° `config.module.ts` åŠ è½½é…ç½®
- âœ… æ›´æ–° `config.service.ts` æ·»åŠ  throttler getter
- âœ… æ›´æ–° `validation.schema.ts` æ·»åŠ ç¯å¢ƒå˜é‡éªŒè¯
- âœ… æ›´æ–° `types.ts` æ·»åŠ  ThrottlerConfig ç±»å‹

### 2. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

#### 2.1 Throttler æ¨¡å—

**ä½ç½®**: `src/modules/throttler/`

**ç»“æ„**:

```
throttler/
â”œâ”€â”€ decorators/
â”‚   â”œâ”€â”€ skip-throttle.decorator.ts    # è·³è¿‡é™æµè£…é¥°å™¨
â”‚   â””â”€â”€ custom-throttle.decorator.ts  # è‡ªå®šä¹‰é™æµè£…é¥°å™¨
â”œâ”€â”€ guards/
â”‚   â””â”€â”€ custom-throttler.guard.ts     # è‡ªå®šä¹‰å®ˆå«
â”œâ”€â”€ filters/
â”‚   â””â”€â”€ throttler-exception.filter.ts # å¼‚å¸¸è¿‡æ»¤å™¨
â””â”€â”€ throttler.module.ts                # æ¨¡å—å®šä¹‰
```

#### 2.2 è‡ªå®šä¹‰å®ˆå« (`CustomThrottlerGuard`)

**åŠŸèƒ½**:

- æ”¯æŒåŸºäºç”¨æˆ· ID çš„é™æµï¼ˆå·²è®¤è¯ç”¨æˆ·ï¼‰
- æ”¯æŒåŸºäº IP åœ°å€çš„é™æµï¼ˆæœªè®¤è¯ç”¨æˆ·ï¼‰
- è‡ªåŠ¨è¯†åˆ«ä»£ç†ç¯å¢ƒä¸‹çš„çœŸå® IPï¼ˆæ”¯æŒ `X-Forwarded-For` å’Œ `X-Real-IP` å¤´ï¼‰

**é™æµé”®ç”Ÿæˆç­–ç•¥**:

- å·²è®¤è¯: `user-{userId}`
- æœªè®¤è¯: `ip-{ipAddress}`

#### 2.3 å¼‚å¸¸è¿‡æ»¤å™¨ (`ThrottlerExceptionFilter`)

**åŠŸèƒ½**:

- æ•è· `ThrottlerException` å¼‚å¸¸
- è¿”å›ç»Ÿä¸€çš„ä¸šåŠ¡é”™è¯¯å“åº”æ ¼å¼
- æä¾›å‹å¥½çš„é”™è¯¯ä¿¡æ¯å’Œé‡ç½®æ—¶é—´

**å“åº”æ ¼å¼**:

```json
{
  "code": 429,
  "message": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
  "businessCode": 20500,
  "timestamp": "2025-09-30T12:00:00.000Z",
  "path": "/api/auth/login",
  "extraData": {
    "resetAt": "2025-09-30T12:01:00.000Z"
  }
}
```

### 3. ä¸šåŠ¡é›†æˆ

#### 3.1 å…¨å±€å®ˆå«æ³¨å†Œ

åœ¨ `app.module.ts` ä¸­æ³¨å†Œï¼Œå®ˆå«æ‰§è¡Œé¡ºåºï¼š

1. `DisabledApiGuard` - æ£€æŸ¥æ¥å£æ˜¯å¦è¢«ç¦ç”¨
2. `CustomThrottlerGuard` - **é¢‘ç‡é™åˆ¶ï¼ˆæ–°å¢ï¼‰**
3. `JwtAuthGuard` - JWT è®¤è¯
4. `PermissionsGuard` - æƒé™æ£€æŸ¥

#### 3.2 å·²åº”ç”¨é™æµçš„æ¥å£

**è®¤è¯æ¨¡å—** (`auth.controller.ts`):

- `POST /auth/register` - 5 æ¬¡/15åˆ†é’Ÿ
- `POST /auth/login` - 10 æ¬¡/åˆ†é’Ÿ
- `POST /auth/refresh-token` - 20 æ¬¡/åˆ†é’Ÿ
- `POST /auth/request-password-reset` - 5 æ¬¡/15åˆ†é’Ÿ
- `POST /auth/reset-password` - 10 æ¬¡/å°æ—¶
- `PATCH /auth/change-password` - 10 æ¬¡/15åˆ†é’Ÿ

**æ–‡ä»¶ä¸Šä¼ æ¨¡å—** (`uploads.controller.ts`):

- `POST /uploads/single` - 20 æ¬¡/åˆ†é’Ÿ
- `POST /uploads/multiple` - 10 æ¬¡/åˆ†é’Ÿ
- `GET /uploads/download/:id` - 50 æ¬¡/åˆ†é’Ÿ
- `DELETE /uploads/stored` - 10 æ¬¡/åˆ†é’Ÿï¼ˆæ‰¹é‡åˆ é™¤ï¼‰

**å¥åº·æ£€æŸ¥æ¨¡å—** (`health.controller.ts`):

- æ‰€æœ‰å¥åº·æ£€æŸ¥æ¥å£ - **è·³è¿‡é™æµ** (`@SkipThrottle()`)

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

æ·»åŠ åˆ° `.env.example`:

```bash
# è¯·æ±‚é¢‘ç‡é™åˆ¶é…ç½®
THROTTLE_ENABLED=true                    # æ˜¯å¦å¯ç”¨ï¼ˆé»˜è®¤: trueï¼‰
THROTTLE_TTL=60000                       # æ—¶é—´çª—å£ï¼ˆæ¯«ç§’ï¼Œé»˜è®¤: 60ç§’ï¼‰
THROTTLE_LIMIT=100                       # è¯·æ±‚æ¬¡æ•°ï¼ˆå¼€å‘: 100, ç”Ÿäº§: 60ï¼‰
THROTTLE_SKIP_IF_BEHIND_PROXY=false     # æ˜¯å¦è·³è¿‡ä»£ç†è¯·æ±‚
```

### é»˜è®¤é…ç½®

**å¼€å‘ç¯å¢ƒ**:

- å…¨å±€é™åˆ¶: 100 æ¬¡/åˆ†é’Ÿ

**ç”Ÿäº§ç¯å¢ƒ**:

- å…¨å±€é™åˆ¶: 60 æ¬¡/åˆ†é’Ÿ

## ğŸš€ ä½¿ç”¨æŒ‡å—

### 1. è·³è¿‡é™æµ

```typescript
@Get('health')
@SkipThrottle()
async healthCheck() {
  return { status: 'ok' }
}
```

### 2. è‡ªå®šä¹‰é™æµ

```typescript
import { THROTTLE_CONFIG } from '@mono/constants'
import { Throttle } from '~/modules/throttler/decorators/custom-throttle.decorator'

@Post('login')
@Throttle({ default: THROTTLE_CONFIG.AUTH.LOGIN })  // 10æ¬¡/åˆ†é’Ÿ
async login() {
  // ...
}
```

### 3. åŠ¨æ€é™æµ

```typescript
@Post('export')
@Throttle({
  default: {
    limit: 5,      // 5æ¬¡
    ttl: 60000     // 1åˆ†é’Ÿ
  }
})
async export() {
  // ...
}
```

## ğŸ“Š é™æµç­–ç•¥ä¸€è§ˆ

| ä¸šåŠ¡åœºæ™¯     | é™åˆ¶   | æ—¶é—´çª—å£ | å¸¸é‡è·¯å¾„                                      |
| ------------ | ------ | -------- | --------------------------------------------- |
| **è®¤è¯ç›¸å…³** |        |          |                                               |
| ç™»å½•         | 10 æ¬¡  | 1 åˆ†é’Ÿ   | `THROTTLE_CONFIG.AUTH.LOGIN`                  |
| æ³¨å†Œ         | 5 æ¬¡   | 15 åˆ†é’Ÿ  | `THROTTLE_CONFIG.AUTH.REGISTER`               |
| å¯†ç é‡ç½®è¯·æ±‚ | 5 æ¬¡   | 15 åˆ†é’Ÿ  | `THROTTLE_CONFIG.AUTH.PASSWORD_RESET_REQUEST` |
| å¯†ç é‡ç½®     | 10 æ¬¡  | 1 å°æ—¶   | `THROTTLE_CONFIG.AUTH.PASSWORD_RESET`         |
| åˆ·æ–°ä»¤ç‰Œ     | 20 æ¬¡  | 1 åˆ†é’Ÿ   | `THROTTLE_CONFIG.AUTH.REFRESH_TOKEN`          |
| ä¿®æ”¹å¯†ç      | 10 æ¬¡  | 15 åˆ†é’Ÿ  | `THROTTLE_CONFIG.AUTH.CHANGE_PASSWORD`        |
| **æ–‡ä»¶æ“ä½œ** |        |          |                                               |
| å•æ–‡ä»¶ä¸Šä¼    | 20 æ¬¡  | 1 åˆ†é’Ÿ   | `THROTTLE_CONFIG.UPLOAD.SINGLE`               |
| æ‰¹é‡ä¸Šä¼      | 10 æ¬¡  | 1 åˆ†é’Ÿ   | `THROTTLE_CONFIG.UPLOAD.MULTIPLE`             |
| æ–‡ä»¶ä¸‹è½½     | 50 æ¬¡  | 1 åˆ†é’Ÿ   | `THROTTLE_CONFIG.UPLOAD.DOWNLOAD`             |
| **æ•°æ®æ“ä½œ** |        |          |                                               |
| åˆ›å»ºæ“ä½œ     | 30 æ¬¡  | 1 åˆ†é’Ÿ   | `THROTTLE_CONFIG.DATA.CREATE`                 |
| æ‰¹é‡åˆ é™¤     | 10 æ¬¡  | 1 åˆ†é’Ÿ   | `THROTTLE_CONFIG.DATA.BATCH_DELETE`           |
| å¯¼å‡ºæ“ä½œ     | 5 æ¬¡   | 1 åˆ†é’Ÿ   | `THROTTLE_CONFIG.DATA.EXPORT`                 |
| **æŸ¥è¯¢æ“ä½œ** |        |          |                                               |
| åˆ—è¡¨æŸ¥è¯¢     | 100 æ¬¡ | 1 åˆ†é’Ÿ   | `THROTTLE_CONFIG.QUERY.LIST`                  |
| è¯¦æƒ…æŸ¥è¯¢     | 150 æ¬¡ | 1 åˆ†é’Ÿ   | `THROTTLE_CONFIG.QUERY.DETAIL`                |

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### å­˜å‚¨æ–¹å¼

- **å½“å‰**: å†…å­˜å­˜å‚¨ï¼ˆå•å®ä¾‹éƒ¨ç½²ï¼‰
- **æœªæ¥**: å¯æ‰©å±•ä¸º Redis å­˜å‚¨ï¼ˆåˆ†å¸ƒå¼éƒ¨ç½²ï¼‰

### è¯†åˆ«ç»´åº¦

- **å·²è®¤è¯ç”¨æˆ·**: åŸºäº `userId`ï¼ˆä» JWT token ä¸­æå–ï¼‰
- **æœªè®¤è¯ç”¨æˆ·**: åŸºäº `IP åœ°å€`ï¼ˆæ”¯æŒä»£ç†ç¯å¢ƒï¼‰

### IP è·å–ä¼˜å…ˆçº§

1. `X-Forwarded-For` å¤´ï¼ˆå–ç¬¬ä¸€ä¸ªï¼‰
2. `X-Real-IP` å¤´
3. `request.ip` æˆ– `request.socket.remoteAddress`
4. å›é€€å€¼: `'unknown'`

## âœ… è´¨é‡ä¿è¯

### Lint æ£€æŸ¥

- âœ… ESLint æ£€æŸ¥é€šè¿‡
- âœ… TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡

### ä»£ç è´¨é‡

- âœ… å®Œæ•´çš„ TypeScript ç±»å‹æ”¯æŒ
- âœ… è¯¦ç»†çš„ JSDoc æ³¨é‡Š
- âœ… ç¬¦åˆé¡¹ç›®ä»£ç è§„èŒƒ

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

```
packages/constants/src/
  â””â”€â”€ throttler.ts                                  # å…±äº«å¸¸é‡

apps/server/src/
  â”œâ”€â”€ config/
  â”‚   â”œâ”€â”€ configurations/throttler.config.ts        # é…ç½®æ–‡ä»¶
  â”‚   â””â”€â”€ schemas/types.ts                          # ç±»å‹å®šä¹‰ï¼ˆå·²æ›´æ–°ï¼‰
  â””â”€â”€ modules/throttler/
      â”œâ”€â”€ decorators/
      â”‚   â”œâ”€â”€ skip-throttle.decorator.ts
      â”‚   â””â”€â”€ custom-throttle.decorator.ts
      â”œâ”€â”€ guards/
      â”‚   â””â”€â”€ custom-throttler.guard.ts
      â”œâ”€â”€ filters/
      â”‚   â””â”€â”€ throttler-exception.filter.ts
      â””â”€â”€ throttler.module.ts
```

### ä¿®æ”¹æ–‡ä»¶

```
packages/constants/src/
  â””â”€â”€ index.ts                                      # å¯¼å‡º throttler å¸¸é‡

apps/server/src/
  â”œâ”€â”€ app.module.ts                                 # æ³¨å†Œå…¨å±€å®ˆå«
  â”œâ”€â”€ config/
  â”‚   â”œâ”€â”€ config.module.ts                          # åŠ è½½ throttler é…ç½®
  â”‚   â”œâ”€â”€ services/config.service.ts                # æ·»åŠ  throttler getter
  â”‚   â””â”€â”€ schemas/
  â”‚       â”œâ”€â”€ types.ts                              # æ·»åŠ  ThrottlerConfig ç±»å‹
  â”‚       â””â”€â”€ validation.schema.ts                  # æ·»åŠ ç¯å¢ƒå˜é‡éªŒè¯
  â””â”€â”€ modules/
      â”œâ”€â”€ auth/auth.controller.ts                   # åº”ç”¨é™æµè£…é¥°å™¨
      â”œâ”€â”€ uploads/uploads.controller.ts             # åº”ç”¨é™æµè£…é¥°å™¨
      â””â”€â”€ health/health.controller.ts               # è·³è¿‡é™æµ
```

## ğŸ‰ æ€»ç»“

âœ… **æˆåŠŸå®Œæˆ**: åŸºç¡€è®¾æ–½ã€æ ¸å¿ƒåŠŸèƒ½ã€ä¸šåŠ¡é€‚é…ä¸‰ä¸ªé˜¶æ®µ  
âœ… **ä»£ç è´¨é‡**: æ‰€æœ‰ lint æ£€æŸ¥é€šè¿‡ï¼Œç±»å‹å®‰å…¨  
âœ… **æ¨¡å—åŒ–è®¾è®¡**: ç¬¦åˆé¡¹ç›®æ¶æ„ç†å¿µï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•  
âœ… **ä¸šåŠ¡å‹å¥½**: å·®å¼‚åŒ–é™æµç­–ç•¥ï¼Œå‹å¥½çš„é”™è¯¯æç¤º  
âœ… **å¯æ‰©å±•æ€§**: é¢„ç•™ Redis æ‰©å±•æ¥å£ï¼Œæ”¯æŒæœªæ¥åˆ†å¸ƒå¼éƒ¨ç½²

---

**å®æ–½æ—¶é—´**: 2025-09-30  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶é€šè¿‡æ‰€æœ‰æ£€æŸ¥
