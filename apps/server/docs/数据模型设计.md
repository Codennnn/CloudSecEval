# 付费阅读服务数据模型设计

## 设计概述

本项目是一个专注于付费阅读功能的后端服务，数据库设计采用关系型数据模型，基于 PostgreSQL 实现，并通过 Prisma ORM 进行管理。主要特点：

- **简洁的架构**：专注于用户管理和授权码控制
- **JWT 认证**：基于 JWT 的用户认证系统
- **授权码机制**：通过授权码控制付费内容访问
- **风控系统**：防止授权码滥用和异常访问
- **关系完整性**：通过外键保证数据一致性
- **UUID 主键**：使用 UUID 作为主键，增强安全性

## 核心实体模型

### 用户模型 (User)

用户是系统的基本操作主体，代表能够登录和使用系统的个体。

```prisma
model User {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String    @unique
  phone         String?
  passwordHash  String
  name          String?
  avatarUrl     String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 关联
  passwordResetTokens PasswordResetToken[]
  refreshTokens       RefreshToken[]

  @@map("users")
}
```

**字段说明**：

- `id`：UUID 类型的用户唯一标识
- `email`：用户邮箱，唯一约束
- `phone`：用户手机号（可选）
- `passwordHash`：密码哈希值（不存储明文密码）
- `name`：用户姓名/显示名称
- `avatarUrl`：用户头像 URL
- `isActive`：账户状态标志
- `createdAt`：创建时间
- `updatedAt`：更新时间
- `passwordResetTokens`：密码重置令牌关联
- `refreshTokens`：刷新令牌关联

### 密码重置令牌模型 (PasswordResetToken)

用于处理用户密码重置功能。

```prisma
model PasswordResetToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  token     String   @unique
  userId    String   @db.Uuid
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)

  // 关联
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}
```

**字段说明**：

- `id`：UUID 类型的令牌唯一标识
- `token`：重置令牌，唯一约束
- `userId`：关联的用户 ID
- `expiresAt`：令牌过期时间
- `createdAt`：创建时间
- `used`：是否已使用

### 刷新令牌模型 (RefreshToken)

用于 JWT 令牌刷新机制。

```prisma
model RefreshToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  token     String   @unique
  userId    String   @db.Uuid
  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)

  // 关联
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}
```

**字段说明**：

- `id`：UUID 类型的令牌唯一标识
- `token`：刷新令牌，唯一约束
- `userId`：关联的用户 ID
- `expiresAt`：令牌过期时间
- `createdAt`：创建时间
- `revoked`：是否已撤销

### 授权码模型 (License)

用于付费内容访问控制的核心模型。

```prisma
model License {
  id              String    @id @default(cuid())
  email           String    // 移除 @unique 约束，允许一个邮箱多个授权码
  code            String    @unique
  purchaseAmount  Decimal   @default(0)
  usageCount      Int       @default(0)
  maxUsage        Int       @default(100)
  lastIP          String?
  lastUserAgent   String?
  isLocked        Boolean   @default(false)
  lockReason      String?
  expiresAt       DateTime?
  lastAccessedAt  DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 关联关系
  user       User?       @relation(fields: [userId], references: [id])
  userId     String?
  accessLogs AccessLog[]

  @@map("licenses")
}
```

**字段说明**：

- `id`：UUID 类型的授权码唯一标识
- `email`：绑定的邮箱地址，唯一约束
- `code`：授权码，支持多段格式如 ABCD-EFGH-IJKL-MNOP-Q，唯一约束
- `verified`：邮箱是否已验证
- `lastIP`：最近使用的 IP 地址
- `locked`：是否被锁定（风控机制）
- `warningCount`：风控警告次数
- `createdAt`：创建时间
- `updatedAt`：更新时间

### 访问日志模型 (AccessLog)

记录授权码使用情况，用于风控分析。

```prisma
model AccessLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  licenseId  String   @db.Uuid
  email      String
  ip         String // 访问IP地址
  isRisky    Boolean  @default(false) // 是否为风险访问
  accessedAt DateTime @default(now())

  // 关联
  license License @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  @@map("access_logs")
}
```

**字段说明**：

- `id`：UUID 类型的日志唯一标识
- `licenseId`：关联的授权码 ID
- `email`：访问者邮箱
- `ip`：访问 IP 地址
- `isRisky`：是否为风险访问（用于风控）
- `accessedAt`：访问时间

## 设计考量

### 数据一致性

- 使用 `onDelete: Cascade` 确保删除用户时自动清理关联记录
- 使用 Prisma 的事务支持确保复杂操作的原子性
- 通过唯一约束防止重复数据

### 安全性考量

- 不存储明文密码，仅存储通过 bcrypt 等算法生成的哈希值
- 使用 UUID 作为主键，避免使用自增 ID 带来的安全风险
- 授权码采用唯一性约束和邮箱绑定机制
- 通过访问日志记录和风控机制防止授权码滥用

### 性能优化

- 为 `email` 字段添加唯一索引，加速查询
- 为授权码相关的外键添加索引，提高查询性能
- 为访问日志的时间字段添加索引，优化日志查询
- 使用 Prisma Accelerate 优化查询性能

## 业务逻辑说明

### 授权码验证流程

1. 用户提供邮箱和授权码
2. 系统验证邮箱和授权码的匹配关系
3. 检查授权码是否被锁定
4. 记录访问日志
5. 根据风控策略判断是否允许访问

### 风控机制

- **设备绑定**：记录首次使用的 IP 地址
- **异常检测**：检测频繁的 IP 切换
- **访问频率限制**：防止过度使用
- **自动锁定**：达到警告阈值后自动锁定授权码

## 数据库迁移与管理

### 开发环境

在开发环境中，推荐使用 Prisma 的 `db push` 命令快速将模型变更应用到数据库：

```bash
pnpm prisma:push
```

### 生产环境

在生产环境中，应使用 Prisma 的迁移功能来管理数据库结构变更：

```bash
# 创建迁移
pnpm prisma:dev

# 应用迁移
pnpm prisma:deploy
```

### 数据查看与管理

通过 Prisma Studio 可以方便地可视化查看和编辑数据：

```bash
pnpm studio
```
