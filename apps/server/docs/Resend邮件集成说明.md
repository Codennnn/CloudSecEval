# Resend 邮件服务集成说明

## 📧 功能概述

本次集成为授权码系统添加了基于 Resend 的真实邮件发送功能，替换了原有的模拟邮件发送。

## 🚀 新增功能

### 1. 邮件服务模块

- **位置**: `src/modules/mail/`
- **核心服务**: `MailService`
- **支持的邮件类型**:
  - 授权码发放邮件
  - 安全警告邮件
  - 账户锁定邮件

### 2. 邮件模板系统

- **授权码模板**: 精美的 HTML 邮件，包含授权码和使用说明
- **安全警告模板**: IP 变更安全提醒邮件
- **锁定通知模板**: 账户被锁定时的通知邮件

### 3. 配置管理

- **环境变量**: 在 `.env.example` 中新增 Resend 配置
- **类型安全**: 使用 TypeScript 接口定义配置结构
- **配置验证**: 集成到 NestJS 配置系统

## 📋 环境变量配置

在你的 `.env` 文件中添加以下配置：

```bash
# ==== 邮件服务配置 (Resend) ====
# Resend API 密钥，从 https://resend.com/api-keys 获取
RESEND_API_KEY="re_your_api_key_here"
# 发件人邮箱地址（需要在 Resend 中验证的域名）
MAIL_FROM_ADDRESS="noreply@yourdomain.com"
# 发件人名称
MAIL_FROM_NAME="Your App Name"
# ========
```

## 🛠️ 使用方法

### 1. 人工发放授权码

当调用 `/api/license/manual-issue` 接口时：

1. 检查邮箱是否已存在授权码
2. 生成唯一授权码并保存到数据库
3. 发送包含授权码的精美邮件
4. **如果邮件发送失败，自动删除已创建的授权码记录**
5. 只有邮件发送成功才视为发放成功

**成功响应示例**:

```json
{
  "statusCode": 200,
  "message": "授权码发放成功，邮件已发送",
  "data": {
    "code": "ABCD-EFGH-IJKL-MNOP-Q",
    "messageId": "resend-message-id"
  }
}
```

**失败响应示例**:

```json
{
  "statusCode": 500,
  "message": "授权码发放失败：邮件发送失败 - API key invalid",
  "data": null
}
```

### 2. 自动安全邮件

系统会在以下情况自动发送邮件：

- **IP 变更警告**: 检测到新 IP 访问时
- **账户锁定通知**: 异常访问导致锁定时

## 📁 文件结构

```
src/modules/mail/
├── mail.module.ts                 # 邮件服务模块
├── mail.service.ts                # 邮件服务核心逻辑
├── interfaces/
│   └── mail.interface.ts          # 邮件相关接口定义
└── templates/
    ├── license-code.template.ts   # 授权码邮件模板
    ├── security-warning.template.ts # 安全警告邮件模板
    └── account-lock.template.ts   # 锁定通知邮件模板

src/config/configurations/
└── mail.config.ts                 # 邮件配置文件
```

## 🎨 邮件模板特性

### 授权码邮件模板

- 🎉 精美的渐变色标题
- 🔑 突出显示的授权码
- ⚠️ 详细的使用说明
- 📱 响应式设计，支持移动端

### 安全警告邮件模板

- 🔒 醒目的安全警告样式
- 📍 显示新 IP 地址和时间
- 🛡️ 提供安全建议
- 📞 联系客服指引

### 锁定通知邮件模板

- 🚨 紧急锁定通知样式
- 📋 详细的锁定信息
- 🔓 解锁流程说明
- 💬 客服联系方式

## 🔧 技术实现亮点

1. **🔒 严格的事务性**: 邮件发送失败会自动回滚授权码创建，确保数据一致性
2. **📝 详细日志**: 完整的邮件发送成功/失败日志记录
3. **🛡️ 类型安全**: 完整的 TypeScript 类型定义
4. **🧩 模块化设计**: 独立的邮件模块，易于测试和维护
5. **⚙️ 配置灵活**: 支持多环境配置
6. **♻️ 自动清理**: 发送失败时自动清理无效的授权码记录

## 🚨 注意事项

1. **Resend 配置**: 确保在 Resend 中验证了发件人域名
2. **API 密钥**: 妥善保管 Resend API 密钥
3. **邮件限制**: 注意 Resend 的发送限制和配额
4. **测试环境**: 建议在测试环境先验证邮件发送功能

## 📈 扩展建议

未来可以考虑添加：

- 邮件发送队列（Redis + Bull）
- 邮件发送统计和监控
- 更多邮件模板（欢迎邮件、密码重置等）
- 邮件发送重试机制
- 邮件模板的可视化编辑器

## 🧪 测试方法

1. 配置正确的环境变量
2. 调用 `/api/license/manual-issue` 接口
3. 检查目标邮箱是否收到授权码邮件
4. 查看应用日志确认发送状态

## 📞 问题排查

如果邮件发送失败，请检查：

1. Resend API 密钥是否正确
2. 发件人域名是否已在 Resend 中验证
3. 网络连接是否正常
4. 是否达到 Resend 发送限制

查看应用日志获取详细错误信息。
