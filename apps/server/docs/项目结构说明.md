# NestJS + Prisma 付费阅读服务项目结构说明

## 目录结构概览

```
/
├── docs/                # 项目文档
├── src/                 # 源代码
│   ├── modules/         # 业务模块文件夹
│   │   ├── auth/        # 认证授权模块
│   │   ├── users/       # 用户模块
│   │   └── license/     # 授权码模块（付费内容访问控制）
│   ├── prisma/          # Prisma 服务模块
│   │   ├── schema.prisma # 数据库模型定义
│   │   ├── prisma.service.ts # Prisma 服务
│   │   ├── prisma.module.ts  # Prisma 模块
│   │   └── seeds/       # 数据库种子脚本
│   ├── common/          # 通用工具和组件
│   │   ├── dto/         # 通用数据传输对象
│   │   ├── filters/     # 异常过滤器
│   │   ├── interceptors/ # 拦截器
│   │   ├── interfaces/  # 通用接口定义
│   │   └── utils/       # 工具函数
│   ├── config/          # 配置管理
│   │   ├── configurations/ # 各种配置文件
│   │   └── schemas/     # 配置验证模式
│   ├── types/           # TypeScript 类型定义
│   │   ├── common.ts    # 通用类型定义
│   │   └── express.d.ts # Express 类型扩展
│   ├── app.controller.ts # 应用根控制器
│   ├── app.service.ts   # 应用根服务
│   ├── app.module.ts    # 应用主模块
│   └── main.ts          # 应用入口点
├── test/                # 测试文件
├── dist/                # 编译输出目录
├── generated/           # 自动生成的文件
├── node_modules/        # 依赖包
├── .gitignore           # Git 忽略配置
├── eslint.config.mjs    # ESLint 配置
├── nest-cli.json        # NestJS CLI 配置
├── package.json         # 项目依赖配置
├── pnpm-lock.yaml       # pnpm 锁定文件
├── tsconfig.json        # TypeScript 配置
├── tsconfig.build.json  # TypeScript 构建配置
└── README.md            # 项目说明
```

## 核心目录详解

### `/docs` 目录

**作用**：存放项目相关文档

**主要内容**：

- 开发指南：项目概述、开发环境配置、开发工作流等
- API 文档：API 接口说明和使用方法
- 数据库设计文档：详细的数据模型设计和关系
- 部署文档：项目部署和运维相关说明

### `/prisma` 目录

**作用**：Prisma ORM 相关配置和数据库模型定义

**主要内容**：

- `schema.prisma`：定义数据库模型、关系和映射配置
- `migrations/`：数据库迁移文件，记录数据库结构变更
- `seed.ts`（可选）：数据填充脚本，用于初始化基础数据

**重要性**：此目录是项目数据层的核心，定义了整个应用的数据结构和关系。

### `/src` 目录

#### `/src/modules` 目录

**作用**：按业务领域划分的模块目录，是项目业务逻辑的主要存放位置

**子目录规范**：每个业务模块应包含以下文件结构：

```
/modules/{模块名}/
├── {模块名}.controller.ts  # 控制器：处理 HTTP 请求和响应
├── {模块名}.service.ts     # 服务层：处理业务逻辑
├── {模块名}.repository.ts  # 仓库层：封装数据访问逻辑
├── {模块名}.module.ts      # 模块定义
├── dto/                  # 数据传输对象
│   ├── create-{实体}.dto.ts  # 创建实体的数据传输对象
│   └── update-{实体}.dto.ts  # 更新实体的数据传输对象
└── entities/             # 实体定义
    └── {实体}.entity.ts     # 实体类定义
```

##### `/src/modules/auth` 目录

**作用**：用户认证和授权功能

**主要功能**：

- 用户登录验证
- JWT 令牌管理
- 权限控制
- 认证守卫

**核心文件**：

- `auth.controller.ts`：处理认证相关的 HTTP 请求
- `auth.service.ts`：实现认证和授权的业务逻辑
- `auth.module.ts`：认证模块定义
- `guards/`：认证守卫
- `strategies/`：认证策略

##### `/src/modules/users` 目录

**作用**：用户管理相关功能

**主要功能**：

- 用户注册与登录
- 用户信息管理
- 用户密码重置
- 用户权限控制

**核心文件**：

- `users.controller.ts`：处理用户相关的 HTTP 请求
- `users.service.ts`：实现用户管理的业务逻辑
- `users.repository.ts`：封装对用户数据的访问操作
- `dto/create-user.dto.ts`：用户创建请求数据验证
- `entities/user.entity.ts`：用户实体类定义

##### `/src/modules/license` 目录

**作用**：授权码模块，用于付费内容访问控制

**主要功能**：

- 手动发放授权码
- 验证授权码有效性
- 记录访问日志
- 风控检测（多设备访问、异常行为）

**核心文件**：

- `license.controller.ts`：处理授权码相关的 HTTP 请求
- `license.service.ts`：实现授权码管理的业务逻辑
- `license.repository.ts`：封装对授权码数据的访问操作
- `dto/check-license.dto.ts`：授权码验证请求数据验证
- `entities/license.entity.ts`：授权码实体类定义

##### `/src/modules/mail` 目录

**作用**：邮件发送服务模块

**主要功能**：

- 授权码发放邮件
- 安全警告邮件
- 账户锁定通知
- 过期提醒邮件

**核心文件**：

- `mail.service.ts`：邮件发送核心逻辑
- `mail.module.ts`：邮件模块定义
- `dto/`：邮件相关数据传输对象
- `templates/`：邮件模板目录
  - `license-code.template.ts`：授权码邮件模板
  - `security-warning.template.ts`：安全警告邮件模板
  - `account-lock.template.ts`：账户锁定邮件模板
  - `expiration-reminder.template.ts`：过期提醒邮件模板
  - `expiration-notice.template.ts`：过期通知邮件模板

**集成服务**：基于 Resend 的邮件发送服务

##### `/src/modules/statistics` 目录

**作用**：数据统计和分析模块

**主要功能**：

- 用户统计（总数、活跃度、增长趋势、地理分布）
- 授权码统计（使用情况、趋势分析、状态分布）
- 访问统计（访问量、设备分析、风险分析）
- 收入统计（总收入、趋势、客户价值分析）
- 实时监控（在线用户、系统状态、性能指标）
- 风控分析（异常检测、安全事件、风控效果）

**核心文件**：

- `statistics.controller.ts`：统计相关 API 接口
- `statistics.service.ts`：统计业务逻辑
- `statistics.repository.ts`：统计数据访问层
- `statistics.module.ts`：统计模块定义
- `dto/`：统计相关数据传输对象

#### `/src/prisma` 目录

**作用**：Prisma 客户端的封装和服务提供

**主要内容**：

- `prisma.service.ts`：封装 PrismaClient，提供数据库连接和操作
- `prisma.module.ts`：将 PrismaService 作为模块提供给其他模块使用

**重要性**：

- 集中管理数据库连接
- 实现连接池和生命周期管理
- 提供事务支持
- 实现查询日志和性能监控

#### `/src/common` 目录

**作用**：存放通用工具、拦截器、过滤器、装饰器等

**子目录结构**：

```
/common/
├── interceptors/        # 拦截器
├── filters/             # 异常过滤器
├── decorators/          # 自定义装饰器
├── guards/              # 守卫
└── utils/               # 工具函数
```

**主要功能**：

- 请求日志记录
- 全局异常处理
- 响应格式统一
- 权限校验
- 通用工具函数

#### `/src/config` 目录

**作用**：管理应用配置

**主要内容**：

- 环境变量配置
- 配置验证
- 不同环境的配置管理

#### 核心文件

- `app.module.ts`：应用根模块，整合所有功能模块
- `main.ts`：应用入口，初始化 NestJS 应用并配置全局中间件

### `/test` 目录

**作用**：存放各种测试文件

**子目录结构**：

```
/test/
├── unit/               # 单元测试
├── integration/        # 集成测试
└── e2e/                # 端到端测试
```

**测试范围**：

- 单元测试：测试独立组件和函数
- 集成测试：测试组件间的交互
- 端到端测试：测试完整的业务流程

### 配置文件

- `.env`：环境变量配置，包含敏感信息
- `package.json`：项目依赖和脚本定义
- `nest-cli.json`：NestJS 配置
- `tsconfig.json`：TypeScript 配置
- `.eslintrc`：代码规范检查配置
- `.prettierrc`：代码格式化配置

## 分层架构说明

项目采用清晰的分层架构，确保关注点分离和代码可维护性：

- **Controller 层**：处理 HTTP 请求，负责参数验证和响应格式化
- **Service 层**：实现业务逻辑，不直接处理 HTTP 或数据库细节
- **Repository 层**：封装数据访问逻辑，提供对数据库的操作接口
- **Entity/Model 层**：定义业务实体和数据模型

## 模块间通信

模块之间的通信主要通过以下方式：

- **模块导入**：在 module 文件中导入其他模块
- **服务注入**：通过依赖注入使用其他模块的服务
- **事件系统**：使用 NestJS 的事件发布/订阅机制进行松耦合通信

## 代码规范和最佳实践

### 命名约定

- 文件名使用短横线命名法：`user-profile.service.ts`
- 类名使用大驼峰命名法：`UserProfileService`
- 方法和变量使用小驼峰命名法：`getUserProfile()`

### 代码组织

- 每个文件只包含一个主要类/组件
- 相关功能放在同一个模块中
- 通用功能放在 common 目录

### 依赖注入

- 通过构造函数注入依赖
- 使用接口而非具体实现
- 尽量避免循环依赖

### 错误处理

- 使用 NestJS 内置的异常系统
- 定义明确的错误类型
- 集中处理异常

## 扩展指南

当需要添加新功能时，请遵循以下步骤：

- 确定新功能属于哪个业务领域，在对应模块中实现，或创建新模块
- 按照分层架构设计代码结构
- 定义清晰的 API 接口和数据模型
- 编写完整的单元测试
- 更新相关文档

## 总结

本项目是一个专注于付费阅读功能的后端服务，结构简洁明了。通过用户模块管理用户账户，认证模块处理登录验证，授权码模块控制付费内容访问。项目遵循 NestJS 最佳实践，采用清晰的分层架构，确保代码的可维护性和可扩展性。
