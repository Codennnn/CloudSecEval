# 用户列表搜索指南

## 概述

用户列表查询接口 `GET /users` 提供了强大的高级搜索功能，支持多种搜索模式、操作符和筛选条件。本指南详细介绍如何使用这些功能进行精确的用户数据查询。

## 🎯 基础搜索参数

### 全局搜索

在姓名、邮箱、手机号中搜索关键词：

```bash
# 搜索包含 "leoku" 的用户
GET /users?search=leoku

# 搜索包含邮箱关键词的用户
GET /users?search=admin@example.com

# 搜索包含手机号的用户
GET /users?search=138
```

### 字段精确搜索

针对特定字段进行搜索：

```bash
# 单字段搜索
GET /users?name=张三
GET /users?email=admin@example.com
GET /users?phone=13800138000

# 多字段组合搜索（AND 操作，默认）
GET /users?name=张&email=admin

# 多字段组合搜索（OR 操作）
GET /users?name=张&email=admin&operator=or
```

## 🚀 高级搜索操作符

### 字符串字段操作符

适用于 `name`、`email`、`phone` 字段：

#### 基础匹配

```bash
# 等于
GET /users?name[eq]=张三

# 不等于
GET /users?name[neq]=管理员

# 包含子字符串
GET /users?name[contains]=张
GET /users?email[contains]=@company.com

# 以...开始
GET /users?name[startsWith]=李
GET /users?email[startsWith]=admin

# 以...结束
GET /users?name[endsWith]=三
GET /users?email[endsWith]=@gmail.com
```

#### 高级匹配

```bash
# 正则表达式匹配
GET /users?email[regex]=.*@(gmail|qq)\.com
GET /users?phone[regex]=^1[3-9]\d{9}$

# 不区分大小写匹配
GET /users?name[ilike]=ADMIN
GET /users?email[ilike]=TEST@EXAMPLE.COM
```

#### 数组操作

```bash
# 包含（数组）
GET /users?name[in]=张三,李四,王五
GET /users?email[in]=admin@test.com,user@test.com

# 不包含（数组）
GET /users?name[notIn]=测试用户,临时用户
```

#### 空值判断

```bash
# 字段为空
GET /users?phone[isNull]=true

# 字段不为空
GET /users?phone[isNotNull]=true
```

### 布尔字段操作符

适用于 `isActive` 字段：

```bash
# 基础布尔搜索
GET /users?isActive=true
GET /users?isActive=false

# 高级布尔操作符
GET /users?isActive[eq]=true
GET /users?isActive[neq]=false

# 空值判断
GET /users?isActive[isNull]=true
GET /users?isActive[isNotNull]=true
```

### 日期字段操作符

适用于 `createdAt`、`updatedAt` 字段：

#### 日期比较

```bash
# 大于等于
GET /users?createdAt[gte]=2024-01-01
GET /users?createdAt[gte]=2024-01-01T00:00:00Z

# 小于等于
GET /users?createdAt[lte]=2024-12-31
GET /users?updatedAt[lte]=2024-12-31T23:59:59Z

# 大于
GET /users?updatedAt[gt]=2024-06-01T00:00:00Z

# 小于
GET /users?createdAt[lt]=2024-06-01
```

#### 日期范围

```bash
# 范围查询（包含边界）
GET /users?createdAt[between]=2024-01-01,2024-12-31
GET /users?updatedAt[between]=2024-06-01T00:00:00Z,2024-06-30T23:59:59Z
```

#### 日期精确匹配

```bash
# 等于
GET /users?createdAt[eq]=2024-01-15
GET /users?createdAt[eq]=2024-01-15T10:30:00Z

# 不等于
GET /users?updatedAt[neq]=2024-01-01
```

## 📊 搜索模式

系统支持智能搜索模式判断，也可手动指定：

### 智能判断（推荐）

```bash
# 自动使用全局搜索
GET /users?search=admin

# 自动使用精确搜索
GET /users?name=张三

# 自动使用组合搜索
GET /users?search=admin&name=张

# 自动使用高级搜索
GET /users?name[contains]=张
```

### 手动指定搜索模式

```bash
# 全局搜索模式
GET /users?search=admin&searchMode=global

# 精确搜索模式
GET /users?name=张三&searchMode=exact

# 组合搜索模式
GET /users?search=admin&name=张&searchMode=combined

# 高级搜索模式
GET /users?name[regex]=^A.*&searchMode=advanced
```

### 搜索模式说明

- **global**: 在姓名、邮箱、手机号中进行模糊匹配
- **exact**: 只在指定字段中进行搜索
- **combined**: 全局搜索与字段搜索的智能组合
- **advanced**: 使用操作符进行复杂条件查询

## 🔄 排序功能

### 单字段排序

```bash
# 按姓名升序
GET /users?sortBy=name&sortOrder=asc

# 按创建时间降序（默认）
GET /users?sortBy=createdAt&sortOrder=desc

# 按邮箱升序
GET /users?sortBy=email&sortOrder=asc

# 按更新时间降序
GET /users?sortBy=updatedAt&sortOrder=desc
```

### 多字段排序

```bash
# 先按姓名升序，再按创建时间降序
GET /users?sortBy=[{"field":"name","order":"asc"},{"field":"createdAt","order":"desc"}]

# 先按活跃状态降序，再按姓名升序，最后按创建时间降序
GET /users?sortBy=[{"field":"isActive","order":"desc"},{"field":"name","order":"asc"},{"field":"createdAt","order":"desc"}]

# 多字段排序结合搜索
GET /users?search=admin&sortBy=[{"field":"email","order":"asc"},{"field":"updatedAt","order":"desc"}]
```

### 排序参数格式

#### 单字段格式

- `sortBy`: 字段名（字符串）
- `sortOrder`: `asc`（升序）或 `desc`（降序）

#### 多字段格式

- `sortBy`: JSON 字符串数组，格式：`[{"field":"字段名","order":"排序方向"}]`
- 排序优先级：数组中越靠前的字段优先级越高

### 支持的排序字段

- `name`: 用户姓名
- `email`: 邮箱地址
- `phone`: 手机号码
- `isActive`: 活跃状态
- `createdAt`: 创建时间（默认）
- `updatedAt`: 更新时间

### 排序方向

- `asc`: 升序
- `desc`: 降序（默认）

## 📄 分页参数

```bash
# 基础分页
GET /users?page=1&pageSize=10

# 大页面
GET /users?page=2&pageSize=20

# 搜索 + 分页
GET /users?search=admin&page=1&pageSize=10

# 高级搜索 + 分页
GET /users?name[contains]=张&isActive=true&page=1&pageSize=15
```

### 分页参数说明

- `page`: 页码，从 1 开始（默认：1）
- `pageSize`: 每页数量（默认：10）

## 🎯 复杂查询示例

### 综合查询

```bash
# 复杂组合查询
GET /users?search=admin&name[startsWith]=张&email[contains]=@company.com&isActive=true&createdAt[gte]=2024-01-01&sortBy=createdAt&sortOrder=desc&page=1&pageSize=20
```

### 实际业务场景

#### 查找特定时间段注册的活跃用户

```bash
GET /users?createdAt[between]=2024-01-01,2024-06-30&isActive=true&sortBy=name&sortOrder=asc
```

#### 查找邮箱符合特定模式的用户

```bash
GET /users?email[regex]=.*@(gmail|qq)\.com&isActive=true&sortBy=createdAt&sortOrder=desc
```

#### 查找最近更新的用户

```bash
GET /users?updatedAt[gte]=2024-11-01&sortBy=updatedAt&sortOrder=desc&pageSize=20
```

#### 查找姓名包含特定字符的非活跃用户

```bash
GET /users?name[contains]=测试&isActive=false&sortBy=createdAt&sortOrder=asc
```

#### 查找手机号为空的用户

```bash
GET /users?phone[isNull]=true&sortBy=createdAt&sortOrder=desc
```

#### 查找特定邮箱域名的用户

```bash
GET /users?email[endsWith]=@company.com&isActive=true&createdAt[gte]=2024-01-01
```

#### 多字段排序的复杂查询示例

```bash
# 查找活跃用户，按状态、姓名、创建时间多重排序
GET /users?isActive=true&sortBy=[{"field":"isActive","order":"desc"},{"field":"name","order":"asc"},{"field":"createdAt","order":"desc"}]

# 搜索特定关键词的用户，按邮箱和更新时间排序
GET /users?search=admin&sortBy=[{"field":"email","order":"asc"},{"field":"updatedAt","order":"desc"}]

# 日期范围查询，按多字段排序
GET /users?createdAt[between]=2024-01-01,2024-06-30&sortBy=[{"field":"updatedAt","order":"desc"},{"field":"name","order":"asc"}]

# 复杂条件组合查询，多字段排序
GET /users?name[contains]=张&email[endsWith]=@company.com&isActive=true&sortBy=[{"field":"phone","order":"asc"},{"field":"createdAt","order":"desc"}]&page=1&pageSize=20
```

## 📋 响应格式

### 成功响应

```json
{
  "data": [
    {
      "id": "uuid",
      "name": "leoku",
      "email": "leoku@example.com",
      "phone": "13800138000",
      "isActive": true,
      "createdAt": "2023-01-01T00:00:00.000Z",
      "updatedAt": "2023-01-01T00:00:00.000Z"
    }
  ],
  "pagination": {
    "total": 1,
    "page": 1,
    "pageSize": 10,
    "totalPages": 1,
    "hasNextPage": false,
    "hasPrevPage": false
  }
}
```

### 响应字段说明

#### 用户数据字段

- `id`: 用户唯一标识
- `name`: 用户姓名
- `email`: 邮箱地址
- `phone`: 手机号码
- `isActive`: 用户状态（true: 活跃，false: 非活跃）
- `createdAt`: 创建时间
- `updatedAt`: 更新时间

#### 分页信息字段

- `total`: 总记录数
- `page`: 当前页码
- `pageSize`: 每页数量
- `totalPages`: 总页数
- `hasNextPage`: 是否有下一页
- `hasPrevPage`: 是否有上一页

## 💡 使用建议

### 性能优化

1. **使用分页**：避免返回过多数据，建议 `pageSize` 不超过 50
2. **索引友好查询**：优先使用等于、包含等索引友好的操作符
3. **合理使用正则**：正则表达式查询性能较低，谨慎使用
4. **日期范围限制**：避免过大的日期范围查询

### 搜索策略

1. **智能搜索**：让系统自动判断搜索模式，无需手动指定
2. **组合查询**：合理组合不同字段和操作符实现精确筛选
3. **渐进式搜索**：从宽泛条件开始，逐步添加筛选条件
4. **缓存友好**：相同的查询条件可以利用缓存提升性能

### 错误处理

1. **参数验证**：确保日期格式正确，数值范围合理
2. **操作符使用**：注意不同字段类型支持的操作符
3. **分页边界**：注意页码和页面大小的合理范围
4. **正则表达式**：确保正则表达式语法正确

## 🔧 技术实现

### 相关文件

- **Controller**: `src/modules/users/users.controller.ts`
- **Service**: `src/modules/users/users.service.ts`
- **Repository**: `src/modules/users/users.repository.ts`
- **DTO**: `src/modules/users/dto/find-users.dto.ts`
- **搜索构建器**: `src/modules/users/utils/advanced-user-search-builder.util.ts`

### 搜索框架

本功能基于通用的高级搜索框架实现，支持：

- 类型安全的操作符
- 智能搜索模式判断
- 可扩展的字段配置
- 高性能的查询构建

### 扩展功能

如需添加新的搜索字段或操作符，可以：

1. 在 `FindUsersDto` 中添加新字段
2. 在 `USER_FIELD_CONFIG` 中配置字段属性
3. 系统会自动支持新字段的搜索功能

---

通过这些高级搜索功能，你可以实现非常灵活和强大的用户数据筛选和查询。如有疑问，请参考相关代码实现或联系开发团队。
