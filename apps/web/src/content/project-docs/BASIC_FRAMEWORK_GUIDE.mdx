# React Query + åŸç”Ÿ fetch åŸºç¡€æ¡†æ¶æŒ‡å—

## ğŸ¯ æ¡†æ¶æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªä¸ºæ‚¨çš„é¡¹ç›®æä¾›çš„è½»é‡çº§ã€ç±»å‹å®‰å…¨çš„ API ç®¡ç†åŸºç¡€æ¡†æ¶ã€‚è¯¥æ¡†æ¶ä¸“æ³¨äºæä¾›æ ¸å¿ƒåŠŸèƒ½ï¼Œè€Œä¸åŒ…å«å…·ä½“çš„ä¸šåŠ¡æ¥å£å®ç°ã€‚

## ğŸ“ æ ¸å¿ƒæ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ lib/api/
â”‚   â”œâ”€â”€ client.ts          # æ ¸å¿ƒ fetch å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ config.ts          # ç¯å¢ƒé…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ types.ts           # API åŸºç¡€ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ endpoints.ts       # API ç«¯ç‚¹é…ç½®æ¡†æ¶
â”œâ”€â”€ hooks/api/
â”‚   â””â”€â”€ index.ts           # API hooks å¯¼å‡ºå…¥å£
â”œâ”€â”€ providers/
â”‚   â””â”€â”€ QueryProvider.tsx  # React Query æä¾›è€…
â””â”€â”€ app/
    â””â”€â”€ layout.tsx         # å·²é›†æˆ QueryProvider
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. HTTP å®¢æˆ·ç«¯ (`src/lib/api/client.ts`)

æä¾›äº†å®Œæ•´çš„ fetch å°è£…ï¼ŒåŒ…å«ï¼š

- âœ… **è‡ªåŠ¨é‡è¯•æœºåˆ¶**ï¼šæŒ‡æ•°é€€é¿ç­–ç•¥
- âœ… **è¶…æ—¶æ§åˆ¶**ï¼šå¯é…ç½®çš„è¯·æ±‚è¶…æ—¶
- âœ… **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„é”™è¯¯æ ¼å¼å’Œæç¤º
- âœ… **ç±»å‹å®‰å…¨**ï¼šå®Œæ•´çš„ TypeScript æ”¯æŒ
- âœ… **å¼€å‘æ—¥å¿—**ï¼šå¯é…ç½®çš„è¯·æ±‚æ—¥å¿—è®°å½•

#### åŸºæœ¬ä½¿ç”¨

```typescript
import { api } from '~/lib/api/client'

// GET è¯·æ±‚
const data = await api.get<ResponseType>('/your-endpoint')

// POST è¯·æ±‚
const result = await api.post<ResponseType>('/your-endpoint', {
  // è¯·æ±‚æ•°æ®
})

// PUT è¯·æ±‚
const updated = await api.put<ResponseType>('/your-endpoint/id', {
  // æ›´æ–°æ•°æ®
})

// DELETE è¯·æ±‚
await api.delete('/your-endpoint/id')
```

#### é…ç½®é€‰é¡¹

```typescript
const response = await api.get('/endpoint', {
  timeout: 5000, // è¶…æ—¶æ—¶é—´
  retries: 2, // é‡è¯•æ¬¡æ•°
  showError: false, // æ˜¯å¦æ˜¾ç¤ºé”™è¯¯æç¤º
  headers: {
    // è‡ªå®šä¹‰è¯·æ±‚å¤´
    Authorization: 'Bearer token',
  },
})
```

### 2. ç¯å¢ƒé…ç½® (`src/lib/api/config.ts`)

æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®è¦†ç›–ï¼š

#### é…ç½®é¡¹

```typescript
interface ApiConfig {
  timeout: number // è¯·æ±‚è¶…æ—¶æ—¶é—´
  retries: number // é‡è¯•æ¬¡æ•°
  retryDelay: number // é‡è¯•å»¶è¿Ÿ
  maxRetryDelay: number // æœ€å¤§é‡è¯•å»¶è¿Ÿ
  enableDevtools: boolean // æ˜¯å¦å¯ç”¨å¼€å‘å·¥å…·
  enableLogging: boolean // æ˜¯å¦å¯ç”¨æ—¥å¿—
  enableCache: boolean // æ˜¯å¦å¯ç”¨ç¼“å­˜
  cacheTime: number // ç¼“å­˜æ—¶é—´
  staleTime: number // æ•°æ®æ–°é²œåº¦æ—¶é—´
}
```

#### ç¯å¢ƒå˜é‡æ”¯æŒ

æ‰€æœ‰é…ç½®é¡¹éƒ½å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–ï¼š

```bash
# API åŸºç¡€é…ç½®
NEXT_PUBLIC_API_BASE=http://localhost:3001
NEXT_PUBLIC_API_TIMEOUT=10000
NEXT_PUBLIC_API_RETRIES=3
NEXT_PUBLIC_API_RETRY_DELAY=1000
NEXT_PUBLIC_API_MAX_RETRY_DELAY=30000

# åŠŸèƒ½å¼€å…³
NEXT_PUBLIC_ENABLE_REACT_QUERY_DEVTOOLS=true
NEXT_PUBLIC_ENABLE_API_LOGGING=true
NEXT_PUBLIC_ENABLE_CACHE=true

# ç¼“å­˜é…ç½®
NEXT_PUBLIC_QUERY_CACHE_TIME=1800000  # 30åˆ†é’Ÿ
NEXT_PUBLIC_QUERY_STALE_TIME=300000   # 5åˆ†é’Ÿ
```

### 3. React Query é›†æˆ (`src/providers/QueryProvider.tsx`)

æä¾›äº†å®Œæ•´çš„ React Query é…ç½®ï¼š

- âœ… **æ™ºèƒ½ç¼“å­˜**ï¼šåŸºäºé…ç½®çš„ç¼“å­˜ç­–ç•¥
- âœ… **æŸ¥è¯¢é”®å·¥å‚**ï¼šç»“æ„åŒ–çš„æŸ¥è¯¢é”®ç®¡ç†
- âœ… **å¼€å‘å·¥å…·**ï¼šå¯é…ç½®çš„ DevTools
- âœ… **é”™è¯¯é‡è¯•**ï¼šæ™ºèƒ½çš„é‡è¯•æœºåˆ¶

#### æŸ¥è¯¢é”®å·¥å‚

```typescript
export const queryKeys = {
  // ç¤ºä¾‹ç»“æ„
  resource: {
    all: ['resource'] as const,
    lists: () => [...queryKeys.resource.all, 'list'] as const,
    list: (params?: Record<string, unknown>) =>
      [...queryKeys.resource.lists(), params] as const,
    details: () => [...queryKeys.resource.all, 'detail'] as const,
    detail: (id: string) => [...queryKeys.resource.details(), id] as const,
  },
}
```

## ğŸš€ å¦‚ä½•æ‰©å±•

### 1. å®šä¹‰ä¸šåŠ¡ç±»å‹

åœ¨ `src/lib/api/types.ts` ä¸­æ·»åŠ æ‚¨çš„ä¸šåŠ¡ç±»å‹ï¼š

```typescript
// ç¤ºä¾‹ï¼šç”¨æˆ·ç±»å‹
export interface User {
  id: string
  username: string
  email: string
  // ... å…¶ä»–å­—æ®µ
}

// ç¤ºä¾‹ï¼šæ–‡æ¡£ç±»å‹
export interface Document {
  id: string
  title: string
  content: string
  // ... å…¶ä»–å­—æ®µ
}

// ç¤ºä¾‹ï¼šæŸ¥è¯¢å‚æ•°ç±»å‹
export interface UserQueryParams extends QueryParams {
  role?: string
  status?: string
}
```

### 2. å®šä¹‰ API ç«¯ç‚¹

åœ¨ `src/lib/api/endpoints.ts` ä¸­æ·»åŠ æ‚¨çš„ç«¯ç‚¹ï¼š

```typescript
export const USER_ENDPOINTS = {
  LIST: '/users',
  DETAIL: (id: string) => `/users/${id}`,
  CREATE: '/users',
  UPDATE: (id: string) => `/users/${id}`,
  DELETE: (id: string) => `/users/${id}`,
} as const

export const API_ENDPOINTS = {
  USER: USER_ENDPOINTS,
  // ... å…¶ä»–ç«¯ç‚¹
} as const
```

### 3. åˆ›å»º React Query Hooks

åˆ›å»º `src/hooks/api/useUsers.ts`ï¼š

```typescript
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'
import { api } from '~/lib/api/client'
import { USER_ENDPOINTS } from '~/lib/api/endpoints'
import type { User, UserQueryParams } from '~/lib/api/types'

// å®šä¹‰æŸ¥è¯¢é”®
const queryKeys = {
  users: {
    all: ['users'] as const,
    lists: () => [...queryKeys.users.all, 'list'] as const,
    list: (params?: Record<string, unknown>) =>
      [...queryKeys.users.lists(), params] as const,
    details: () => [...queryKeys.users.all, 'detail'] as const,
    detail: (id: string) => [...queryKeys.users.details(), id] as const,
  },
}

// æŸ¥è¯¢ Hook
export function useUsers(params?: UserQueryParams) {
  return useQuery({
    queryKey: queryKeys.users.list(params),
    queryFn: () =>
      api.get<PaginatedResponse<User>>(USER_ENDPOINTS.LIST, {
        params: new URLSearchParams(params as Record<string, string>),
      }),
  })
}

export function useUser(id: string, enabled = true) {
  return useQuery({
    queryKey: queryKeys.users.detail(id),
    queryFn: () => api.get<User>(USER_ENDPOINTS.DETAIL(id)),
    enabled: enabled && !!id,
  })
}

// å˜æ›´ Hook
export function useCreateUser() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: (userData: CreateUserRequest) =>
      api.post<User>(USER_ENDPOINTS.CREATE, userData),
    onSuccess: () => {
      queryClient.invalidateQueries({
        queryKey: queryKeys.users.lists(),
      })
    },
  })
}
```

### 4. å¯¼å‡º Hooks

åœ¨ `src/hooks/api/index.ts` ä¸­å¯¼å‡ºï¼š

```typescript
export { useUsers, useUser, useCreateUser } from './useUsers'
export type { User, UserQueryParams } from '~/lib/api/types'
```

### 5. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

```tsx
import { useUsers, useCreateUser } from '~/hooks/api/useUsers'

function UserManagement() {
  const { data: users, isLoading, error } = useUsers({ page: 1 })
  const createUser = useCreateUser()

  if (isLoading) return <div>åŠ è½½ä¸­...</div>
  if (error) return <div>åŠ è½½å¤±è´¥ï¼š{error.message}</div>

  return (
    <div>
      {users?.data.map((user) => (
        <div key={user.id}>{user.username}</div>
      ))}
      <button
        onClick={() =>
          createUser.mutateAsync({
            /* ç”¨æˆ·æ•°æ® */
          })
        }
        disabled={createUser.isPending}
      >
        åˆ›å»ºç”¨æˆ·
      </button>
    </div>
  )
}
```

## âš™ï¸ ç¯å¢ƒé…ç½®

### ç¯å¢ƒå˜é‡

åˆ›å»º `.env.local` æ–‡ä»¶ï¼š

```bash
# API é…ç½®
NEXT_PUBLIC_API_BASE=http://localhost:3001

# å¼€å‘å·¥å…·
NEXT_PUBLIC_ENABLE_REACT_QUERY_DEVTOOLS=true
NEXT_PUBLIC_ENABLE_API_LOGGING=true

# ç¼“å­˜é…ç½®
NEXT_PUBLIC_QUERY_CACHE_TIME=1800000  # 30åˆ†é’Ÿ
NEXT_PUBLIC_QUERY_STALE_TIME=300000   # 5åˆ†é’Ÿ
```

### é…ç½®è°ƒè¯•

åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œé…ç½®ä¿¡æ¯ä¼šè‡ªåŠ¨æ‰“å°åˆ°æ§åˆ¶å°ï¼š

```typescript
import { debugApiConfig } from '~/lib/api/config'

// æ‰‹åŠ¨æ‰“å°é…ç½®ä¿¡æ¯
debugApiConfig()
```

## ğŸ§ª æµ‹è¯•æ”¯æŒ

### Mock API å®¢æˆ·ç«¯

```typescript
// __tests__/setup.ts
import { vi } from 'vitest'

vi.mock('~/lib/api/client', () => ({
  api: {
    get: vi.fn(),
    post: vi.fn(),
    put: vi.fn(),
    delete: vi.fn(),
  },
}))
```

### æµ‹è¯• Hooks

```typescript
import { renderHook, waitFor } from '@testing-library/react'
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'

function createWrapper() {
  const queryClient = new QueryClient({
    defaultOptions: { queries: { retry: false } }
  })

  return ({ children }) => (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  )
}

describe('useUsers', () => {
  it('should fetch users successfully', async () => {
    const mockUsers = [{ id: '1', username: 'john' }]
    api.get.mockResolvedValue({ data: mockUsers })

    const { result } = renderHook(() => useUsers(), {
      wrapper: createWrapper()
    })

    await waitFor(() => {
      expect(result.current.isSuccess).toBe(true)
    })

    expect(result.current.data?.data).toEqual(mockUsers)
  })
})
```

## ğŸ”„ æœ€ä½³å®è·µ

### 1. æŸ¥è¯¢é”®ç®¡ç†

```typescript
// âœ… æ¨èï¼šä½¿ç”¨æŸ¥è¯¢é”®å·¥å‚
const { data } = useQuery({
  queryKey: queryKeys.users.detail(userId),
  queryFn: () => api.get(`/users/${userId}`),
})

// âŒ ä¸æ¨èï¼šç¡¬ç¼–ç æŸ¥è¯¢é”®
const { data } = useQuery({
  queryKey: ['user', userId],
  queryFn: () => api.get(`/users/${userId}`),
})
```

### 2. é”™è¯¯å¤„ç†

```tsx
function DataComponent() {
  const { data, error, isError, refetch } = useCustomData()

  if (isError) {
    return (
      <div>
        <p>åŠ è½½å¤±è´¥ï¼š{error?.message}</p>
        <button onClick={() => refetch()}>é‡è¯•</button>
      </div>
    )
  }

  return <DataDisplay data={data} />
}
```

### 3. ç¼“å­˜ä¼˜åŒ–

```typescript
// ä¹è§‚æ›´æ–°
const updateMutation = useMutation({
  mutationFn: updateData,
  onMutate: async (newData) => {
    // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æŸ¥è¯¢
    await queryClient.cancelQueries({ queryKey: queryKeys.data.detail(id) })

    // è·å–å½“å‰æ•°æ®
    const previousData = queryClient.getQueryData(queryKeys.data.detail(id))

    // ä¹è§‚æ›´æ–°
    queryClient.setQueryData(queryKeys.data.detail(id), newData)

    return { previousData }
  },
  onError: (err, newData, context) => {
    // å›æ»š
    queryClient.setQueryData(queryKeys.data.detail(id), context?.previousData)
  },
  onSettled: () => {
    // é‡æ–°è·å–æ•°æ®
    queryClient.invalidateQueries({ queryKey: queryKeys.data.detail(id) })
  },
})
```

## ğŸ“š æ‰©å±•å»ºè®®

1. **è®¤è¯ç®¡ç†**ï¼šæ·»åŠ  JWT ä»¤ç‰Œç®¡ç†å’Œè‡ªåŠ¨åˆ·æ–°
2. **æ–‡ä»¶ä¸Šä¼ **ï¼šå®ç°æ–‡ä»¶ä¸Šä¼ ç›¸å…³çš„ hooks
3. **å®æ—¶æ›´æ–°**ï¼šé›†æˆ WebSocket æˆ– Server-Sent Events
4. **ç¦»çº¿æ”¯æŒ**ï¼šæ·»åŠ  PWA åŠŸèƒ½å’Œç¦»çº¿ç¼“å­˜
5. **æ€§èƒ½ç›‘æ§**ï¼šé›†æˆæ€§èƒ½ç›‘æ§å’Œé”™è¯¯è¿½è¸ª

## ğŸ‰ æ€»ç»“

è¿™ä¸ªåŸºç¡€æ¡†æ¶ä¸ºæ‚¨æä¾›äº†ï¼š

- âœ… **å®Œæ•´çš„ç±»å‹å®‰å…¨**ï¼šTypeScript å…¨é¢æ”¯æŒ
- âœ… **çµæ´»çš„é…ç½®**ï¼šå¤šç¯å¢ƒé…ç½®æ”¯æŒ
- âœ… **å¼ºå¤§çš„ç¼“å­˜**ï¼šæ™ºèƒ½çš„æ•°æ®ç¼“å­˜ç­–ç•¥
- âœ… **ä¼˜ç§€çš„å¼€å‘ä½“éªŒ**ï¼šä¸°å¯Œçš„å¼€å‘å·¥å…·
- âœ… **å¯æ‰©å±•æ¶æ„**ï¼šæ˜“äºæ·»åŠ æ–°åŠŸèƒ½

æ‚¨ç°åœ¨å¯ä»¥åŸºäºè¿™ä¸ªæ¡†æ¶å¿«é€Ÿå¼€å‘æ‚¨çš„ API ç®¡ç†å±‚ï¼Œåªéœ€è¦æ·»åŠ å…·ä½“çš„ä¸šåŠ¡é€»è¾‘å³å¯ï¼
