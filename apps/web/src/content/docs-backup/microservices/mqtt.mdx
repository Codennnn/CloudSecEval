### MQTTï¼ˆæ¶ˆæ¯é˜Ÿåˆ—é¥æµ‹ä¼ è¾“åè®®ï¼‰

[MQTT](https://mqtt.org/) æ˜¯ä¸€ç§å¼€æºã€è½»é‡çº§çš„æ¶ˆæ¯åè®®ï¼Œä¸“ä¸ºä½å»¶è¿Ÿåœºæ™¯ä¼˜åŒ–ã€‚è¯¥åè®®é€šè¿‡**å‘å¸ƒ/è®¢é˜…ï¼ˆpublish/subscribeï¼‰**æ¨¡å‹ï¼Œä¸ºè®¾å¤‡é—´è¿æ¥æä¾›äº†å¯æ‰©å±•ä¸”é«˜æ€§ä»·æ¯”çš„è§£å†³æ–¹æ¡ˆã€‚åŸºäº MQTT çš„é€šä¿¡ç³»ç»Ÿé€šå¸¸ç”±å‘å¸ƒæœåŠ¡å™¨ã€ä»£ç†ï¼ˆBrokerï¼‰ä»¥åŠä¸€ä¸ªæˆ–å¤šä¸ªå®¢æˆ·ç«¯ç»„æˆã€‚MQTT ä¸“ä¸ºå—é™è®¾å¤‡å’Œä½å¸¦å®½ã€é«˜å»¶è¿Ÿæˆ–ä¸ç¨³å®šç½‘ç»œç¯å¢ƒè®¾è®¡ã€‚

#### å®‰è£…

è¦å¼€å§‹æ„å»ºåŸºäº MQTT çš„å¾®æœåŠ¡ï¼Œè¯·å…ˆå®‰è£…æ‰€éœ€ä¾èµ–åŒ…ï¼š

```bash
$ npm i --save mqtt
```

#### æ¦‚è¿°

è¦ä½¿ç”¨ MQTT ä¼ è¾“å±‚ï¼Œè¯·å°†å¦‚ä¸‹ options å¯¹è±¡ä¼ é€’ç»™ `createMicroservice()` æ–¹æ³•ï¼š

```typescript
@@filename(main)
const app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {
  transport: Transport.MQTT,
  options: {
    url: 'mqtt://localhost:1883',
  },
});
@@switch
const app = await NestFactory.createMicroservice(AppModule, {
  transport: Transport.MQTT,
  options: {
    url: 'mqtt://localhost:1883',
  },
});
```

> info **æç¤º** `Transport` æšä¸¾ç±»å‹éœ€ä» `@nestjs/microservices` åŒ…ä¸­å¯¼å…¥ã€‚

#### é…ç½®é¡¹

`options` å¯¹è±¡æ˜¯é’ˆå¯¹æ‰€é€‰ä¼ è¾“å±‚ï¼ˆTransporterï¼‰å®šåˆ¶çš„ã€‚<strong>MQTT</strong> ä¼ è¾“å±‚æ”¯æŒçš„å±æ€§è¯¦è§[æ­¤å¤„](https://github.com/mqttjs/MQTT.js/#mqttclientstreambuilder-options)ã€‚

#### å®¢æˆ·ç«¯ï¼ˆClientï¼‰

ä¸å…¶ä»–å¾®æœåŠ¡ä¼ è¾“å™¨ç±»ä¼¼ï¼Œä½ æœ‰å¤šç§æ–¹å¼å¯ä»¥åˆ›å»º MQTT `ClientProxy` å®ä¾‹ï¼Œè¯¦è§ <a href="https://docs.nestjs.com/microservices/basics#client">å®˜æ–¹æ–‡æ¡£</a>ã€‚

å…¶ä¸­ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨ `ClientsModule`ã€‚è¦é€šè¿‡ `ClientsModule` åˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹ï¼Œéœ€è¦å…ˆå¯¼å…¥è¯¥æ¨¡å—ï¼Œå¹¶ä½¿ç”¨ `register()` æ–¹æ³•ä¼ å…¥ä¸€ä¸ªé…ç½®å¯¹è±¡ã€‚è¯¥å¯¹è±¡çš„å±æ€§ä¸ä¸Šæ–‡ `createMicroservice()` æ–¹æ³•ä¸­å±•ç¤ºçš„å±æ€§ä¸€è‡´ï¼Œå¹¶ä¸”éœ€è¦é¢å¤–æŒ‡å®šä¸€ä¸ª `name` å±æ€§ä½œä¸ºæ³¨å…¥ä»¤ç‰Œã€‚è¯¦ç»†å†…å®¹å¯å‚è€ƒ <a href="https://docs.nestjs.com/microservices/basics#client">è¿™é‡Œ</a>ã€‚

```typescript
@Module({
  imports: [
    ClientsModule.register([
      {
        name: 'MATH_SERVICE',
        transport: Transport.MQTT,
        options: {
          url: 'mqtt://localhost:1883',
        }
      },
    ]),
  ]
  ...
})
```

ä½ ä¹Ÿå¯ä»¥é€‰æ‹©å…¶ä»–æ–¹å¼æ¥åˆ›å»ºå®¢æˆ·ç«¯ï¼Œä¾‹å¦‚ä½¿ç”¨ `ClientProxyFactory` æˆ– `@Client()` è£…é¥°å™¨ã€‚ç›¸å…³å†…å®¹å¯åœ¨ <a href="https://docs.nestjs.com/microservices/basics#client">è¿™é‡Œ</a> æŸ¥é˜…ã€‚

#### ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰

åœ¨æ›´å¤æ‚çš„åœºæ™¯ä¸‹ï¼Œä½ å¯èƒ½éœ€è¦è®¿é—®æœ‰å…³ä¼ å…¥è¯·æ±‚çš„æ›´å¤šä¿¡æ¯ã€‚ä½¿ç”¨ MQTT ä¼ è¾“å™¨æ—¶ï¼Œå¯ä»¥é€šè¿‡ `MqttContext` å¯¹è±¡è·å–è¿™äº›ä¿¡æ¯ã€‚

```typescript
@@filename()
@MessagePattern('notifications')
getNotifications(@Payload() data: number[], @Ctx() context: MqttContext) {
  console.log(`Topic: ${context.getTopic()}`);
}
@@switch
@Bind(Payload(), Ctx())
@MessagePattern('notifications')
getNotifications(data, context) {
  console.log(`Topic: ${context.getTopic()}`);
}
```

> info **æç¤º** `@Payload()`ã€`@Ctx()` ä»¥åŠ `MqttContext` éƒ½éœ€è¦ä» `@nestjs/microservices` åŒ…ä¸­å¯¼å…¥ã€‚

å¦‚æœä½ éœ€è¦è®¿é—®åŸå§‹çš„ mqtt [æ•°æ®åŒ…ï¼ˆpacketï¼‰](https://github.com/mqttjs/mqtt-packet)ï¼Œå¯ä»¥é€šè¿‡ `MqttContext` å¯¹è±¡çš„ `getPacket()` æ–¹æ³•å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```typescript
@@filename()
@MessagePattern('notifications')
getNotifications(@Payload() data: number[], @Ctx() context: MqttContext) {
  console.log(context.getPacket());
}
@@switch
@Bind(Payload(), Ctx())
@MessagePattern('notifications')
getNotifications(data, context) {
  console.log(context.getPacket());
}
```

#### é€šé…ç¬¦ï¼ˆWildcardsï¼‰

è®¢é˜…å¯ä»¥æ˜¯æŸä¸ªæ˜ç¡®çš„ä¸»é¢˜ï¼ˆtopicï¼‰ï¼Œä¹Ÿå¯ä»¥åŒ…å«é€šé…ç¬¦ã€‚MQTT åè®®ä¸­æœ‰ä¸¤ç§é€šé…ç¬¦ï¼š`+` å’Œ `#`ã€‚å…¶ä¸­ï¼Œ`+` æ˜¯å•å±‚é€šé…ç¬¦ï¼Œè¡¨ç¤ºåŒ¹é…å•ä¸ªä¸»é¢˜å±‚çº§ï¼›è€Œ `#` æ˜¯å¤šå±‚é€šé…ç¬¦ï¼Œå¯ä»¥åŒ¹é…å¤šä¸ªä¸»é¢˜å±‚çº§ã€‚

```typescript
@@filename()
@MessagePattern('sensors/+/temperature/+')
getTemperature(@Ctx() context: MqttContext) {
  console.log(`Topic: ${context.getTopic()}`);
}
@@switch
@Bind(Ctx())
@MessagePattern('sensors/+/temperature/+')
getTemperature(context) {
  console.log(`Topic: ${context.getTopic()}`);
}
```

#### æœåŠ¡è´¨é‡ï¼ˆQuality of Serviceï¼ŒQoSï¼‰

é€šè¿‡ `@MessagePattern` æˆ– `@EventPattern` è£…é¥°å™¨åˆ›å»ºçš„ä»»ä½•è®¢é˜…ï¼Œé»˜è®¤ä½¿ç”¨ QoS 0ã€‚å¦‚æœéœ€è¦æ›´é«˜çš„ QoSï¼Œå¯ä»¥åœ¨å»ºç«‹è¿æ¥æ—¶é€šè¿‡ `subscribeOptions` å…¨å±€è®¾ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```typescript
@@filename(main)
const app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {
  transport: Transport.MQTT,
  options: {
    url: 'mqtt://localhost:1883',
    subscribeOptions: {
      qos: 2
    },
  },
});
@@switch
const app = await NestFactory.createMicroservice(AppModule, {
  transport: Transport.MQTT,
  options: {
    url: 'mqtt://localhost:1883',
    subscribeOptions: {
      qos: 2
    },
  },
});
```

å¦‚æœéœ€è¦é’ˆå¯¹æŸä¸ªä¸»é¢˜è®¾ç½®ç‰¹å®šçš„ QoSï¼Œå»ºè®®å®ç°[è‡ªå®šä¹‰ä¼ è¾“å™¨](https://docs.nestjs.com/microservices/custom-transport)ã€‚

#### æ¶ˆæ¯è®°å½•æ„å»ºå™¨ï¼ˆRecord buildersï¼‰

è¦é…ç½®æ¶ˆæ¯é€‰é¡¹ï¼ˆå¦‚è°ƒæ•´ QoS ç­‰çº§ã€è®¾ç½® Retain æˆ– DUP æ ‡å¿—ï¼Œæˆ–ä¸ºè´Ÿè½½æ·»åŠ é¢å¤–å±æ€§ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `MqttRecordBuilder` ç±»ã€‚ä¾‹å¦‚ï¼Œè¦å°† `QoS` è®¾ç½®ä¸º `2`ï¼Œå¯ä»¥ä½¿ç”¨ `setQoS` æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```typescript
const userProperties = { 'x-version': '1.0.0' };
const record = new MqttRecordBuilder(':cat:')
  .setProperties({ userProperties })
  .setQoS(1)
  .build();
client.send('replace-emoji', record).subscribe(...);
```

> info **æç¤º** `MqttRecordBuilder` ç±»ç”± `@nestjs/microservices` åŒ…å¯¼å‡ºã€‚

åœ¨æœåŠ¡ç«¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è®¿é—® `MqttContext` è¯»å–è¿™äº›é€‰é¡¹ã€‚

```typescript
@@filename()
@MessagePattern('replace-emoji')
replaceEmoji(@Payload() data: string, @Ctx() context: MqttContext): string {
  const { properties: { userProperties } } = context.getPacket();
  return userProperties['x-version'] === '1.0.0' ? 'ğŸ±' : 'ğŸˆ';
}
@@switch
@Bind(Payload(), Ctx())
@MessagePattern('replace-emoji')
replaceEmoji(data, context) {
  const { properties: { userProperties } } = context.getPacket();
  return userProperties['x-version'] === '1.0.0' ? 'ğŸ±' : 'ğŸˆ';
}
```

åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå¦‚æœä½ å¸Œæœ›ä¸ºå¤šä¸ªè¯·æ±‚ç»Ÿä¸€é…ç½®ç”¨æˆ·å±æ€§ï¼Œå¯ä»¥å°†è¿™äº›é€‰é¡¹ä¼ é€’ç»™ `ClientProxyFactory`ã€‚

```typescript
import { Module } from '@nestjs/common'
import { ClientProxyFactory, Transport } from '@nestjs/microservices'

@Module({
  providers: [
    {
      provide: 'API_v1',
      useFactory: () =>
        ClientProxyFactory.create({
          transport: Transport.MQTT,
          options: {
            url: 'mqtt://localhost:1833',
            userProperties: { 'x-version': '1.0.0' },
          },
        }),
    },
  ],
})
export class ApiModule {}
```

#### å®ä¾‹çŠ¶æ€æ›´æ–°

è¦å®æ—¶è·å–è¿æ¥å’Œåº•å±‚é©±åŠ¨å®ä¾‹çš„çŠ¶æ€æ›´æ–°ï¼Œå¯ä»¥è®¢é˜… `status` æµã€‚è¯¥æµä¼šæä¾›æ‰€é€‰é©±åŠ¨ä¸“å±çš„çŠ¶æ€æ›´æ–°ã€‚ä»¥ MQTT é©±åŠ¨ä¸ºä¾‹ï¼Œ`status` æµä¼šå‘å‡º `connected`ã€`disconnected`ã€`reconnecting` å’Œ `closed` äº‹ä»¶ã€‚

```typescript
this.client.status.subscribe((status: MqttStatus) => {
  console.log(status)
})
```

> info **æç¤º** `MqttStatus` ç±»å‹éœ€ä» `@nestjs/microservices` åŒ…ä¸­å¯¼å…¥ã€‚

åŒæ ·ï¼Œä½ ä¹Ÿå¯ä»¥è®¢é˜…æœåŠ¡å™¨çš„ `status` æµï¼Œä»¥æ¥æ”¶æœåŠ¡å™¨çŠ¶æ€çš„é€šçŸ¥ã€‚

```typescript
const server = app.connectMicroservice<MicroserviceOptions>(...);
server.status.subscribe((status: MqttStatus) => {
  console.log(status);
});
```

#### ç›‘å¬ MQTT äº‹ä»¶

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½å¸Œæœ›ç›‘å¬å¾®æœåŠ¡å†…éƒ¨å‘å‡ºçš„äº‹ä»¶ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ç›‘å¬ `error` äº‹ä»¶ï¼Œåœ¨å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘é¢å¤–æ“ä½œã€‚è¦å®ç°è¿™ä¸€ç‚¹ï¼Œå¯ä»¥ä½¿ç”¨ `on()` æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```typescript
this.client.on('error', (err) => {
  console.error(err)
})
```

åŒæ ·ï¼Œä½ ä¹Ÿå¯ä»¥ç›‘å¬æœåŠ¡å™¨çš„å†…éƒ¨äº‹ä»¶ï¼š

```typescript
server.on<MqttEvents>('error', (err) => {
  console.error(err)
})
```

> info **æç¤º** `MqttEvents` ç±»å‹éœ€ä» `@nestjs/microservices` åŒ…ä¸­å¯¼å…¥ã€‚

#### è®¿é—®åº•å±‚é©±åŠ¨å®ä¾‹

å¯¹äºæ›´é«˜çº§çš„ç”¨ä¾‹ï¼Œä½ å¯èƒ½éœ€è¦è®¿é—®åº•å±‚é©±åŠ¨å®ä¾‹ã€‚è¿™åœ¨éœ€è¦æ‰‹åŠ¨å…³é—­è¿æ¥æˆ–è°ƒç”¨é©±åŠ¨ä¸“æœ‰æ–¹æ³•ç­‰åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨ã€‚ä½†è¯·æ³¨æ„ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ **æ— éœ€**ç›´æ¥è®¿é—®é©±åŠ¨ã€‚

å¦‚éœ€è®¿é—®åº•å±‚é©±åŠ¨å®ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨ `unwrap()` æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šè¿”å›åº•å±‚é©±åŠ¨å®ä¾‹ï¼Œæ³›å‹ç±»å‹å‚æ•°åº”æŒ‡å®šä½ æœŸæœ›çš„é©±åŠ¨å®ä¾‹ç±»å‹ã€‚

```typescript
const mqttClient = this.client.unwrap<import('mqtt').MqttClient>()
```

åŒæ ·ï¼Œä½ ä¹Ÿå¯ä»¥è®¿é—®æœåŠ¡å™¨çš„åº•å±‚é©±åŠ¨å®ä¾‹ï¼š

```typescript
const mqttClient = server.unwrap<import('mqtt').MqttClient>()
```
