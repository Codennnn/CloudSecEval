# æ€§èƒ½ä¼˜åŒ–ï¼ˆä½¿ç”¨ Fastifyï¼‰

é»˜è®¤æƒ…å†µä¸‹ï¼ŒNest ä½¿ç”¨ Express ä½œä¸ºåº•å±‚ HTTP æœåŠ¡å™¨æ¡†æ¶ã€‚ç„¶è€Œï¼Œæ­£å¦‚å‰æ–‡æ‰€è¿°ï¼ŒNest åŒæ ·æ”¯æŒé›†æˆå…¶ä»–åº“ï¼Œå¦‚ Fastifyã€‚è¿™å¾—ç›Šäº Nest çš„æ¡†æ¶æ— å…³æ€§è®¾è®¡ â€”â€” é€šè¿‡ã€Œæ¡†æ¶é€‚é…å™¨ï¼ˆframework adapterï¼‰ã€æœºåˆ¶ï¼ŒNest èƒ½å°†ä¸­é—´ä»¶ä¸è¯·æ±‚å¤„ç†æµç¨‹å§”æ‰˜ç»™å…·ä½“æ¡†æ¶ï¼Œä»è€Œå®ç°åº•å±‚æ›¿æ¢çš„çµæ´»æ€§ã€‚

<CalloutInfo>
  è¯·æ³¨æ„ï¼šè¦å®ç°è‡ªå®šä¹‰æ¡†æ¶é€‚é…å™¨ï¼Œç›®æ ‡æ¡†æ¶å¿…é¡»å…·å¤‡ç±»ä¼¼ Express
  çš„è¯·æ±‚/å“åº”ç®¡é“å¤„ç†èƒ½åŠ›ã€‚
</CalloutInfo>

[Fastify](https://github.com/fastify/fastify) æ˜¯ä¸€ä¸ªåœ¨æ€§èƒ½ä¸Šä¼˜äº Express çš„é«˜æ•ˆæ›¿ä»£æ–¹æ¡ˆã€‚å®ƒçš„è®¾è®¡ç†å¿µä¸ Express ç›¸è¿‘ï¼Œèƒ½èƒœä»»ç›¸åŒçš„ä»»åŠ¡ï¼Œä½†åœ¨é€Ÿåº¦å’Œååé‡ä¸Šè¡¨ç°æ›´ä¸ºå‡ºè‰²ã€‚æ ¹æ®åŸºå‡†æµ‹è¯•ç»“æœï¼ŒFastify çš„æ€§èƒ½é€šå¸¸æ˜¯ Express çš„ä¸¤å€å·¦å³ã€‚

æ—¢ç„¶å¦‚æ­¤ï¼Œä¸ºä»€ä¹ˆ Nest é»˜è®¤ä»é€‰æ‹© Expressï¼Ÿä¸»è¦åŸå› åœ¨äºå…¶åºå¤§çš„ç”¨æˆ·ç¾¤ä½“ã€é«˜çŸ¥ååº¦ï¼Œä»¥åŠä¸°å¯Œçš„ä¸­é—´ä»¶ç”Ÿæ€ â€”â€” è¿™äº›èµ„æºå¤§å¤šå¯ä»¥ç›´æ¥æ— ç¼é›†æˆè¿› Nest é¡¹ç›®ä¸­ã€‚

ä¸è¿‡ï¼Œç”±äº Nest æœ¬èº«ä¸ä¾èµ–ç‰¹å®šæ¡†æ¶ï¼Œä½ å¯ä»¥æ ¹æ®é¡¹ç›®éœ€æ±‚è‡ªç”±åˆ‡æ¢åº•å±‚å®ç°ã€‚å¦‚æœä½ å¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼ŒFastify æ˜¯ä¸€ä¸ªå€¼å¾—è€ƒè™‘çš„é€‰æ‹©ã€‚å¯ç”¨æ–¹å¼ä¹Ÿéå¸¸ç®€å•ï¼šåªéœ€åœ¨åº”ç”¨å¯åŠ¨æ—¶ä½¿ç”¨å†…ç½®çš„ `FastifyAdapter` å³å¯ã€‚

## å®‰è£…ä¾èµ–

åœ¨å¼€å§‹ä½¿ç”¨ Fastify ä¹‹å‰ï¼Œå…ˆå®‰è£…ç›¸å…³å¹³å°æ”¯æŒåŒ…ï¼š

```bash
npm install @nestjs/platform-fastify
```

## ä½¿ç”¨é€‚é…å™¨

å®‰è£… Fastify å¹³å°æ”¯æŒåŒ…åï¼Œå³å¯é€šè¿‡å†…ç½®çš„ `FastifyAdapter` å¯åŠ¨åº”ç”¨ï¼š

```ts filename='main.ts'
import { NestFactory } from '@nestjs/core'
import {
  FastifyAdapter,
  NestFastifyApplication,
} from '@nestjs/platform-fastify'
import { AppModule } from './app.module'

async function bootstrap() {
  const app = await NestFactory.create<NestFastifyApplication>(
    AppModule,
    new FastifyAdapter() // [!code hl]
  )
  await app.listen(process.env.PORT ?? 3000)
}
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒFastify é»˜è®¤ä»…ç›‘å¬æœ¬åœ°åœ°å€ `127.0.0.1`ï¼ˆè¯¦è§[å®˜æ–¹æ–‡æ¡£è¯´æ˜](https://www.fastify.io/docs/latest/Guides/Getting-Started/#your-first-server)ï¼‰ã€‚å¦‚æœå¸Œæœ›è®©åº”ç”¨å¯è¢«å±€åŸŸç½‘æˆ–å…¬ç½‘è®¿é—®ï¼Œä½ éœ€è¦åœ¨ `listen()` æ–¹æ³•ä¸­æ˜¾å¼ä¼ å…¥ `'0.0.0.0'`ï¼š

```ts filename='main.ts'
async function bootstrap() {
  const app = await NestFactory.create<NestFastifyApplication>(
    AppModule,
    new FastifyAdapter()
  )
  await app.listen(3000, '0.0.0.0')
}
```

## å¹³å°å·®å¼‚

ä½¿ç”¨ `FastifyAdapter` åï¼ŒNest ä¼šå°† Fastify ä½œä¸º**åº•å±‚ HTTP æœåŠ¡å™¨**ã€‚è¿™æ„å‘³ç€ï¼Œæ‰€æœ‰ä¾èµ– Express å®ç°çš„åŠŸèƒ½ï¼ˆå¦‚éƒ¨åˆ†ä¸­é—´ä»¶ã€è¯·æ±‚å¯¹è±¡ç»“æ„ç­‰ï¼‰ï¼Œåœ¨ Fastify ç¯å¢ƒä¸‹å¯èƒ½æ— æ³•ç›´æ¥ä½¿ç”¨æˆ–è¡¨ç°ä¸åŒã€‚

ä¸ºäº†è·å¾—è‰¯å¥½çš„å…¼å®¹æ€§ä¸ä½“éªŒï¼Œå»ºè®®ä¼˜å…ˆé€‰æ‹©åŸºäº Fastify æ„å»ºçš„ä¸­é—´ä»¶æˆ–å·¥å…·ï¼Œé¿å…ç›´æ¥å¼•å…¥åªé€‚ç”¨äº Express çš„æ¨¡å—ã€‚

## é‡å®šå‘å“åº”

Fastify å¯¹é‡å®šå‘çš„å¤„ç†æ–¹å¼ä¸ Express ç•¥æœ‰ä¸åŒã€‚åœ¨ Fastify ä¸­ï¼Œä½ éœ€è¦æ˜¾å¼è®¾ç½®çŠ¶æ€ç å¹¶è°ƒç”¨ `redirect()` æ–¹æ³•ï¼ŒåŒæ—¶æŒ‡å®šç›®æ ‡åœ°å€ã€‚ä¾‹å¦‚ï¼š

```ts
@Get()
index(@Res() res) {
  res.status(302).redirect('/login')
}
```

è¯·æ³¨æ„ï¼Œä½¿ç”¨ `@Res()` è£…é¥°å™¨ä¼šç»•è¿‡ Nest çš„å“åº”æ˜ å°„æœºåˆ¶ï¼Œå› æ­¤å»ºè®®ä»…åœ¨éœ€è¦ç²¾ç»†æ§åˆ¶åº•å±‚å“åº”è¡Œä¸ºï¼ˆå¦‚é‡å®šå‘ã€è®¾ç½® Cookie ç­‰ï¼‰æ—¶ä½¿ç”¨ã€‚

## é…ç½® Fastify å®ä¾‹

ä½ å¯ä»¥é€šè¿‡ `FastifyAdapter` çš„æ„é€ å‡½æ•°ï¼Œå°†é…ç½®å¯¹è±¡ä¼ é€’ç»™åº•å±‚ Fastify å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œå¯ç”¨æ—¥å¿—åŠŸèƒ½çš„å†™æ³•å¦‚ä¸‹ï¼š

```ts
new FastifyAdapter({ logger: true })
```

æ”¯æŒçš„æ‰€æœ‰é…ç½®é¡¹è¯·å‚è§ [Fastify å®˜æ–¹æ–‡æ¡£](https://www.fastify.io/docs/latest/Reference/Server/#factory-options)ã€‚

## ä¸­é—´ä»¶æ”¯æŒ

åœ¨åŸºäº Fastify çš„ Nest åº”ç”¨ä¸­ï¼Œä¸­é—´ä»¶å‡½æ•°æ¥æ”¶åˆ°çš„æ˜¯åº•å±‚åŸå§‹çš„ `req` å’Œ `res` å¯¹è±¡ï¼Œè€Œä¸æ˜¯ Fastify å°è£…åçš„ç±»å‹ã€‚è¿™æ˜¯å› ä¸º Nest é€šè¿‡é›†æˆ Fastify å®˜æ–¹ä¸­é—´ä»¶æ’ä»¶ [`@fastify/middie`](https://www.fastify.io/docs/latest/Reference/Middleware/)ï¼Œæä¾›äº†ä¸­é—´ä»¶æ”¯æŒèƒ½åŠ›ã€‚

ä¸€ä¸ªä½¿ç”¨ Fastify åŸå§‹è¯·æ±‚å¯¹è±¡çš„ä¸­é—´ä»¶ç¤ºä¾‹ï¼š

```ts filename='logger.middleware.ts'
import { Injectable, NestMiddleware } from '@nestjs/common'
import { FastifyRequest, FastifyReply } from 'fastify'

@Injectable()
export class LoggerMiddleware implements NestMiddleware {
  use(req: FastifyRequest['raw'], res: FastifyReply['raw'], next: () => void) {
    console.log('Request...')
    next()
  }
}
```

## è·¯ç”±é…ç½®

Fastify æ”¯æŒä¸ºæ¯ä¸ªè·¯ç”±å®šä¹‰ç‹¬ç«‹çš„é…ç½®é¡¹ï¼ŒNest é€šè¿‡ `@RouteConfig()` è£…é¥°å™¨æä¾›äº†è¿™ä¸€åŠŸèƒ½çš„é›†æˆã€‚ä½ å¯ä»¥åœ¨æ§åˆ¶å™¨æ–¹æ³•ä¸Šå®šä¹‰ä¸ªæ€§åŒ–çš„è·¯ç”±è¡Œä¸ºï¼š

```ts
import { RouteConfig } from '@nestjs/platform-fastify'

@RouteConfig({ output: 'hello world' })
@Get()
index(@Req() req) {
  return req.routeConfig.output
}
```

æœ‰å…³è·¯ç”±é…ç½®é¡¹çš„æ›´å¤šä¿¡æ¯ï¼Œå¯å‚è€ƒ [Fastify è·¯ç”±é…ç½®æ–‡æ¡£](https://fastify.dev/docs/latest/Reference/Routes/#config)ã€‚

## è·¯ç”±çº¦æŸ

ä» `@nestjs/platform-fastify` v10.3.0 èµ·ï¼ŒNest å·²æ”¯æŒ Fastify çš„[è·¯ç”±çº¦æŸ](https://fastify.dev/docs/latest/Reference/Routes/#constraints)ï¼ˆroute constraintsï¼‰ åŠŸèƒ½ã€‚ä½ å¯ä»¥ä½¿ç”¨ `@RouteConstraints()` è£…é¥°å™¨ä¸ºè·¯ç”±å®šä¹‰ç‰ˆæœ¬æ§åˆ¶ã€ä¸»æœºåé™åˆ¶ç­‰æ¡ä»¶ï¼š

```ts
import { RouteConstraints } from '@nestjs/platform-fastify'

@RouteConstraints({ version: '1.2.x' })
@Get()
newFeature() {
  return 'æ­¤åŠŸèƒ½ä»…é€‚ç”¨äºç‰ˆæœ¬ >= 1.2.x'
}
```

## ç¤ºä¾‹é¡¹ç›®

ä½ å¯ä»¥åœ¨å®˜æ–¹ç¤ºä¾‹ä»“åº“ä¸­æŸ¥çœ‹å®Œæ•´çš„ Fastify é›†æˆç¤ºä¾‹ä»£ç ï¼š[ğŸ‘‰ GitHub ç¤ºä¾‹ï¼šnestjs/nest - sample/10-fastify](https://github.com/nestjs/nest/tree/master/sample/10-fastify)
