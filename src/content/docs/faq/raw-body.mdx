# 原始请求体

在某些场景下，你需要直接访问未经解析的原始请求体（raw body）。一个典型的例子就是校验 Webhook 签名，这通常需要使用原始请求体来计算 HMAC 哈希值。

<CalloutInfo type="warning">
  只有当内置的全局 `body-parser` 中间件启用时，此功能才可用。这意味着在创建应用实例时，不能将
  `bodyParser` 选项设置为 `false`。
</CalloutInfo>

## 在 Express 中使用

要在 Nest Express 应用中启用此功能，请在创建应用实例时进行如下配置：

```ts
import { NestFactory } from '@nestjs/core'
import type { NestExpressApplication } from '@nestjs/platform-express'
import { AppModule } from './app.module'

// 在 "bootstrap" 函数中
const app = await NestFactory.create<NestExpressApplication>(AppModule, {
  rawBody: true,
})
await app.listen(process.env.PORT ?? 3000)
```

要在控制器中访问原始请求体，可以使用便捷接口 `RawBodyRequest`，该接口会在请求对象上暴露 `rawBody` 字段。用法如下：

```ts
import { Controller, Post, RawBodyRequest, Req } from '@nestjs/common'
import { Request } from 'express'

@Controller('cats')
class CatsController {
  @Post()
  create(@Req() req: RawBodyRequest<Request>) {
    const raw = req.rawBody // 返回一个 Buffer。
  }
}
```

## 注册其他解析器

默认情况下，Nest 只注册了 `json` 和 `urlencoded` 两种解析器。如果你需要处理其他类型的请求体，可以动态注册相应的解析器。

例如，要注册 `text` 解析器，可以这样写：

```ts
app.useBodyParser('text')
```

<CalloutInfo type="warning">
  请确保在调用 `NestFactory.create` 时传入了正确的应用类型。对于 Express 应用，该类型应为
  `NestExpressApplication`，否则 `useBodyParser()` 方法将不可用。
</CalloutInfo>

## 请求体大小限制

Express 的默认请求体大小限制为 `100kb`。如果需要处理更大的请求体，可以按如下方式调整：

```ts
app.useBodyParser('json', { limit: '10mb' })
```

调用 `useBodyParser()` 方法时，应用选项中设置的 `rawBody` 配置依然有效。

## 在 Fastify（高性能 Node.js 框架）中使用

要在 Nest Fastify 应用中启用此功能，请在创建应用实例时进行如下配置：

```ts
import { NestFactory } from '@nestjs/core'
import { FastifyAdapter, NestFastifyApplication } from '@nestjs/platform-fastify'
import { AppModule } from './app.module'

// 在 "bootstrap" 函数中
const app = await NestFactory.create<NestFastifyApplication>(AppModule, new FastifyAdapter(), {
  rawBody: true,
})
await app.listen(process.env.PORT ?? 3000)
```

要在控制器中访问原始请求体，同样可以使用 `RawBodyRequest` 接口，该接口会在请求对象上暴露 `rawBody` 字段。用法如下：

```ts
import { Controller, Post, RawBodyRequest, Req } from '@nestjs/common'
import { FastifyRequest } from 'fastify'

@Controller('cats')
class CatsController {
  @Post()
  create(@Req() req: RawBodyRequest<FastifyRequest>) {
    const raw = req.rawBody // 返回一个 Buffer。
  }
}
```

## 注册其他解析器

默认情况下，Nest 只注册了 `application/json` 和 `application/x-www-form-urlencoded` 两种解析器。如果你需要处理其他类型的请求体，可以动态注册相应的解析器。

例如，要注册 `text/plain` 解析器，可以这样写：

```ts
app.useBodyParser('text/plain')
```

<CalloutInfo type="warning">
  请确保在调用 `NestFactory.create` 时传入了正确的应用类型。对于 Fastify 应用，该类型应为
  `NestFastifyApplication`，否则 `useBodyParser()` 方法将不可用。
</CalloutInfo>

## 请求体大小限制

Fastify 的默认请求体大小限制为 `1MiB`，如果需要处理更大的请求体，可以按如下方式调整：

```ts
const bodyLimit = 10_485_760 // 10MiB
app.useBodyParser('application/json', { bodyLimit })
```

调用 `useBodyParser()` 方法时，应用选项中设置的 `rawBody` 配置依然有效。
