# HTTPS

如需创建 HTTPS 应用，你需要在 `NestFactory.create()` 方法的 `options` 对象中配置 `httpsOptions` 属性：

```ts
const httpsOptions = {
  key: fs.readFileSync('./secrets/private-key.pem'),
  cert: fs.readFileSync('./secrets/public-certificate.pem'),
}
const app = await NestFactory.create(AppModule, {
  httpsOptions,
})
await app.listen(process.env.PORT ?? 3000)
```

若使用 `FastifyAdapter`，则按如下方式创建应用：

```ts
const app = await NestFactory.create<NestFastifyApplication>(
  AppModule,
  new FastifyAdapter({ https: httpsOptions })
)
```

## 同时监听多个端口

以下示例展示了如何创建一个 Nest 应用，并使其同时监听多个端口（例如，一个 HTTP 端口和一个 HTTPS 端口）。

```ts
const httpsOptions = {
  key: fs.readFileSync('./secrets/private-key.pem'),
  cert: fs.readFileSync('./secrets/public-certificate.pem'),
}

const server = express()
const app = await NestFactory.create(AppModule, new ExpressAdapter(server))
await app.init()

const httpServer = http.createServer(server).listen(3000)
const httpsServer = https.createServer(httpsOptions, server).listen(443)
```

由于手动调用了 `http.createServer` 和 `https.createServer`，当调用 `app.close()` 或应用收到终止信号时，NestJS 将不会自动关闭这些服务器，你需要自行实现关闭逻辑：

```ts
@Injectable()
export class ShutdownObserver implements OnApplicationShutdown {
  private httpServers: http.Server[] = []

  public addHttpServer(server: http.Server): void {
    this.httpServers.push(server)
  }

  public async onApplicationShutdown(): Promise<void> {
    await Promise.all(
      this.httpServers.map(
        (server) =>
          new Promise((resolve, reject) => {
            server.close((error) => {
              if (error) {
                reject(error)
              } else {
                resolve(null)
              }
            })
          })
      )
    )
  }
}

const shutdownObserver = app.get(ShutdownObserver)
shutdownObserver.addHttpServer(httpServer)
shutdownObserver.addHttpServer(httpsServer)
```

<CalloutInfo>
  `ExpressAdapter` 需要从 `@nestjs/platform-express` 包中导入。`http` 和 `https` 都是 Node.js
  的内置模块。
</CalloutInfo>

<CalloutInfo type="warning">
  <div>此方案不适用于 [GraphQL 订阅](/graphql/subscriptions)。</div>
</CalloutInfo>
