# HTTP 适配器

在开发 Nest 应用时，你可能需要访问底层的 HTTP 服务器实例，无论是在 Nest 的应用上下文（`ApplicationContext`）内部还是外部。

在 Nest 中，每个原生（即特定于平台的）HTTP 服务器或库（例如 Express 或 Fastify）的实例都会被封装在一个**适配器**中。这个适配器会被注册为一个全局可用的提供者，因此你可以直接从应用上下文中获取它，或将其注入到其他服务中。

## 在应用上下文外部获取

如果需要在应用上下文外部获取 `HttpAdapter` 的引用，可以调用 `getHttpAdapter()` 方法。

```ts
const app = await NestFactory.create(AppModule)
const httpAdapter = app.getHttpAdapter()
```

## 通过依赖注入获取

在应用上下文内部，你可以通过依赖注入来获取 `HttpAdapterHost` 的引用。这和注入其他提供者的方式完全相同，通常是通过构造函数注入。

```ts
import { HttpAdapterHost } from '@nestjs/core'

export class CatsService {
  constructor(private readonly adapterHost: HttpAdapterHost) {}
}
```

值得注意的是，`HttpAdapterHost` 本身并**不是**实际的 `HttpAdapter`。要获取真正的 `HttpAdapter` 实例，你需要访问它的 `httpAdapter` 属性。

```ts
const adapterHost = app.get(HttpAdapterHost)
const httpAdapter = adapterHost.httpAdapter
```

这个 `httpAdapter` 变量就是底层框架（如 Express 或 Fastify）所使用的 HTTP 适配器实例。它的类型是 `ExpressAdapter` 或 `FastifyAdapter`，这两个类都继承自 `AbstractHttpAdapter`。

适配器对象提供了一系列与 HTTP 服务器交互的实用方法。例如，如果你想直接访问底层的库实例（如 Express 实例），可以调用 `getInstance()` 方法。

```ts
const instance = httpAdapter.getInstance()
```

## 监听事件

如果你想在服务器成功启动并开始监听请求后执行特定操作，可以订阅 `listen$` 这个 Observable，如下所示：

```ts
this.httpAdapterHost.listen$.subscribe(() => console.log('HTTP server is listening'))
```

此外，`HttpAdapterHost` 还提供了一个 `listening` 布尔值属性，你可以用它来判断服务器当前是否正在监听：

```ts
if (this.httpAdapterHost.listening) {
  console.log('HTTP server is listening')
}
```
