# RabbitMQï¼ˆæ¶ˆæ¯ä»£ç†ï¼‰

[RabbitMQ](https://www.rabbitmq.com/) æ˜¯ä¸€ä¸ªå¼€æºä¸”è½»é‡çº§çš„æ¶ˆæ¯ä»£ç†ï¼ˆmessage brokerï¼‰ï¼Œæ”¯æŒå¤šç§æ¶ˆæ¯åè®®ã€‚å®ƒå¯ä»¥ä»¥åˆ†å¸ƒå¼å’Œè”é‚¦å¼æ¶æ„è¿›è¡Œéƒ¨ç½²ï¼Œä»¥æ»¡è¶³é«˜æ‰©å±•æ€§å’Œé«˜å¯ç”¨æ€§çš„éœ€æ±‚ã€‚æ­¤å¤–ï¼ŒRabbitMQ æ˜¯å…¨çƒåº”ç”¨æœ€å¹¿æ³›çš„æ¶ˆæ¯ä»£ç†ï¼Œæ— è®ºæ˜¯åˆåˆ›å…¬å¸è¿˜æ˜¯å¤§å‹ä¼ä¸šéƒ½åœ¨ä½¿ç”¨ã€‚

## å®‰è£…

è¦å¼€å§‹æ„å»ºåŸºäº RabbitMQ çš„å¾®æœåŠ¡ï¼Œé¦–å…ˆéœ€è¦å®‰è£…ä»¥ä¸‹ä¾èµ–åŒ…ï¼š

```bash
$ npm i --save amqplib amqp-connection-manager
```

## æ¦‚è¿°

è¦ä½¿ç”¨ RabbitMQ ä½œä¸ºä¼ è¾“å±‚ï¼ˆTransport Layerï¼‰ï¼Œè¯·å°†å¦‚ä¸‹ options å¯¹è±¡ä¼ é€’ç»™ `createMicroservice()` æ–¹æ³•ï¼š

```ts filename='main.ts'
import { Transport } from '@nestjs/microservices'

const app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {
  transport: Transport.RMQ,
  options: {
    urls: ['amqp://localhost:5672'],
    queue: 'cats_queue',
    queueOptions: {
      durable: false,
    },
  },
})
```

## é€‰é¡¹

`options` å±æ€§æ˜¯é’ˆå¯¹æ‰€é€‰ä¼ è¾“å™¨ç‰¹æœ‰çš„é…ç½®ã€‚**RabbitMQ** ä¼ è¾“å™¨æ”¯æŒä»¥ä¸‹å±æ€§ï¼š

| é€‰é¡¹                    | è¯´æ˜                                                                                                                                                                                                                                                |
| ----------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `urls`                  | ä¸€ä¸ªåŒ…å«å¤šä¸ªè¿æ¥ URL çš„æ•°ç»„ï¼ŒæŒ‰é¡ºåºä¾æ¬¡å°è¯•è¿æ¥                                                                                                                                                                                                     |
| `queue`                 | æœåŠ¡å™¨ç›‘å¬çš„é˜Ÿåˆ—åç§°                                                                                                                                                                                                                                |
| `prefetchCount`         | è®¾ç½®é€šé“çš„é¢„å–ï¼ˆprefetchï¼‰æ¶ˆæ¯æ•°é‡                                                                                                                                                                                                                  |
| `isGlobalPrefetchCount` | å¯ç”¨æ¯ä¸ªé€šé“çš„å…¨å±€é¢„å–è®¾ç½®                                                                                                                                                                                                                          |
| `noAck`                 | å¦‚æœä¸º `false`ï¼Œåˆ™å¯ç”¨æ‰‹åŠ¨ç¡®è®¤ï¼ˆacknowledgmentï¼‰æ¨¡å¼                                                                                                                                                                                                |
| `consumerTag`           | æœåŠ¡å™¨ç”¨äºåŒºåˆ†æ¶ˆè´¹è€…æ¶ˆæ¯æŠ•é€’çš„åç§°ï¼›è¯¥åç§°åœ¨é€šé“ä¸Šä¸èƒ½é‡å¤ã€‚é€šå¸¸å»ºè®®çœç•¥æ­¤é¡¹ï¼Œç”±æœåŠ¡å™¨è‡ªåŠ¨ç”Ÿæˆéšæœºåç§°å¹¶åœ¨å“åº”ä¸­è¿”å›ã€‚æ¶ˆè´¹è€…æ ‡ç­¾æ ‡è¯†ç¬¦ï¼ˆConsumer Tag Identifierï¼‰ï¼Œ[è¯¦ç»†è¯´æ˜](https://amqp-node.github.io/amqplib/channel_api.html#channel_consume) |
| `queueOptions`          | é˜Ÿåˆ—çš„å…¶ä»–é…ç½®é€‰é¡¹ï¼Œ[è¯¦ç»†è¯´æ˜](https://amqp-node.github.io/amqplib/channel_api.html#channel_assertQueue)                                                                                                                                            |
| `socketOptions`         | è¿æ¥çš„å…¶ä»– socket é…ç½®é€‰é¡¹ï¼Œ[è¯¦ç»†è¯´æ˜](https://amqp-node.github.io/amqplib/channel_api.html#connect)                                                                                                                                                |
| `headers`               | æ¯æ¡æ¶ˆæ¯éƒ½æºå¸¦çš„è‡ªå®šä¹‰å¤´éƒ¨ï¼ˆheadersï¼‰                                                                                                                                                                                                               |
| `replyQueue`            | ç”Ÿäº§è€…ä½¿ç”¨çš„å›å¤é˜Ÿåˆ—ï¼Œé»˜è®¤ä¸º `amq.rabbitmq.reply-to`                                                                                                                                                                                                |
| `persistent`            | å¦‚æœä¸ºçœŸï¼ˆtruthyï¼‰ï¼Œæ¶ˆæ¯å°†åœ¨ä»£ç†ï¼ˆbrokerï¼‰é‡å¯åä¾ç„¶ä¿ç•™ï¼Œå‰ææ˜¯é˜Ÿåˆ—æœ¬èº«ä¹Ÿæ”¯æŒæŒä¹…åŒ–                                                                                                                                                                |
| `noAssert`              | ä¸º false æ—¶ï¼Œæ¶ˆè´¹å‰ä¸ä¼šæ–­è¨€ï¼ˆassertï¼‰é˜Ÿåˆ—                                                                                                                                                                                                           |
| `wildcards`             | ä»…å½“ä½ å¸Œæœ›ä½¿ç”¨ä¸»é¢˜äº¤æ¢æœºï¼ˆTopic Exchangeï¼‰å°†æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ—æ—¶è®¾ç½®ä¸º trueã€‚å¯ç”¨åï¼Œå¯ä»¥åœ¨æ¶ˆæ¯å’Œäº‹ä»¶æ¨¡å¼ä¸­ä½¿ç”¨é€šé…ç¬¦ï¼ˆ\*ï¼Œ#ï¼‰                                                                                                                          |
| `exchange`              | äº¤æ¢æœºï¼ˆexchangeï¼‰åç§°ã€‚å½“ "wildcards" è®¾ç½®ä¸º true æ—¶ï¼Œé»˜è®¤ä¸ºé˜Ÿåˆ—åç§°                                                                                                                                                                               |
| `exchangeType`          | äº¤æ¢æœºç±»å‹ï¼Œé»˜è®¤ä¸º `topic`ã€‚å¯é€‰å€¼åŒ…æ‹¬ `direct`ã€`fanout`ã€`topic` å’Œ `headers`                                                                                                                                                                     |
| `routingKey`            | ä¸»é¢˜äº¤æ¢æœºçš„é™„åŠ è·¯ç”±é”®ï¼ˆrouting keyï¼‰                                                                                                                                                                                                               |
| `maxConnectionAttempts` | æœ€å¤§è¿æ¥å°è¯•æ¬¡æ•°ï¼Œä»…é€‚ç”¨äºæ¶ˆè´¹è€…é…ç½®ã€‚-1 è¡¨ç¤ºæ— é™é‡è¯•                                                                                                                                                                                               |

## å®¢æˆ·ç«¯ï¼ˆClientï¼‰

ä¸å…¶ä»–å¾®æœåŠ¡ä¼ è¾“å™¨ç±»ä¼¼ï¼Œä½ æœ‰[å¤šç§æ–¹å¼](/microservices/basics#client)å¯ä»¥åˆ›å»º RabbitMQ å®¢æˆ·ç«¯ä»£ç†ï¼ˆClientProxyï¼‰å®ä¾‹ã€‚

å…¶ä¸­ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨ `ClientsModule`ã€‚è¦é€šè¿‡ `ClientsModule` åˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹ï¼Œéœ€è¦å¯¼å…¥è¯¥æ¨¡å—ï¼Œå¹¶ä½¿ç”¨ `register()` æ–¹æ³•ä¼ å…¥ä¸€ä¸ªé€‰é¡¹å¯¹è±¡ã€‚è¯¥å¯¹è±¡çš„å±æ€§ä¸ä¸Šæ–‡ `createMicroservice()` æ–¹æ³•ä¸­å±•ç¤ºçš„å±æ€§ä¸€è‡´ï¼Œå¹¶ä¸”è¿˜éœ€è¦åŒ…å«ä¸€ä¸ª `name` å±æ€§ä½œä¸ºæ³¨å…¥ä»¤ç‰Œï¼ˆInjection Tokenï¼‰ã€‚ä½ å¯ä»¥åœ¨[è¿™é‡Œ](/microservices/basics#client)æŸ¥çœ‹æ›´å¤šå…³äº `ClientsModule` çš„å†…å®¹ã€‚

```ts
@Module({
  imports: [
    ClientsModule.register([
      {
        name: 'MATH_SERVICE',
        transport: Transport.RMQ,
        options: {
          urls: ['amqp://localhost:5672'],
          queue: 'cats_queue',
          queueOptions: {
            durable: false
          },
        },
      },
    ]),
  ]
  ...
})
```

é™¤æ­¤ä¹‹å¤–ï¼Œä½ è¿˜å¯ä»¥é€‰æ‹©å…¶ä»–æ–¹å¼æ¥åˆ›å»ºå®¢æˆ·ç«¯ï¼Œä¾‹å¦‚ `ClientProxyFactory` æˆ– `@Client()` è£…é¥°å™¨ã€‚ç›¸å…³å†…å®¹å¯[åœ¨æ­¤æŸ¥é˜…](/microservices/basics#client)ã€‚

## ä¸Šä¸‹æ–‡

åœ¨æ›´å¤æ‚çš„åœºæ™¯ä¸­ï¼Œä½ å¯èƒ½éœ€è¦è®¿é—®æœ‰å…³ä¼ å…¥è¯·æ±‚çš„æ›´å¤šä¿¡æ¯ã€‚å½“ä½¿ç”¨ RabbitMQ ä¼ è¾“å±‚æ—¶ï¼Œå¯ä»¥è®¿é—® `RmqContext` å¯¹è±¡ã€‚

```ts
import { RmqContext, Payload, Ctx } from '@nestjs/microservices'

@MessagePattern('notifications')
getNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {
  console.log(`Pattern: ${context.getPattern()}`);
}
```

è¦è®¿é—®åŸå§‹çš„ RabbitMQ æ¶ˆæ¯ï¼ˆåŒ…å« `properties`ã€`fields` å’Œ `content`ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `RmqContext` å¯¹è±¡çš„ `getMessage()` æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```ts
@MessagePattern('notifications')
getNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {
  console.log(context.getMessage());
}
```

å¦‚æœéœ€è¦è·å– RabbitMQ [é€šé“ï¼ˆchannelï¼‰](https://www.rabbitmq.com/channels.html) çš„å¼•ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ `RmqContext` å¯¹è±¡çš„ `getChannelRef` æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```ts
@MessagePattern('notifications')
getNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {
  console.log(context.getChannelRef());
}
```

## æ¶ˆæ¯ç¡®è®¤ï¼ˆMessage acknowledgementï¼‰

ä¸ºäº†ç¡®ä¿æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼ŒRabbitMQ æ”¯æŒ[æ¶ˆæ¯ç¡®è®¤æœºåˆ¶](https://www.rabbitmq.com/confirms.html)ã€‚æ¶ˆè´¹è€…ä¼šå‘ RabbitMQ å‘é€ä¸€ä¸ªç¡®è®¤ï¼ˆacknowledgementï¼‰ï¼Œå‘ŠçŸ¥ RabbitMQ æŸæ¡æ¶ˆæ¯å·²è¢«æ¥æ”¶å’Œå¤„ç†ï¼ŒRabbitMQ å¯ä»¥å®‰å…¨åœ°å°†å…¶åˆ é™¤ã€‚å¦‚æœæ¶ˆè´¹è€…åœ¨æœªå‘é€ç¡®è®¤çš„æƒ…å†µä¸‹ç»ˆæ­¢ï¼ˆå¦‚å…¶é€šé“å…³é—­ã€è¿æ¥å…³é—­æˆ– TCP è¿æ¥ä¸¢å¤±ï¼‰ï¼ŒRabbitMQ ä¼šè®¤ä¸ºè¯¥æ¶ˆæ¯å°šæœªè¢«å®Œæ•´å¤„ç†ï¼Œå¹¶ä¼šå°†å…¶é‡æ–°å…¥é˜Ÿã€‚

è¦å¯ç”¨æ‰‹åŠ¨ç¡®è®¤æ¨¡å¼ï¼Œéœ€è¦å°† `noAck` å±æ€§è®¾ç½®ä¸º `false`ï¼š

```ts
options: {
  urls: ['amqp://localhost:5672'],
  queue: 'cats_queue',
  noAck: false,
  queueOptions: {
    durable: false
  },
},
```

å½“å¼€å¯æ‰‹åŠ¨æ¶ˆè´¹è€…ç¡®è®¤åï¼Œå¿…é¡»ç”±å·¥ä½œè¿›ç¨‹ï¼ˆworkerï¼‰ä¸»åŠ¨å‘é€ç¡®è®¤ï¼Œå‘ŠçŸ¥ä»»åŠ¡å·²å®Œæˆã€‚

```ts
@MessagePattern('notifications')
getNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {
  const channel = context.getChannelRef();
  const originalMsg = context.getMessage();

  channel.ack(originalMsg);
}
```

## æ¶ˆæ¯æ„å»ºå™¨ï¼ˆRecord buildersï¼‰

å¦‚éœ€é…ç½®æ¶ˆæ¯é€‰é¡¹ï¼Œå¯ä»¥ä½¿ç”¨ `RmqRecordBuilder` ç±»ï¼ˆæ³¨æ„ï¼šäº‹ä»¶é©±åŠ¨æµç¨‹åŒæ ·é€‚ç”¨ï¼‰ã€‚ä¾‹å¦‚ï¼Œè¦è®¾ç½® `headers` å’Œ `priority` å±æ€§ï¼Œå¯ä»¥ä½¿ç”¨ `setOptions` æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```ts
import { RmqRecordBuilder } from '@nestjs/microservices'

const message = ':cat:';
const record = new RmqRecordBuilder(message)
  .setOptions({
    headers: {
      ['x-version']: '1.0.0',
    },
    priority: 3,
  })
  .build();

this.client.send('replace-emoji', record).subscribe(...);
```

ä½ ä¹Ÿå¯ä»¥åœ¨æœåŠ¡ç«¯é€šè¿‡è®¿é—® `RmqContext` è¯»å–è¿™äº›å€¼ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```ts
@MessagePattern('replace-emoji')
replaceEmoji(@Payload() data: string, @Ctx() context: RmqContext): string {
  const { properties: { headers } } = context.getMessage();
  return headers['x-version'] === '1.0.0' ? 'ğŸ±' : 'ğŸˆ';
}
```

## å®ä¾‹çŠ¶æ€æ›´æ–°

è¦å®æ—¶è·å–è¿æ¥çŠ¶æ€ä»¥åŠåº•å±‚é©±åŠ¨å®ä¾‹çš„çŠ¶æ€æ›´æ–°ï¼Œå¯ä»¥è®¢é˜… `status` æµã€‚è¯¥æµä¼šæ ¹æ®æ‰€é€‰é©±åŠ¨æä¾›ç‰¹å®šçš„çŠ¶æ€æ›´æ–°ã€‚ä»¥ RMQ é©±åŠ¨ä¸ºä¾‹ï¼Œ`status` æµä¼šå‘å‡º `connected`ï¼ˆå·²è¿æ¥ï¼‰å’Œ `disconnected`ï¼ˆå·²æ–­å¼€ï¼‰äº‹ä»¶ã€‚

```ts
import { RmqStatus } from '@nestjs/microservices'

this.client.status.subscribe((status: RmqStatus) => {
  console.log(status)
})
```

åŒæ ·åœ°ï¼Œä½ ä¹Ÿå¯ä»¥è®¢é˜…æœåŠ¡ç«¯çš„ `status` æµï¼Œä»¥ä¾¿æ¥æ”¶æœåŠ¡ç«¯çŠ¶æ€çš„é€šçŸ¥ã€‚

```ts
const server = app.connectMicroservice<MicroserviceOptions>(...);
server.status.subscribe((status: RmqStatus) => {
  console.log(status);
});
```

## ç›‘å¬ RabbitMQ äº‹ä»¶

åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œä½ å¯èƒ½å¸Œæœ›ç›‘å¬å¾®æœåŠ¡å†…éƒ¨å‘å‡ºçš„äº‹ä»¶ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ç›‘å¬ `error`ï¼ˆé”™è¯¯ï¼‰äº‹ä»¶ï¼Œåœ¨å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘é¢å¤–æ“ä½œã€‚ä¸ºæ­¤ï¼Œå¯ä»¥ä½¿ç”¨ `on()` æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```ts
this.client.on('error', (err) => {
  console.error(err)
})
```

åŒæ ·åœ°ï¼Œä¹Ÿå¯ä»¥ç›‘å¬æœåŠ¡ç«¯çš„å†…éƒ¨äº‹ä»¶ï¼š

```ts
import type { RmqEvents } from '@nestjs/microservices'

server.on<RmqEvents>('error', (err) => {
  console.error(err)
})
```

## åº•å±‚é©±åŠ¨è®¿é—®

åœ¨æ›´é«˜çº§çš„ç”¨ä¾‹ä¸­ï¼Œä½ å¯èƒ½éœ€è¦è®¿é—®åº•å±‚é©±åŠ¨å®ä¾‹ã€‚è¿™åœ¨éœ€è¦æ‰‹åŠ¨å…³é—­è¿æ¥æˆ–ä½¿ç”¨é©±åŠ¨ç‰¹æœ‰æ–¹æ³•ç­‰åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨ã€‚ä½†è¯·æ³¨æ„ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ **æ— éœ€**ç›´æ¥è®¿é—®é©±åŠ¨ã€‚

è¦å®ç°è¿™ä¸€ç‚¹ï¼Œå¯ä»¥ä½¿ç”¨ `unwrap()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›åº•å±‚é©±åŠ¨å®ä¾‹ã€‚æ³›å‹ç±»å‹å‚æ•°åº”æŒ‡å®šä½ æœŸæœ›çš„é©±åŠ¨å®ä¾‹ç±»å‹ã€‚

```ts
const managerRef = this.client.unwrap<import('amqp-connection-manager').AmqpConnectionManager>()
```

åŒæ ·åœ°ï¼Œä½ ä¹Ÿå¯ä»¥è®¿é—®æœåŠ¡ç«¯çš„åº•å±‚é©±åŠ¨å®ä¾‹ï¼š

```ts
const managerRef = server.unwrap<import('amqp-connection-manager').AmqpConnectionManager>()
```

## é€šé…ç¬¦

RabbitMQ æ”¯æŒåœ¨è·¯ç”±é”®ä¸­ä½¿ç”¨é€šé…ç¬¦ï¼Œä»è€Œå®ç°çµæ´»çš„æ¶ˆæ¯è·¯ç”±ã€‚`#` é€šé…ç¬¦å¯ä»¥åŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªå•è¯ï¼Œè€Œ `*` é€šé…ç¬¦åªèƒ½åŒ¹é…ä¸€ä¸ªå•è¯ã€‚

ä¾‹å¦‚ï¼Œè·¯ç”±é”® `cats.#` å¯ä»¥åŒ¹é… `cats`ã€`cats.meow` å’Œ `cats.meow.purr`ã€‚è·¯ç”±é”® `cats.*` å¯ä»¥åŒ¹é… `cats.meow`ï¼Œä½†ä¸èƒ½åŒ¹é… `cats.meow.purr`ã€‚

è¦åœ¨ RabbitMQ å¾®æœåŠ¡ä¸­å¯ç”¨é€šé…ç¬¦æ”¯æŒï¼Œéœ€è¦åœ¨é…ç½®å¯¹è±¡ä¸­å°† `wildcards` é€‰é¡¹è®¾ç½®ä¸º `true`ï¼š

```ts
const app = await NestFactory.createMicroservice<MicroserviceOptions>(AppModule, {
  transport: Transport.RMQ,
  options: {
    urls: ['amqp://localhost:5672'],
    queue: 'cats_queue',
    wildcards: true,
  },
})
```

é…ç½®å®Œæˆåï¼Œä½ å¯ä»¥åœ¨è®¢é˜…äº‹ä»¶æˆ–æ¶ˆæ¯æ—¶ä½¿ç”¨é€šé…ç¬¦è·¯ç”±é”®ã€‚ä¾‹å¦‚ï¼Œç›‘å¬è·¯ç”±é”®ä¸º `cats.#` çš„æ¶ˆæ¯ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š

```ts
@MessagePattern('cats.#')
getCats(@Payload() data: { message: string }, @Ctx() context: RmqContext) {
  console.log(`æ”¶åˆ°è·¯ç”±é”®ä¸º: ${context.getPattern()} çš„æ¶ˆæ¯`)

  return {
    message: 'æ¥è‡ª cats æœåŠ¡çš„é—®å€™ï¼',
  }
}
```

è¦å‘é€å¸¦æœ‰ç‰¹å®šè·¯ç”±é”®çš„æ¶ˆæ¯ï¼Œå¯ä»¥ä½¿ç”¨ `ClientProxy` å®ä¾‹çš„ `send()` æ–¹æ³•ï¼š

```ts
this.client.send('cats.meow', { message: 'Meow!' }).subscribe((response) => {
  console.log(response)
})
```
