# 压缩

压缩（Compression）能够显著减小响应体体积，从而提升 Web 应用的响应速度。

对于**高并发**的生产环境网站，强烈建议将压缩操作从应用服务器中剥离，交由反向代理（如 Nginx）处理。在这种场景下，不建议在应用中使用压缩中间件。

## 在 Express（默认）中使用

你可以通过 [compression](https://github.com/expressjs/compression) 中间件包为应用启用 gzip 压缩。

首先安装依赖：

```bash
$ npm i --save compression
$ npm i --save-dev @types/compression
```

安装完成后，将 compression 作为全局中间件应用到应用实例上：

```ts
import * as compression from 'compression'
// 在初始化文件中
app.use(compression())
```

## 在 Fastify 中使用

如果你使用的是 `FastifyAdapter`，推荐使用 [fastify-compress](https://github.com/fastify/fastify-compress) 包：

```bash
$ npm i --save @fastify/compress
```

安装后，将 `@fastify/compress` 注册为全局中间件：

```ts
import compression from '@fastify/compress'
// 在初始化文件中
await app.register(compression)
```

默认情况下，`@fastify/compress` 会在浏览器支持时优先使用 Brotli 压缩（Brotli 需 Node >= 11.7.0）。Brotli 通常具备更高的压缩比，但压缩速度可能较慢。Brotli 的最大压缩质量为 11。你可以通过调整 `BROTLI_PARAM_QUALITY`（取值范围 0 ~ 11）来平衡压缩时间和响应速度。以下示例将质量设置为 4：

```ts
import { constants } from 'zlib'
// 在初始化文件中
await app.register(compression, {
  brotliOptions: { params: { [constants.BROTLI_PARAM_QUALITY]: 4 } },
})
```

如果你希望简化配置，也可以让 `fastify-compress` 仅使用 deflate 和 gzip 两种压缩方式。这样虽然响应体可能更大，但传输速度会更快。

要指定压缩编码格式，可以为 `app.register` 提供第二个参数：

```ts
await app.register(compression, { encodings: ['gzip', 'deflate'] })
```

上述配置会让 `fastify-compress` 仅使用 gzip 和 deflate，并在客户端同时支持时优先选择 gzip。
