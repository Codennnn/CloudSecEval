# 独立应用

Nest 提供了多种创建和运行应用的方式。你可以创建一个 Web 应用、一个微服务，或者是一个不监听任何网络端口的纯 Nest **独立应用 (Standalone application)**。Nest 独立应用本质上是对 Nest IoC 容器的一层封装，该容器管理着所有实例化的类。通过这个独立应用对象，你可以直接获取任何已导入模块中存在的实例。这意味着，你可以在任何场景下利用 Nest 的能力，例如在编写 CRON 定时任务脚本时，甚至可以基于它来构建你自己的命令行工具。

## 快速开始

使用以下代码可以创建一个 Nest 独立应用：

```ts
async function bootstrap() {
  const app = await NestFactory.createApplicationContext(AppModule)
  // 应用逻辑...
}
bootstrap()
```

## 从静态模块获取提供者

独立应用对象允许你获取在 Nest 应用中注册的任何提供者实例。假设 `AppModule` 导入了 `TasksModule`，而 `TasksModule` 中包含一个 `TasksService` 提供者。现在，我们希望在 CRON 任务中调用 `TasksService` 提供的方法。

```ts
const tasksService = app.get(TasksService)
```

要访问 `TasksService` 实例，我们使用 `get()` 方法。`get()` 方法就像一个查询函数，它会在所有已注册的模块中搜索对应的提供者实例。你可以向它传递任何提供者的令牌 (token)。

如果你想进行严格的上下文检查，可以向 `get()` 方法传递一个包含 `strict: true` 属性的选项对象。启用此选项后，你必须先选择一个特定的模块，然后才能从该模块的上下文中获取实例。

```ts
const tasksService = app.select(TasksModule).get(TasksService, { strict: true })
```

下面是独立应用对象可用的实例获取方法的简要说明：

| 方法       | 描述                                                                             |
| ---------- | -------------------------------------------------------------------------------- |
| `get()`    | 获取应用上下文中任何可用的控制器或提供者（包括守卫、过滤器等）的实例。           |
| `select()` | 在模块图中导航，用于从特定模块中提取实例（通常与严格模式结合使用，如上例所示）。 |

<CalloutInfo>
  直接调用 `app.get()` 将从根模块开始搜索。若要从其他模块（而非根模块）中获取实例，你需要先使用
  `app.select()` 来指定该模块。
</CalloutInfo>

需要注意的是，独立应用不监听网络端口，因此它不会接收 HTTP 请求。这意味着，所有依赖于请求-响应周期的 Nest 特性（如中间件、拦截器、大部分管道和守卫）在独立应用上下文中都无法自动生效。

例如，即便你通过 `app.get()` 获取了一个控制器实例并调用了它的方法，绑定到该方法的拦截器也不会被触发。

## 从动态模块获取提供者

当你使用[动态模块](/fundamentals/dynamic-modules)时，你需要将动态模块注册时返回的对象传递给 `app.select()` 方法。例如：

```ts
export const dynamicConfigModule = ConfigModule.register({ folder: './config' })

@Module({
  imports: [dynamicConfigModule],
})
export class AppModule {}
```

然后，你就可以用这个对象来选择模块：

```ts
const configService = app.select(dynamicConfigModule).get(ConfigService, { strict: true })
```

## 关闭应用

如果你希望 Node.js 进程在脚本执行完毕后自动退出（例如，在运行 CRON 任务的脚本中），你需要在 `bootstrap` 函数的末尾调用 `app.close()` 方法，如下所示：

```ts
async function bootstrap() {
  const app = await NestFactory.createApplicationContext(AppModule)
  // 应用逻辑...
  await app.close()
}
bootstrap()
```

如[生命周期事件](/fundamentals/lifecycle-events)一章所述，此调用将触发应用的关闭生命周期钩子 (shutdown lifecycle hooks)。

## 示例

你可以在[这里](https://github.com/nestjs/nest/tree/master/sample/18-context)找到一个完整的示例。
