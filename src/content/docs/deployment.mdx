import mauImage from '/public/assets/mau-metrics.png'

# 部署

准备好将你的 NestJS 应用推向生产环境了吗？本指南将为你介绍部署过程中的关键技巧与最佳实践，确保你的应用高效、稳定地运行。

## 前置条件

在部署 NestJS 应用前，需确保已满足以下条件：

- 一个可供部署的 NestJS 应用。
- 能够访问目标部署平台或服务器。
- 已为应用配置好所有必要的环境变量。
- 应用所依赖的服务（如数据库）已配置且可用。
- 部署平台已安装 Node.js（LTS 或更高版本）。

<CalloutInfo>
  <div>
    如果你正在寻找基于云的 NestJS 部署方案，可以考虑我们官方推出的 AWS 云部署平台 [Mau](https://mau.nestjs.com/)。通过 Mau，仅需几次点击和一条命令即可完成部署：
  </div>

```bash
$ npm install -g @nestjs/mau
$ mau deploy
```

  <div className="mt-5">
    部署完成后，你的 NestJS 应用将在数秒内于 AWS 上启动并运行。
  </div>
</CalloutInfo>

## 构建应用

构建 NestJS 应用，指的是将 TypeScript 源码编译为 JavaScript。该过程会生成一个 `dist` 目录，其中包含可执行的 JavaScript 文件。你可以运行以下命令来构建应用：

```bash
$ npm run build
```

该命令底层通常运行的是 `nest build`，它封装了 TypeScript 编译器 (`tsc`) 并提供了资源文件复制等额外功能。当然，你也可以运行自定义的构建脚本。此外，如果你的项目采用 Monorepo 模式，构建时需要将项目名称作为参数传入（例如 `npm run build my-app`）。

编译成功后，项目根目录下会生成一个 `dist` 目录，其中包含编译后的文件，其入口文件通常是 `main.js`。如果项目根目录中存在 `.ts` 文件（并且 `tsconfig.json` 配置了对其的编译），这些文件也会被复制到 `dist` 目录，这可能会改变输出目录的结构（例如，入口文件路径可能变为 `dist/src/main.js`）。配置服务器时，请留意最终的入口文件路径。

## 生产环境

生产环境是应用面向最终用户运行的环境。它可以是云平台（如 [AWS](https://aws.amazon.com/) 的 EC2、ECS，[Azure](https://azure.microsoft.com/)，[Google Cloud](https://cloud.google.com/)），也可以是自主管理的私有服务器（如 [Hetzner](https://www.hetzner.com/)）。

为简化部署流程、避免手动配置，可以使用 Mau 等服务。Mau 是我们官方推出的 AWS 部署平台。

使用云平台或 [Mau](https://mau.nestjs.com/) 这类服务的优势包括：

- **可扩展性**：随着用户增长，轻松扩展应用。
- **安全性**：利用内置的安全特性和合规认证。
- **监控能力**：实时监控应用性能和健康状况。
- **高可用性**：高可用性保障，确保应用持续在线。

需要注意的是，云平台通常比自托管服务器的成本更高，并且对底层基础设施的控制也更少。如果具备相应的技术能力，使用 VPS 也是一种高性价比的选择，但这需要自行负责服务器的维护、安全和备份等工作。

## NODE_ENV=production

虽然 Node.js 和 NestJS 在技术上并未严格区分开发环境与生产环境，但在生产环境中运行应用时，强烈建议将 `NODE_ENV` 环境变量设置为 `production`，许多第三方库会读取该变量以优化自身行为（例如，关闭调试日志等）。

启动应用时，可以通过以下方式设置 `NODE_ENV` 环境变量：

```bash
$ NODE_ENV=production node dist/main.js
```

你也可以在云服务提供商或 Mau 的管理面板中直接配置此环境变量。

## 运行应用

在生产环境中，使用以下命令运行你的 NestJS 应用：

```bash
$ node dist/main.js # 请根据你的入口文件实际路径进行调整
```

该命令将启动应用，并监听你在代码中指定的端口（默认为 `3000`）。

此外，也可以使用 `nest start` 命令。它封装了 `node dist/main.js` 命令，其关键区别在于：`nest start` 会在启动前自动执行 `nest build`，因此无需再手动构建。

## 健康检查

健康检查是监控生产环境中 NestJS 应用状态的关键一环。通过设置健康检查端点，可以定期验证应用是否正常运行，以便在问题升级前及时响应。

在 NestJS 中，可以使用 `@nestjs/terminus` 包轻松实现健康检查。该包提供了强大的工具集，可用于检查数据库连接、外部服务状态以及添加自定义检查。

请参考[这篇指南](/recipes/terminus)，了解如何在 NestJS 应用中实现健康检查，以确保应用始终处于受监控的可响应状态。

## 日志记录

日志记录是任何生产级应用的重要组成部分，它有助于追踪错误、监控应用行为和排查问题。在 NestJS 中，可以使用内置的日志记录器来管理日志，也可以根据需要集成更强大的第三方库。

日志记录最佳实践：

- **记录有意义的错误**：专注于记录包含详细上下文的错误信息，以便于调试和定位问题。
- **避免记录敏感数据**：不应记录密码或令牌等敏感信息，以防信息泄露。
- **使用关联 ID**：在分布式系统中，建议在日志中包含唯一标识（如关联 ID），以便跨服务追踪请求。
- **合理使用日志级别**：根据严重程度对日志进行分类（如 `info`、`warn`、`error`），并在生产环境中禁用 `debug` 或 `verbose` 级别的日志，以减少噪音。

<CalloutInfo>
  如果在 AWS 上运行应用（无论是通过 Mau 还是直接部署），建议使用 JSON
  格式的日志，以方便机器解析和数据分析。
</CalloutInfo>

对于分布式应用，建议采用集中式日志服务，如 ElasticSearch、Loggly 或 Datadog。这些工具提供了日志聚合、检索和可视化等强大功能，从而可以更高效地监控和分析应用的性能与行为。

## 应用扩展

有效地扩展 NestJS 应用，是应对流量增长和保障应用性能的关键。扩展策略主要分为两种：**垂直扩展**（vertical scaling） 和**水平扩展**（horizontal scaling）。理解这两种方式的差异，有助于为应用设计合理的扩展方案以应对高负载。

垂直扩展，也称“向上扩展” (Scale-up)，指通过为单台服务器增加更多资源（如 CPU、内存、存储）来提升其处理能力。其主要特点如下：

- **实现简单**：垂直扩展通常更易于实施，只需升级现有服务器即可，无需管理多个实例。
- **存在上限**：单台服务器的资源终有物理极限，达到容量上限后便无法继续扩展。
- **成本效益**：对于中等流量的应用，垂直扩展通常更具成本效益，因为它不涉及额外的基础设施管理。

例如，如果一个 NestJS 应用部署在虚拟机上，并在高峰时段运行缓慢，可以将其虚拟机实例升级为更大规格。这通常只需要在云服务商的控制台中选择一个更高配置的实例类型即可完成。

水平扩展，也称“向外扩展” (Scale-out)，指通过增加服务器实例的数量来分担应用负载。这种方式在云环境中被广泛采用，尤其适用于高流量场景。其主要优势如下：

- **高可扩展性**：可以几乎无上限地增加应用实例来处理更多并发请求，而不会影响性能。
- **高可用性**：水平扩展天然具备冗余。单个实例发生故障不会导致整个应用中断，流量会被自动路由到其他健康实例。
- **依赖负载均衡**：为了有效地在多个实例间分配流量，必须使用负载均衡器（如 Nginx 或 AWS Elastic Load Balancing）。

例如，当 NestJS 应用面临流量激增时，可以在云环境中启动多个应用实例，并使用负载均衡器将请求分发到这些实例上，以确保没有单个实例过载。

借助 [Docker](https://www.docker.com/) 等容器化技术和 [Kubernetes](https://kubernetes.io/) 等容器编排平台，可以极大地简化这一过程。此外，也可以利用云服务商提供的负载均衡器（如 [AWS Elastic Load Balancing](https://aws.amazon.com/elasticloadbalancing/) 或 [Azure Load Balancer](https://azure.microsoft.com/en-us/services/load-balancer/)）来分发流量。

<CalloutInfo>
  Mau 内置了对 AWS 水平扩展的支持，可以让你轻松部署和管理多个 NestJS 应用实例。
</CalloutInfo>

## 其他注意事项

部署 NestJS 应用时，还应考虑以下几点：

- **安全性**：确保应用具备安全防护能力，防范 SQL 注入、XSS 等常见网络威胁。更多信息请参见"安全"相关章节。
- **监控**：建议使用 [Prometheus](https://prometheus.io/) 或 [New Relic](https://newrelic.com/) 等工具，实时追踪应用的性能和健康状况。云服务商通常也提供内置的监控服务（如 [AWS CloudWatch](https://aws.amazon.com/cloudwatch/)）。
- **敏感信息管理**：请勿在代码中硬编码 API 密钥、密码或令牌等敏感信息。应使用环境变量或密钥管理服务来安全地存储和访问这些值。
- **数据备份**：定期备份数据，以防数据意外丢失。
- **自动化部署**：通过 CI/CD 流水线实现部署流程自动化，确保各环境之间的一致性。
- **限流保护**：实现限流机制，以防范服务滥用并保护应用免受 DDoS 攻击。详细内容可参考[限流章节](/security/rate-limiting)，或使用 [AWS WAF](https://aws.amazon.com/waf/) 等服务实现更高级的防护。

## 构建 Docker 镜像

[Docker](https://www.docker.com/) 是一个利用容器化 (containerization) 技术的平台，它允许开发者将应用及其依赖打包成一个标准化的单元，即**容器**（container）。容器具有轻量、可移植、隔离性强等特点，非常适合在从开发、测试到生产的整个流程中部署应用。

将 NestJS 应用容器化的优势：

- **一致性**：Docker 确保应用在任何机器上都以相同方式运行，从而解决了"但在我这台机器上能跑"的经典问题。
- **隔离性**：每个容器都在独立的环境中运行，避免了依赖冲突。
- **可扩展性**：通过 Docker，可以轻松地在多台机器或云实例上运行多个容器，实现应用的水平扩展。
- **可移植性**：容器可以在不同环境间自由迁移，便于在多平台部署应用。

请参考[官方安装指南](https://www.docker.com/get-started)安装 Docker。安装完成后，在 NestJS 项目根目录下创建一个名为 `Dockerfile` 的文件，用以定义构建容器镜像的步骤。

`Dockerfile` 是一个文本文件，包含了 Docker 构建容器镜像所需的全部指令。

为了优化镜像大小并加快构建速度，推荐使用**多阶段构建**（multi-stage build）。下面是一个更优化的 `Dockerfile` 示例：

```dockerfile
# ---- Base Stage ----
# 定义基础阶段，使用官方 Node.js 镜像，并设置工作目录
FROM node:20 AS base
WORKDIR /usr/src/app
# 复制 package.json 和 lock 文件
COPY package*.json ./

# ---- Dependencies Stage ----
# 定义依赖安装阶段，仅安装生产环境所需依赖
FROM base AS dependencies
RUN npm ci --only=production

# ---- Build Stage ----
# 定义构建阶段，安装所有依赖（包括 devDependencies）以运行构建脚本
FROM base AS build
RUN npm install
# 复制所有项目文件
COPY . .
# 运行构建命令
RUN npm run build

# ---- Release Stage ----
# 定义最终的生产镜像阶段，使用更轻量的 alpine 镜像
FROM node:20-alpine AS release
WORKDIR /usr/src/app
# 从 dependencies 阶段复制生产依赖
COPY --from=dependencies /usr/src/app/node_modules ./node_modules
# 从 build 阶段复制编译后的代码
COPY --from=build /usr/src/app/dist ./dist
# 暴露应用端口
EXPOSE 3000
# 启动应用
CMD ["node", "dist/main"]
```

<CalloutInfo>
  请注意，你应该根据项目需要将 `node:20` 替换为合适的 Node.js 版本。所有可用的 Node.js 镜像都可以在
  [Docker Hub 官方仓库](https://hub.docker.com/_/node)中找到。
</CalloutInfo>

这个多阶段构建的 `Dockerfile` 具有以下优势：

- **更小的镜像体积**：最终的生产镜像 (`release` 阶段) 只包含运行应用所必需的生产依赖和编译后的代码，不包含开发依赖和源代码，体积大大减小。
- **更佳的缓存利用**：通过分阶段构建，可以更好地利用 Docker 的构建缓存。例如，只有在 `package.json` 发生变化时，`dependencies` 阶段才会重新执行。
- **更高的安全性**：生产镜像中不包含源代码和开发工具，减少了潜在的攻击面。

建议同时创建 `.dockerignore` 文件，指定在构建镜像时需要忽略的文件和目录。在项目根目录下新建 `.dockerignore` 文件，内容如下：

```bash
node_modules
dist
*.log
*.md
.git
```

该文件可以确保无关文件和目录不会被复制到构建上下文中，从而避免它们被不必要地打包进镜像，有助于减小镜像体积。

创建好 `Dockerfile` 和 `.dockerignore` 文件后，就可以构建 Docker 镜像了。在项目根目录中，打开终端并执行以下命令：

```bash
docker build -t my-nestjs-app .
```

命令说明：

- `-t my-nestjs-app`：为镜像指定一个名称和标签 (tag)。
- `.`：指定 Docker 的构建上下文 (build context) 为当前目录。

镜像构建完成后，可以通过以下命令以容器方式运行应用：

```bash
docker run -p 3000:3000 my-nestjs-app
```

命令说明：

- `-p 3000:3000`：将主机的 3000 端口映射到容器的 3000 端口。
- `my-nestjs-app`：指定要运行的镜像。

此时，你的 NestJS 应用已在 Docker 容器中成功运行。

若要将 Docker 镜像部署到云平台或与他人共享，需要将其推送到一个 Docker 镜像仓库，例如 [Docker Hub](https://hub.docker.com/)、[AWS ECR](https://aws.amazon.com/ecr/) 或 [Google Container Registry](https://cloud.google.com/container-registry) 等。

以 Docker Hub 为例，推送镜像的步骤如下：

```bash
docker login # 登录 Docker 仓库
docker tag my-nestjs-app your-dockerhub-username/my-nestjs-app # 给镜像打上包含用户名的标签
docker push your-dockerhub-username/my-nestjs-app # 推送镜像
```

请将 `your-dockerhub-username` 替换为你的 Docker Hub 用户名或组织名。推送成功后，该镜像就可以在任何能够访问此仓库的机器上被拉取和运行。

所有主流云服务商（AWS、Azure、Google Cloud 等）都提供了托管容器服务（如 AWS ECS、Azure Container Instances、Google Kubernetes Engine 等），可以帮助你高效地部署和管理大规模容器化应用。这些服务通常内置了自动扩展、负载均衡和监控等功能，使 NestJS 应用的生产部署更加简单。

## 使用 Mau 轻松部署

[Mau](https://mau.nestjs.com/) 是 NestJS 官方推出的一款基于 [AWS](https://aws.amazon.com/) 的应用部署平台。对于不想手动管理基础设施或希望节省部署时间的开发者而言，Mau 是一个理想的选择。

Mau 旨在简化基础设施的配置与维护。其简洁直观的设计，可以让你专注于应用开发，而无需深入了解底层基础设施的复杂性。Mau 底层基于 AWS 构建，在提供强大可靠平台的同时，也屏蔽了 AWS 的复杂性，代你处理繁琐的配置与管理工作，使你能够专注于业务本身。

Mau 适用于从初创公司到大型企业的各类团队，尤其是那些希望快速上线，而不想投入大量时间学习和管理基础设施的开发者。其上手过程非常简单，几分钟内即可让基础设施准备就绪。Mau 在后台深度集成 AWS，让你在享受 AWS 强大功能的同时，无需处理其固有的复杂性。

<DocImage src={mauImage} alt="Mau Metrics" />

使用 Mau，你可以实现：

- 仅需几次点击，即可部署 NestJS 应用（包括 API、微服务等）。
- 轻松配置数据库，如：
  - PostgreSQL
  - MySQL
  - MongoDB (DocumentDB)
  - Redis
  - 以及更多
- 配置消息代理，例如：
  - RabbitMQ
  - Kafka
  - NATS
- 部署定时任务（**CRON 作业**）和后台工作者。
- 部署 Lambda 函数和无服务器应用。
- 配置 **CI/CD 流水线**，实现自动化部署。
- 以及更多功能。

要通过 Mau 部署 NestJS 应用，只需运行以下命令：

```bash
$ npm install -g @nestjs/mau
$ mau deploy
```

现在就注册并[开始使用 Mau 部署](https://mau.nestjs.com/)，让你的 NestJS 应用在几分钟内运行在 AWS 上。
