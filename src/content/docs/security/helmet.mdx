# Helmet

[Helmet](https://github.com/helmetjs/helmet) 可以通过设置适当的 HTTP 标头来帮助应用抵御一些常见的 Web 安全漏洞。它本身是多个小型中间件函数的集合，每个函数负责设置一个与安全相关的 HTTP 标头（详情请参阅[官方文档](https://github.com/helmetjs/helmet#how-it-works)）。

<CalloutInfo>
  请注意，无论是全局中间件还是局部中间件，`helmet` 都必须在其他 `app.use()` 调用或路由定义**之前**
  注册。底层平台会根据注册顺序来应用中间件和路由。如果在路由定义之后再应用 `helmet` 或 `cors`
  这类中间件，那么它们将无法作用于之前定义的路由。
</CalloutInfo>

## 在 Express (默认) 中使用

首先，安装所需依赖：

```bash
$ npm i --save helmet
```

然后，将其作为全局中间件应用。

```ts
import helmet from 'helmet'

// 在应用初始化文件中
app.use(helmet())
```

<CalloutInfo>
  <div>
  如果同时使用 `helmet`、`@apollo/server` (v4) 和 [Apollo Sandbox](/graphql/quick-start#apollo-sandbox)，可能会因 [CSP（内容安全策略）](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP) 冲突而导致 Sandbox 无法加载。为解决此问题，请按如下方式配置 `helmet`：
  </div>

```ts
app.use(
  helmet({
    crossOriginEmbedderPolicy: false,
    contentSecurityPolicy: {
      directives: {
        imgSrc: [`'self'`, 'data:', 'apollo-server-landing-page.cdn.apollographql.com'],
        scriptSrc: [`'self'`, `https: 'unsafe-inline'`],
        manifestSrc: [`'self'`, 'apollo-server-landing-page.cdn.apollographql.com'],
        frameSrc: [`'self'`, 'sandbox.embed.apollographql.com'],
      },
    },
  })
)
```

</CalloutInfo>

## 在 Fastify 中使用

若使用 `FastifyAdapter`，请安装 `@fastify/helmet` 包：

```bash
$ npm i --save @fastify/helmet
```

与 Express 不同，`@fastify/helmet` 不应作为中间件使用，而应通过 `app.register()` 方法注册为 [Fastify 插件](https://www.fastify.io/docs/latest/Reference/Plugins/)：

```ts
import helmet from '@fastify/helmet'

// 在应用初始化文件中
await app.register(helmet)
```

<CalloutInfo type="warning">
  <div>
  若同时使用 `apollo-server-fastify` 和 `@fastify/helmet`，GraphQL Playground 可能会因 CSP 冲突而无法加载。为解决此问题，请按如下方式配置：
  </div>

```ts
await app.register(fastifyHelmet, {
  contentSecurityPolicy: {
    directives: {
      defaultSrc: [`'self'`, 'unpkg.com'],
      styleSrc: [
        `'self'`,
        `'unsafe-inline'`,
        'cdn.jsdelivr.net',
        'fonts.googleapis.com',
        'unpkg.com',
      ],
      fontSrc: [`'self'`, 'fonts.gstatic.com', 'data:'],
      imgSrc: [`'self'`, 'data:', 'cdn.jsdelivr.net'],
      scriptSrc: [`'self'`, `https: 'unsafe-inline'`, `cdn.jsdelivr.net`, `'unsafe-eval'`],
    },
  },
})

// 若要完全禁用 CSP，可进行如下配置：
await app.register(fastifyHelmet, {
  contentSecurityPolicy: false,
})
```

</CalloutInfo>
