# èº«ä»½éªŒè¯

èº«ä»½éªŒè¯ï¼ˆAuthenticationï¼‰æ˜¯ç»å¤§å¤šæ•°åº”ç”¨ä¸­ä¸å¯æˆ–ç¼ºçš„åŸºç¡€åŠŸèƒ½ã€‚å®ç°èº«ä»½éªŒè¯çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œå…·ä½“é‡‡ç”¨å“ªç§æ–¹æ¡ˆï¼Œé€šå¸¸å–å†³äºé¡¹ç›®çš„ä¸šåŠ¡åœºæ™¯ä¸å®‰å…¨è¦æ±‚ã€‚æœ¬ç« å°†ä»‹ç»ä¸€ç§åŸºäº JWTï¼ˆJSON Web Tokenï¼‰çš„é€šç”¨èº«ä»½éªŒè¯æµç¨‹ï¼Œé€‚ç”¨äºå¤šç§å®é™…åœºæ™¯ã€‚

æˆ‘ä»¬å‡è®¾å®¢æˆ·ç«¯é€šè¿‡ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œç™»å½•ï¼ŒæœåŠ¡å™¨éªŒè¯æˆåŠŸåï¼Œä¼šç­¾å‘ä¸€ä¸ª JWTã€‚å®¢æˆ·ç«¯éšååœ¨æ¯æ¬¡è¯·æ±‚ä¸­ï¼Œå°†è¯¥ JWT ä»¥ [Bearer Token](https://tools.ietf.org/html/rfc6750) çš„å½¢å¼é™„åŠ åœ¨ HTTP è¯·æ±‚å¤´ä¸­çš„ `Authorization` å­—æ®µä¸­ï¼Œä»¥è¯æ˜èº«ä»½ã€‚æœåŠ¡å™¨åˆ™è´Ÿè´£éªŒè¯è¯¥ Tokenï¼Œå¹¶æ®æ­¤å†³å®šæ˜¯å¦å…è®¸è®¿é—®æŸäº›å—ä¿æŠ¤çš„èµ„æºï¼ˆå³å—ä¿æŠ¤è·¯ç”±ï¼‰ã€‚

æœ¬ç« å°†åˆ†ä¸‰ä¸ªæ­¥éª¤å®ç°è¿™ä¸€æµç¨‹ï¼š

1. å¤„ç†ç”¨æˆ·èº«ä»½éªŒè¯ï¼›
2. ç­¾å‘ JWTï¼›
3. åˆ›å»ºå—ä¿æŠ¤è·¯ç”±ï¼ŒéªŒè¯ JWT çš„æœ‰æ•ˆæ€§ã€‚

## åˆ›å»ºèº«ä»½éªŒè¯æ¨¡å—

é¦–å…ˆï¼Œä½¿ç”¨ Nest CLI åˆ›å»ºä¸€ä¸ª `AuthModule`ï¼Œå¹¶ç”Ÿæˆå…¶å¯¹åº”çš„æœåŠ¡å’Œæ§åˆ¶å™¨ï¼š

```bash
nest g module auth
nest g controller auth
nest g service auth
```

å…¶ä¸­ï¼š

- `AuthService` å°†è´Ÿè´£å¤„ç†èº«ä»½éªŒè¯çš„æ ¸å¿ƒé€»è¾‘ï¼›
- `AuthController` åˆ™æä¾›ç›¸å…³çš„ API æ¥å£ï¼Œä¾‹å¦‚ç™»å½•æ¥å£ã€‚

åœ¨å®ç°èº«ä»½éªŒè¯é€»è¾‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç”¨äºç®¡ç†ç”¨æˆ·ä¿¡æ¯çš„æœåŠ¡ã€‚ä¸ºäº†èŒè´£æ¸…æ™°ã€ç»“æ„æ¸…æ™°ï¼Œæˆ‘ä»¬å°†ç”¨æˆ·ç›¸å…³é€»è¾‘å°è£…åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ `UsersService` ä¸­ï¼š

```bash
nest g module users
nest g service users
```

### ç”¨æˆ·æœåŠ¡ï¼š`UsersService`

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ `UsersService` ç¤ºä¾‹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†ç”¨æˆ·åˆ—è¡¨ç¡¬ç¼–ç åœ¨å†…å­˜ä¸­ï¼Œå¹¶æä¾›ä¸€ä¸ªé€šè¿‡ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·çš„æ–¹æ³•ã€‚ä½ å¯ä»¥å°†å…¶è§†ä¸ºä¸€ä¸ªæœ€å°å¯è¿è¡Œçš„åŸå‹ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæ¨èä½¿ç”¨æ•°æ®åº“ï¼ˆå¦‚ PostgreSQL æˆ– MongoDBï¼‰ï¼Œå¹¶ç»“åˆ ORMï¼ˆå¦‚ TypeORMã€Sequelizeã€Mongooseï¼‰è¿›è¡Œç”¨æˆ·æ•°æ®çš„æŒä¹…åŒ–ç®¡ç†ã€‚

```ts filename='users/users.service.ts'
import { Injectable } from '@nestjs/common'

// åœ¨çœŸå®é¡¹ç›®ä¸­ï¼Œåº”å®šä¹‰ User æ¥å£æˆ–å®ä½“ç±»
export type User = any

@Injectable()
export class UsersService {
  private readonly users = [
    {
      userId: 1,
      username: 'john',
      password: 'changeme',
    },
    {
      userId: 2,
      username: 'maria',
      password: 'guess',
    },
  ]

  async findOne(username: string): Promise<User | undefined> {
    return this.users.find((user) => user.username === username)
  }
}
```

### å¯¼å‡º `UsersService`

ä¸ºäº†åœ¨å…¶ä»–æ¨¡å—ï¼ˆå¦‚æ¥ä¸‹æ¥è¦ç”¨åˆ°çš„ `AuthModule`ï¼‰ä¸­ä½¿ç”¨ `UsersService`ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶åœ¨ `UsersModule` ä¸­è¿›è¡Œå¯¼å‡ºï¼š

```ts filename='users/users.module.ts'
import { Module } from '@nestjs/common'
import { UsersService } from './users.service'

@Module({
  providers: [UsersService],
  exports: [UsersService], // ğŸ‘ˆ å…³é”®ï¼šè®©å…¶ä»–æ¨¡å—å¯ç”¨
})
export class UsersModule {}
```

## å®ç°ç™»å½•æ¥å£

ç”¨æˆ·è®¤è¯çš„æ ¸å¿ƒé€»è¾‘ç”± `AuthService`ï¼ˆè®¤è¯æœåŠ¡ï¼‰è´Ÿè´£ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ª `signIn()` æ–¹æ³•ï¼Œç”¨äºæ ¹æ®ç”¨æˆ·åæ£€ç´¢ç”¨æˆ·ä¿¡æ¯å¹¶éªŒè¯å¯†ç ã€‚

åœ¨è¿”å›ç»“æœæ—¶ï¼Œæˆ‘ä»¬é€šè¿‡ ES6 çš„å±•å¼€è¿ç®—ç¬¦ï¼ˆspread operatorï¼‰å‰”é™¤ `password` å­—æ®µï¼Œé¿å…å°†æ•æ„Ÿä¿¡æ¯æš´éœ²ç»™å®¢æˆ·ç«¯ã€‚è¿™ç§åšæ³•åœ¨å®é™…å¼€å‘ä¸­éå¸¸å¸¸è§ï¼Œå±äºåŸºæœ¬çš„å®‰å…¨å¤„ç†æ‰‹æ®µã€‚

```ts filename='auth/auth.service.ts'
import { Injectable, UnauthorizedException } from '@nestjs/common'
import { UsersService } from '../users/users.service'

@Injectable()
export class AuthService {
  constructor(private usersService: UsersService) {}

  async signIn(username: string, pass: string): Promise<any> {
    const user = await this.usersService.findOne(username)
    if (user?.password !== pass) {
      throw new UnauthorizedException()
    }
    const { password, ...result } = user
    // TODO: å®é™…å¼€å‘ä¸­åº”è¿”å› JWT ä»¤ç‰Œ
    // å½“å‰ä»…ä½œæ¼”ç¤ºç”¨é€”ï¼Œç›´æ¥è¿”å›ç”¨æˆ·ä¿¡æ¯
    return result
  }
}
```

<CalloutInfo type="warning">
  è¯·åŠ¡å¿…é¿å…åœ¨çœŸå®é¡¹ç›®ä¸­ä»¥æ˜æ–‡å­˜å‚¨æˆ–æ¯”å¯¹å¯†ç ã€‚åº”ä½¿ç”¨å¦‚
  [bcrypt](https://github.com/kelektiv/node.bcrypt.js#readme)
  è¿™æ ·çš„åº“ï¼Œå¯¹å¯†ç è¿›è¡ŒåŠ ç›å“ˆå¸Œã€‚ç³»ç»Ÿåªåº”ä¿å­˜åŠ å¯†åçš„å¯†ç ï¼Œå¹¶åœ¨éªŒè¯æ—¶å¯¹è¾“å…¥å¯†ç è¿›è¡ŒåŒæ ·çš„åŠ å¯†å¤„ç†è¿›è¡Œæ¯”å¯¹ã€‚æœ¬ç¤ºä¾‹ä¸ºç®€åŒ–æ¼”ç¤ºï¼Œä½¿ç”¨äº†æ˜æ–‡å¯†ç æ–¹å¼ï¼Œ**åˆ‡å‹¿åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼**
</CalloutInfo>

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `AuthModule` ä¸­å¼•å…¥ `UsersModule`ï¼Œä»¥ä¾¿åœ¨è®¤è¯æœåŠ¡ä¸­ä½¿ç”¨ç”¨æˆ·æœåŠ¡ã€‚

```ts filename='auth/auth.module.ts'
import { Module } from '@nestjs/common'
import { AuthService } from './auth.service'
import { AuthController } from './auth.controller'
import { UsersModule } from '../users/users.module'

@Module({
  imports: [UsersModule],
  providers: [AuthService],
  controllers: [AuthController],
})
export class AuthModule {}
```

ç„¶åï¼Œæ‰“å¼€ `AuthController`ï¼ˆè®¤è¯æ§åˆ¶å™¨ï¼‰ï¼Œæ·»åŠ ç”¨äºå¤„ç†ç™»å½•è¯·æ±‚çš„ `signIn()` æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šæ¥æ”¶å®¢æˆ·ç«¯æäº¤çš„ç”¨æˆ·åä¸å¯†ç ï¼Œå¹¶é€šè¿‡è®¤è¯æœåŠ¡è¿›è¡ŒéªŒè¯ï¼Œè®¤è¯é€šè¿‡åè¿”å›ç»“æœï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¿”å› JWT ä»¤ç‰Œï¼‰ã€‚

```ts filename='auth/auth.controller.ts'
import { Body, Controller, Post, HttpCode, HttpStatus } from '@nestjs/common'
import { AuthService } from './auth.service'

@Controller('auth')
export class AuthController {
  constructor(private authService: AuthService) {}

  @HttpCode(HttpStatus.OK)
  @Post('login')
  signIn(@Body() signInDto: Record<string, any>) {
    return this.authService.signIn(signInDto.username, signInDto.password)
  }
}
```

<CalloutInfo>
ä¸ºäº†æé«˜ä»£ç å¯ç»´æŠ¤æ€§å’Œç±»å‹å®‰å…¨æ€§ï¼Œå»ºè®®ä½¿ç”¨ DTOï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰ç±»æ¥å®šä¹‰è¯·æ±‚ä½“ç»“æ„ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ `Record<string, any>` ç±»å‹ã€‚æ›´å¤šå†…å®¹è¯¦è§[éªŒè¯](/techniques/validation)ç« èŠ‚ã€‚
</CalloutInfo>

## JWT ä»¤ç‰Œæ”¯æŒ

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä¸ºè®¤è¯ç³»ç»Ÿæ·»åŠ å¯¹ JWT çš„æ”¯æŒã€‚å…ˆæ˜ç¡®ä¸€ä¸‹åŠŸèƒ½ç›®æ ‡ï¼š

- å…è®¸ç”¨æˆ·é€šè¿‡ç”¨æˆ·åå’Œå¯†ç ç™»å½•ï¼Œç™»å½•æˆåŠŸåè¿”å›ä¸€ä¸ª JWTï¼Œç”¨äºè®¿é—®åç»­å—ä¿æŠ¤çš„æ¥å£ã€‚æˆ‘ä»¬å·²å®ç°äº†ç”¨æˆ·éªŒè¯çš„åŸºç¡€é€»è¾‘ï¼Œæ¥ä¸‹æ¥è¦è¡¥ä¸Š JWT çš„ç­¾å‘ã€‚
- åŸºäº JWT å®ç°è·¯ç”±ä¿æŠ¤ï¼Œä»…å…è®¸æŒæœ‰æœ‰æ•ˆä»¤ç‰Œçš„è¯·æ±‚è®¿é—®ç‰¹å®š APIã€‚

ä¸ºæ”¯æŒ JWTï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–å®‰è£…ç›¸å…³ä¾èµ–ï¼š

```bash
npm install @nestjs/jwt
```

<CalloutInfo>
  `@nestjs/jwt` æ˜¯ Nest å®˜æ–¹ç»´æŠ¤çš„ JWT
  å·¥å…·åº“ï¼Œå°è£…äº†ä»¤ç‰Œçš„ç”Ÿæˆä¸éªŒè¯é€»è¾‘ã€‚è¯¦ç»†è¯´æ˜å¯å‚è€ƒ [GitHub
  ä»“åº“](https://github.com/nestjs/jwt)ã€‚
</CalloutInfo>

### åœ¨ `AuthService` ä¸­ç”Ÿæˆ JWT

ä¸ºä¿æŒè‰¯å¥½çš„æ¨¡å—åŒ–ç»“æ„ï¼Œæˆ‘ä»¬å°†åœ¨ `AuthService` ä¸­è´Ÿè´£ç”Ÿæˆ JWTã€‚è¯·æ‰“å¼€ `auth/auth.service.ts` æ–‡ä»¶ï¼Œå¹¶æ³¨å…¥ `JwtService`ã€‚éšåï¼Œæ›´æ–° `signIn` æ–¹æ³•å¦‚ä¸‹ï¼š

```ts filename='auth/auth.service.ts'
import { Injectable, UnauthorizedException } from '@nestjs/common'
import { UsersService } from '../users/users.service'
import { JwtService } from '@nestjs/jwt'

@Injectable()
export class AuthService {
  constructor(
    private usersService: UsersService,
    private jwtService: JwtService
  ) {}

  async signIn(
    username: string,
    pass: string
  ): Promise<{ access_token: string }> {
    const user = await this.usersService.findOne(username)
    if (!user || user.password !== pass) {
      throw new UnauthorizedException()
    }

    const payload = { sub: user.userId, username: user.username }

    return {
      access_token: await this.jwtService.signAsync(payload),
    }
  }
}
```

åœ¨ä¸Šæ–¹ä»£ç ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨ `signAsync()` æ–¹æ³•ç”Ÿæˆ JWTï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å« `access_token` çš„å¯¹è±¡ã€‚è¿™é‡Œä½¿ç”¨ `sub` å­—æ®µå­˜å‚¨ç”¨æˆ· IDï¼ˆ`userId`ï¼‰ï¼Œç¬¦åˆ JWT çš„æ ‡å‡†åšæ³•ã€‚

### é…ç½® JWT æ¨¡å—

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `AuthModule` ä¸­å¼•å…¥å¹¶é…ç½® `JwtModule`ã€‚é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªç”¨äºå­˜æ”¾å¯†é’¥çš„å¸¸é‡æ–‡ä»¶ï¼š

```ts filename='auth/constants.ts'
export const jwtConstants = {
  secret:
    'DO NOT USE THIS VALUE. INSTEAD, CREATE A COMPLEX SECRET AND KEEP IT SAFE OUTSIDE OF THE SOURCE CODE.',
}
```

<CalloutInfo type="warning">
  **åˆ‡å‹¿å°†å¯†é’¥ç¡¬ç¼–ç åœ¨æºä»£ç ä¸­**ã€‚è¿™é‡Œä»…ä¸ºæ¼”ç¤ºæ–¹ä¾¿ï¼Œå®é™…é¡¹ç›®ä¸­åº”é€šè¿‡ç¯å¢ƒå˜é‡æˆ–é…ç½®ç®¡ç†ç³»ç»Ÿæ¥å®‰å…¨åœ°ç®¡ç†å¯†é’¥ã€‚
</CalloutInfo>

ç„¶åæ›´æ–° `auth.module.ts` æ–‡ä»¶ï¼Œå¼•å…¥é…ç½®ï¼š

```ts filename='auth/auth.module.ts'
import { Module } from '@nestjs/common'
import { AuthService } from './auth.service'
import { AuthController } from './auth.controller'
import { UsersModule } from '../users/users.module'
import { JwtModule } from '@nestjs/jwt'
import { jwtConstants } from './constants'

@Module({
  imports: [
    UsersModule,
    JwtModule.register({
      global: true,
      secret: jwtConstants.secret,
      signOptions: { expiresIn: '60s' },
    }),
  ],
  providers: [AuthService],
  controllers: [AuthController],
  exports: [AuthService],
})
export class AuthModule {}
```

ä¸Šè¿°é…ç½®ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ `register()` æ–¹æ³•æ³¨å†Œäº† `JwtModule`ï¼Œå¹¶æŒ‡å®šä»¤ç‰Œçš„ç­¾åå¯†é’¥å’Œæœ‰æ•ˆæœŸï¼ˆæ­¤å¤„è®¾ä¸º 60 ç§’ï¼‰ã€‚åŒæ—¶å°†å…¶å£°æ˜ä¸ºå…¨å±€æ¨¡å—ï¼Œå¯åœ¨å…¶ä»–æ¨¡å—ä¸­ç›´æ¥ä½¿ç”¨ `JwtService`ã€‚

æ›´å¤šå…³äº JwtModule çš„é…ç½®é€‰é¡¹ï¼Œå¯å‚è€ƒ [`@nestjs/jwt` å®˜æ–¹æ–‡æ¡£](https://github.com/nestjs/jwt/blob/master/README.md)æˆ– [jsonwebtoken é…ç½®è¯´æ˜](https://github.com/auth0/node-jsonwebtoken#usage)ã€‚

### ä½¿ç”¨ curl æµ‹è¯•ç™»å½•æ¥å£

ç°åœ¨å¯ä»¥é€šè¿‡ curl å‘é€ POST è¯·æ±‚æ¥æµ‹è¯•ç™»å½•æµç¨‹ã€‚ä½¿ç”¨ UsersService ä¸­ç¡¬ç¼–ç çš„ç”¨æˆ·ï¼ˆå¦‚ `"john"` å’Œå¯†ç  `"changeme"`ï¼‰è¿›è¡ŒéªŒè¯ï¼š

```bash
# å‘ /auth/login å‘é€ POST è¯·æ±‚
$ curl -X POST http://localhost:3000/auth/login \
    -H "Content-Type: application/json" \
    -d '{"username": "john", "password": "changeme"}'

# è¿”å›ç¤ºä¾‹ï¼š
{"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."}
```

## å®ç°èº«ä»½éªŒè¯å®ˆå«

æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬å°†ä¸ºæ¥å£æ·»åŠ èº«ä»½éªŒè¯æœºåˆ¶ï¼Œç¡®ä¿æ¯ä¸ªè¯·æ±‚éƒ½æºå¸¦æœ‰æ•ˆçš„ JWTï¼Œä»è€Œä¿æŠ¤æ¥å£çš„å®‰å…¨æ€§ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª**èº«ä»½éªŒè¯å®ˆå«**ï¼ˆ`AuthGuard`ï¼‰ï¼Œç”¨äºæ‹¦æˆªè¯·æ±‚å¹¶éªŒè¯ä»¤ç‰Œã€‚

```ts filename='auth/auth.guard.ts'
import {
  CanActivate,
  ExecutionContext,
  Injectable,
  UnauthorizedException,
} from '@nestjs/common'
import { JwtService } from '@nestjs/jwt'
import { jwtConstants } from './constants'
import { Request } from 'express'

@Injectable()
export class AuthGuard implements CanActivate {
  constructor(private jwtService: JwtService) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest<Request>()
    const token = this.extractTokenFromHeader(request)

    if (!token) {
      throw new UnauthorizedException()
    }

    try {
      const payload = await this.jwtService.verifyAsync(token, {
        secret: jwtConstants.secret,
      })

      // ğŸ’¡ å°† JWT è½½è·é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡ä¸Šï¼Œä¾¿äºåç»­åœ¨æ§åˆ¶å™¨ä¸­è®¿é—®ç”¨æˆ·ä¿¡æ¯
      request.user = payload
    } catch {
      throw new UnauthorizedException()
    }

    return true
  }

  private extractTokenFromHeader(request: Request): string | undefined {
    const [type, token] = request.headers.authorization?.split(' ') ?? []
    return type === 'Bearer' ? token : undefined
  }
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ `AuthGuard` æ‹¦æˆªè¯·æ±‚ï¼Œè§£æå¹¶éªŒè¯è¯·æ±‚å¤´ä¸­çš„ `Bearer Token`ã€‚å¦‚æœéªŒè¯æˆåŠŸï¼Œåˆ™å°†è§£æå¾—åˆ°çš„ JWT è½½è·é™„åŠ åˆ° `request.user` ä¸Šï¼Œä¾›åç»­ä½¿ç”¨ã€‚å¦åˆ™ï¼Œå°†æŠ›å‡º `UnauthorizedException`ï¼Œæ‹’ç»è®¿é—®ã€‚

### ä¿æŠ¤è·¯ç”±

æ¥ä¸‹æ¥ï¼Œåœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨è¿™ä¸ªèº«ä»½éªŒè¯å®ˆå«ï¼Œæ¥ä¿æŠ¤æŸäº›éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®çš„è·¯ç”±ï¼š

```ts filename='auth.controller.ts'
import {
  Body,
  Controller,
  Get,
  HttpCode,
  HttpStatus,
  Post,
  Request,
  UseGuards,
} from '@nestjs/common'
import { AuthGuard } from './auth.guard'
import { AuthService } from './auth.service'

@Controller('auth')
export class AuthController {
  constructor(private authService: AuthService) {}

  @HttpCode(HttpStatus.OK)
  @Post('login')
  signIn(@Body() signInDto: Record<string, any>) {
    return this.authService.signIn(signInDto.username, signInDto.password)
  }

  @UseGuards(AuthGuard)
  @Get('profile')
  getProfile(@Request() req) {
    return req.user
  }
}
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨ `@UseGuards(AuthGuard)` è£…é¥°å™¨ï¼Œå°† `/auth/profile` è·¯ç”±è®¾ç½®ä¸ºå—ä¿æŠ¤çš„èµ„æºã€‚åªæœ‰æºå¸¦æœ‰æ•ˆ JWT çš„è¯·æ±‚æ‰èƒ½è®¿é—®è¯¥æ¥å£ã€‚

### æµ‹è¯•æ¥å£

ç¡®ä¿æœåŠ¡æ­£åœ¨è¿è¡Œåï¼Œå¯ä»¥ä½¿ç”¨ curl å‘½ä»¤æµ‹è¯•æ•´ä¸ªèº«ä»½éªŒè¯æµç¨‹ï¼š

```bash
# 1. ç›´æ¥è®¿é—®å—ä¿æŠ¤çš„æ¥å£ï¼Œåº”è¿”å› 401
$ curl http://localhost:3000/auth/profile
{"statusCode":401,"message":"Unauthorized"}

# 2. ç™»å½•ä»¥è·å– JWT ä»¤ç‰Œ
$ curl -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "john", "password": "changeme"}'
{"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm..."}

# 3. æºå¸¦ Bearer Token è®¿é—®å—ä¿æŠ¤æ¥å£
$ curl http://localhost:3000/auth/profile \
  -H "Authorization: Bearer <ä¸Šä¸€æ­¥è¿”å›çš„ access_token>"
{"sub": 1, "username": "john", "iat": ..., "exp": ...}
```

### å…³äº JWT çš„æœ‰æ•ˆæœŸ

åœ¨ `AuthModule` ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº† JWT çš„è¿‡æœŸæ—¶é—´ä¸º `60 ç§’`ã€‚è¿™æ˜¯ä¸ºäº†æ¼”ç¤º JWT çš„ä¸€ä¸ªå…³é”®ç‰¹æ€§ï¼šä»¤ç‰Œä¼šè‡ªåŠ¨è¿‡æœŸã€‚

ä¾‹å¦‚ï¼Œå½“ä½ æˆåŠŸç™»å½•å¹¶è·å–ä»¤ç‰Œåï¼Œå¦‚æœç­‰å¾…è¶…è¿‡ `60 ç§’` å†è®¿é—® `/auth/profile`ï¼Œå°†ä¼šæ”¶åˆ° `401 Unauthorized` å“åº”ã€‚è¿™æ˜¯å› ä¸º `@nestjs/jwt` å†…éƒ¨å·²è‡ªåŠ¨æ ¡éªŒä»¤ç‰Œçš„æœ‰æ•ˆæœŸï¼Œæ— éœ€ä½ æ‰‹åŠ¨å¤„ç†ã€‚

### å°ç»“

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†åŸºäº JWT çš„èº«ä»½éªŒè¯æœºåˆ¶çš„å®ç°ï¼š

- ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡ç«¯è¿”å›ä¸€ä¸ªçŸ­æœŸæœ‰æ•ˆçš„ `access token`ï¼›
- å®¢æˆ·ç«¯åœ¨åç»­è¯·æ±‚ä¸­é€šè¿‡ `Authorization` å¤´å‘é€è¯¥ä»¤ç‰Œï¼›
- æœåŠ¡ç«¯é€šè¿‡èº«ä»½éªŒè¯å®ˆå«è‡ªåŠ¨éªŒè¯ä»¤ç‰Œçš„æœ‰æ•ˆæ€§ï¼Œå¹¶å°†è§£æç»“æœæ³¨å…¥åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­ã€‚

ç°åœ¨ï¼Œæ— è®ºä½ æ˜¯ä½¿ç”¨ Angularã€Reactã€Vue ç­‰å‰ç«¯æ¡†æ¶ï¼Œè¿˜æ˜¯å…¶ä»– Node.js åº”ç”¨ï¼Œéƒ½å¯ä»¥å®‰å…¨åœ°ä¸æˆ‘ä»¬çš„ API è¿›è¡Œè®¤è¯å’Œé€šä¿¡ã€‚

## å…¨å±€å¯ç”¨èº«ä»½éªŒè¯å®ˆå«

åœ¨å¤§å¤šæ•°å®é™…åœºæ™¯ä¸­ï¼Œæ¥å£é€šå¸¸é»˜è®¤æ˜¯å—ä¿æŠ¤çš„ï¼Œåªæœ‰å°‘æ•°å‡ ä¸ªéœ€è¦å…¬å¼€è®¿é—®ã€‚å¦‚æœæ¯ä¸ªå—ä¿æŠ¤çš„è·¯ç”±éƒ½æ˜¾å¼ç»‘å®šå®ˆå«ï¼Œä¼šæ˜¾å¾—ç¹çä¸”é‡å¤ã€‚æ­¤æ—¶ï¼Œæœ€ç®€æ´çš„åšæ³•æ˜¯å°†èº«ä»½éªŒè¯å®ˆå«ï¼ˆ`AuthGuard`ï¼‰æ³¨å†Œä¸º[å…¨å±€å®ˆå«](/guards#å…¨å±€å®ˆå«çš„æ³¨å†Œ)ï¼Œä»è€Œç»Ÿä¸€ä¿æŠ¤æ‰€æœ‰è·¯ç”±ã€‚

ä½ åªéœ€ä¸ºéœ€è¦å…¬å¼€è®¿é—®çš„è·¯ç”±æ˜¾å¼æ ‡è®°ï¼Œè€Œéé‡å¤ä½¿ç”¨ `@UseGuards()` è£…é¥°å™¨ã€‚

### æ³¨å†Œå…¨å±€å®ˆå«

ä½ å¯ä»¥åœ¨ä»»æ„æ¨¡å—ï¼ˆä¾‹å¦‚ `AuthModule`ï¼‰ä¸­ï¼Œå°† `AuthGuard` æ³¨å†Œä¸ºå…¨å±€å®ˆå«ï¼Œé…ç½®å¦‚ä¸‹ï¼š

```ts
providers: [
  {
    provide: APP_GUARD,
    useClass: AuthGuard,
  },
],
```

é…ç½®å®Œæˆåï¼ŒNest ä¼šè‡ªåŠ¨å°†è¯¥å®ˆå«åº”ç”¨äºæ•´ä¸ªåº”ç”¨çš„æ‰€æœ‰è¯·æ±‚å¤„ç†å™¨ï¼ˆhandlerï¼‰ï¼Œæ— éœ€é€ä¸ªç»‘å®šã€‚

### å£°æ˜å…¬å¼€è·¯ç”±

ä¸ºäº†æ”¯æŒã€Œé»˜è®¤å—ä¿æŠ¤ï¼Œéƒ¨åˆ†å…¬å¼€ã€çš„ç­–ç•¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹å¼æ¥æ˜¾å¼æ ‡è®°æŸäº›è·¯ç”±ä¸ºå…¬å¼€è®¿é—®ã€‚è¿™å¯ä»¥é€šè¿‡ `SetMetadata()` åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰è£…é¥°å™¨æ¥å®ç°ï¼š

```ts
import { SetMetadata } from '@nestjs/common'

export const IS_PUBLIC_KEY = 'isPublic'
export const Public = () => SetMetadata(IS_PUBLIC_KEY, true)
```

è¿™æ®µä»£ç å¯¼å‡ºäº†ä¸¤ä¸ªå¸¸é‡ï¼š

- `IS_PUBLIC_KEY`ï¼šå®šä¹‰å…ƒæ•°æ®çš„é”®åï¼›
- `Public()`ï¼šä¸€ä¸ªè‡ªå®šä¹‰è£…é¥°å™¨ï¼Œç”¨äºæ ‡è®°å…¬å¼€è·¯ç”±ï¼ˆä½ ä¹Ÿå¯ä»¥å‘½åä¸º `SkipAuth` æˆ– `AllowAnonymous`ï¼Œè§†å›¢é˜Ÿå‘½åé£æ ¼è€Œå®šï¼‰ã€‚

ä½¿ç”¨ç¤ºä¾‹ï¼š

```ts
@Public()
@Get()
findAll() {
  return []
}
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œä»»ä½•è¢« `@Public()` æ ‡è®°çš„å¤„ç†å™¨éƒ½ä¼šè¢«è·³è¿‡èº«ä»½éªŒè¯ã€‚

### ä¿®æ”¹ `AuthGuard` ä»¥è¯†åˆ«å…¬å¼€è·¯ç”±

æœ€åï¼Œéœ€è¦åœ¨å®ˆå«å†…éƒ¨è¯†åˆ« `isPublic` å…ƒæ•°æ®ï¼Œå¹¶åœ¨å¿…è¦æ—¶è·³è¿‡èº«ä»½éªŒè¯é€»è¾‘ã€‚è¿™å¯ä»¥å€ŸåŠ© Nest æä¾›çš„ `Reflector` å®ç°ï¼š

```ts
@Injectable()
export class AuthGuard implements CanActivate {
  constructor(
    private jwtService: JwtService,
    private reflector: Reflector
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
      context.getHandler(),
      context.getClass(),
    ])
    if (isPublic) {
      // ğŸ’¡ è·¯ç”±è¢«æ ‡è®°ä¸ºå…¬å¼€ï¼Œè·³è¿‡èº«ä»½éªŒè¯
      return true
    }

    const request = context.switchToHttp().getRequest()
    const token = this.extractTokenFromHeader(request)
    if (!token) {
      throw new UnauthorizedException()
    }

    try {
      const payload = await this.jwtService.verifyAsync(token, {
        secret: jwtConstants.secret,
      })
      // ğŸ’¡ å°†è§£ç åçš„ç”¨æˆ·ä¿¡æ¯æŒ‚è½½åˆ° request å¯¹è±¡ä¸­ï¼Œä¾¿äºåç»­è®¿é—®
      request['user'] = payload
    } catch {
      throw new UnauthorizedException()
    }

    return true
  }

  private extractTokenFromHeader(request: Request): string | undefined {
    const [type, token] = request.headers.authorization?.split(' ') ?? []
    return type === 'Bearer' ? token : undefined
  }
}
```

### å°ç»“

é€šè¿‡å°† `AuthGuard` æ³¨å†Œä¸ºå…¨å±€å®ˆå«ï¼Œå¹¶ç»“åˆè‡ªå®šä¹‰çš„ `@Public()` è£…é¥°å™¨ï¼Œä½ å¯ä»¥å®ç°ï¼š

- é»˜è®¤ä¿æŠ¤æ‰€æœ‰æ¥å£ï¼›
- ç²¾å‡†å£°æ˜å“ªäº›è·¯ç”±åº”è·³è¿‡èº«ä»½éªŒè¯ï¼›
- ç®€åŒ–æ§åˆ¶å™¨ä»£ç ï¼Œé¿å…é‡å¤å£°æ˜ `@UseGuards()`ï¼›
- æå‡å®‰å…¨æ€§ä¸å¯ç»´æŠ¤æ€§ã€‚

[Passport](https://github.com/jaredhanson/passport) æ˜¯ç›®å‰æœ€å—æ¬¢è¿çš„ Node.js èº«ä»½éªŒè¯åº“ï¼Œå¹¿æ³›åº”ç”¨äºå„ç§ç”Ÿäº§ç¯å¢ƒä¸­ã€‚å€ŸåŠ© `@nestjs/passport` æ¨¡å—ï¼Œå¯ä»¥å°† Passport æ— ç¼é›†æˆåˆ° NestJS åº”ç”¨ä¸­ï¼Œæ„å»ºçµæ´»ã€å®‰å…¨çš„è®¤è¯æœºåˆ¶ã€‚

æƒ³äº†è§£é›†æˆæ­¥éª¤ä¸å®æˆ˜ç”¨æ³•ï¼Ÿè¯·å‚é˜…æœ¬ç« çš„[è¯¦ç»†æŒ‡å—](/recipes/passport)ã€‚

## ç¤ºä¾‹é¡¹ç›®

æˆ‘ä»¬å‡†å¤‡äº†ä¸€ä¸ªå®Œæ•´çš„[ç¤ºä¾‹é¡¹ç›®](https://github.com/nestjs/nest/tree/master/sample/19-auth-jwt)ï¼Œæ¼”ç¤ºå¦‚ä½•åœ¨ NestJS ä¸­å®ç°åŸºäº JWT çš„èº«ä»½éªŒè¯ï¼Œæ¬¢è¿å‚è€ƒå­¦ä¹ ã€‚
