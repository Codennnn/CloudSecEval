# èº«ä»½éªŒè¯

èº«ä»½éªŒè¯ï¼ˆAuthenticationï¼‰æ˜¯ç»å¤§å¤šæ•°åº”ç”¨ç¨‹åºä¸­è‡³å…³é‡è¦çš„ä¸€ç¯ã€‚å¤„ç†èº«ä»½éªŒè¯æœ‰å¤šç§æ–¹æ³•å’Œç­–ç•¥ï¼Œå…·ä½“é€‰æ‹©å“ªä¸€ç§ï¼Œå–å†³äºé¡¹ç›®çš„å®é™…éœ€æ±‚ã€‚æœ¬ç« å°†ä»‹ç»å‡ ç§èƒ½å¤Ÿé€‚åº”ä¸åŒéœ€æ±‚çš„èº«ä»½éªŒè¯æ–¹æ¡ˆã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥æ˜ç¡®ä¸€ä¸‹å…·ä½“éœ€æ±‚ã€‚åœ¨æœ¬ç« çš„ç¤ºä¾‹ä¸­ï¼Œå®¢æˆ·ç«¯å°†ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œèº«ä»½éªŒè¯ã€‚éªŒè¯æˆåŠŸåï¼ŒæœåŠ¡å™¨ä¼šç­¾å‘ä¸€ä¸ª JWTï¼ˆJSON Web Tokenï¼‰ã€‚å®¢æˆ·ç«¯åœ¨éšåçš„è¯·æ±‚ä¸­ï¼Œå¯ä»¥å°†æ­¤ JWT ä½œä¸º [bearer token](https://tools.ietf.org/html/rfc6750) é™„åŠ åœ¨æˆæƒæ ‡å¤´ï¼ˆAuthorization Headerï¼‰ä¸­ï¼Œä»¥è¡¨æ˜è‡ªå·±çš„èº«ä»½ã€‚æœ€åï¼Œæˆ‘ä»¬è¿˜ä¼šåˆ›å»ºä¸€ä¸ªå—ä¿æŠ¤çš„è·¯ç”±ï¼ˆprotected routeï¼‰ï¼Œè¯¥è·¯ç”±åªå…è®¸æºå¸¦æœ‰æ•ˆ JWT çš„è¯·æ±‚è®¿é—®ã€‚

æˆ‘ä»¬å°†é€æ­¥å®ç°è¿™äº›åŠŸèƒ½ï¼šé¦–å…ˆæ˜¯ç”¨æˆ·èº«ä»½éªŒè¯ï¼Œç„¶åæ˜¯ç­¾å‘ JWTï¼Œæœ€åæ˜¯åˆ›å»ºä¸€ä¸ªæ£€æŸ¥ JWT çš„å—ä¿æŠ¤è·¯ç”±ã€‚

## åˆ›å»ºèº«ä»½éªŒè¯æ¨¡å—

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç”Ÿæˆä¸€ä¸ª `AuthModule`ï¼Œå¹¶åœ¨å…¶ä¸­åˆ›å»º `AuthService` å’Œ `AuthController`ã€‚`AuthService` å°†åŒ…å«æ ¸å¿ƒçš„èº«ä»½éªŒè¯é€»è¾‘ï¼Œè€Œ `AuthController` åˆ™è´Ÿè´£æš´éœ²ä¸èº«ä»½éªŒè¯ç›¸å…³çš„ API ç«¯ç‚¹ã€‚

```bash
$ nest g module auth
$ nest g controller auth
$ nest g service auth
```

åœ¨å®ç° `AuthService` çš„è¿‡ç¨‹ä¸­ï¼Œä½ ä¼šå‘ç°ï¼Œå¦‚æœæŠŠç”¨æˆ·ç›¸å…³çš„é€»è¾‘æå–å¹¶å°è£…åˆ° `UsersService` ä¸­ï¼Œä»£ç ç»“æ„ä¼šæ›´æ¸…æ™°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ›å»ºç›¸åº”çš„æ¨¡å—å’ŒæœåŠ¡ã€‚

```bash
$ nest g module users
$ nest g service users
```

æ¥ä¸‹æ¥ï¼Œå°†è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶å†…å®¹æ›¿æ¢ä¸ºå¦‚ä¸‹ä»£ç ã€‚åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œ`UsersService` ä»…ç»´æŠ¤ä¸€ä¸ªç¡¬ç¼–ç çš„ç”¨æˆ·åˆ—è¡¨ï¼ˆå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼‰ï¼Œå¹¶æä¾›ä¸€ä¸ªæŒ‰ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·çš„æ–¹æ³•ã€‚åœ¨å®é™…çš„åº”ç”¨ç¨‹åºä¸­ï¼Œä½ åº”è¯¥ä¼šä½¿ç”¨æ•°æ®åº“å’ŒæŒä¹…åŒ–å±‚æ¥ç®¡ç†ç”¨æˆ·æ•°æ®ï¼Œä¾‹å¦‚é€šè¿‡ TypeORMã€Sequelize æˆ– Mongoose ç­‰åº“æ¥å®ç°ã€‚

```ts filename='users/users.service.ts'
import { Injectable } from '@nestjs/common'

// è¿™é‡Œåº”è¯¥æ˜¯ä¸€ä¸ªçœŸæ­£çš„ç”¨æˆ·å®ä½“ç±»æˆ–æ¥å£
export type User = any

@Injectable()
export class UsersService {
  private readonly users = [
    {
      userId: 1,
      username: 'john',
      password: 'changeme',
    },
    {
      userId: 2,
      username: 'maria',
      password: 'guess',
    },
  ]

  async findOne(username: string): Promise<User | undefined> {
    return this.users.find((user) => user.username === username)
  }
}
```

åœ¨ `UsersModule` ä¸­ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°† `UsersService` æ·»åŠ åˆ° `@Module` è£…é¥°å™¨çš„ `exports` æ•°ç»„ä¸­ã€‚è¿™æ ·ï¼Œè¯¥æœåŠ¡å°±èƒ½æä¾›ç»™å…¶ä»–æ¨¡å—ä½¿ç”¨ï¼ˆæ¯”å¦‚æ¥ä¸‹æ¥è¦ç”¨åˆ°çš„ `AuthService`ï¼‰ã€‚

```ts filename='users/users.module.ts'
import { Module } from '@nestjs/common'
import { UsersService } from './users.service'

@Module({
  providers: [UsersService],
  exports: [UsersService],
})
export class UsersModule {}
```

## å®ç°ç™»å½•æ¥å£

æˆ‘ä»¬çš„ `AuthService`ï¼ˆè®¤è¯æœåŠ¡ï¼‰è´Ÿè´£æ£€ç´¢ç”¨æˆ·å¹¶éªŒè¯å¯†ç ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ª `signIn()` æ–¹æ³•ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬åˆ©ç”¨äº† ES6 çš„å±•å¼€è¿ç®—ç¬¦ï¼ˆspread operatorï¼‰ï¼Œåœ¨è¿”å›ç”¨æˆ·å¯¹è±¡å‰ç§»é™¤äº† password å±æ€§ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†é¿å…åœ¨è¿”å›ç”¨æˆ·ä¿¡æ¯æ—¶æš´éœ²å¯†ç ç­‰æ•æ„Ÿå­—æ®µï¼Œè¿™æ˜¯å®é™…å¼€å‘ä¸­çš„å¸¸è§åšæ³•ã€‚

```ts filename='auth/auth.service.ts'
import { Injectable, UnauthorizedException } from '@nestjs/common'
import { UsersService } from '../users/users.service'

@Injectable()
export class AuthService {
  constructor(private usersService: UsersService) {}

  async signIn(username: string, pass: string): Promise<any> {
    const user = await this.usersService.findOne(username)
    if (user?.password !== pass) {
      throw new UnauthorizedException()
    }
    const { password, ...result } = user
    // TODO: å®é™…é¡¹ç›®ä¸­åº”ç”Ÿæˆ JWT å¹¶è¿”å›
    // æ­¤å¤„ä»…ä¸ºæ¼”ç¤ºï¼Œç›´æ¥è¿”å›ç”¨æˆ·å¯¹è±¡
    return result
  }
}
```

<CalloutInfo type="warning">
  åˆ‡å‹¿åœ¨å®é™…é¡¹ç›®ä¸­ä»¥æ˜æ–‡å½¢å¼å­˜å‚¨å¯†ç ã€‚ä½ åº”å½“ä½¿ç”¨å¦‚
  [bcrypt](https://github.com/kelektiv/node.bcrypt.js#readme)
  è¿™æ ·çš„åº“ï¼Œé‡‡ç”¨åŠ ç›çš„å•å‘å“ˆå¸Œç®—æ³•ã€‚è¿™æ ·ï¼Œç³»ç»Ÿåªä¼šå­˜å‚¨å“ˆå¸Œåçš„å¯†ç ï¼Œå¹¶åœ¨æ ¡éªŒæ—¶å°†ä¼ å…¥å¯†ç è¿›è¡Œå“ˆå¸Œåæ¯”å¯¹ï¼Œç¡®ä¿å¯†ç ä¸ä¼šä»¥æ˜æ–‡å½¢å¼å­˜å‚¨æˆ–æš´éœ²ã€‚ä¸ºäº†ç®€åŒ–ç¤ºä¾‹ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨äº†æ˜æ–‡å¯†ç ï¼Œè¿™ç§åšæ³•ä»…ç”¨äºæ¼”ç¤ºï¼Œ**è¯·å‹¿åœ¨çœŸå®é¡¹ç›®ä¸­ä½¿ç”¨ï¼**
</CalloutInfo>

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–° `AuthModule`ï¼ˆè®¤è¯æ¨¡å—ï¼‰ï¼Œå¯¼å…¥ `UsersModule`ï¼ˆç”¨æˆ·æ¨¡å—ï¼‰ã€‚

```ts filename='auth/auth.module.ts'
import { Module } from '@nestjs/common'
import { AuthService } from './auth.service'
import { AuthController } from './auth.controller'
import { UsersModule } from '../users/users.module'

@Module({
  imports: [UsersModule],
  providers: [AuthService],
  controllers: [AuthController],
})
export class AuthModule {}
```

å®Œæˆä¸Šè¿°æ“ä½œåï¼Œæ‰“å¼€ `AuthController`ï¼ˆè®¤è¯æ§åˆ¶å™¨ï¼‰ï¼Œä¸ºå…¶æ·»åŠ  `signIn()` æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šè¢«å®¢æˆ·ç«¯è°ƒç”¨ï¼Œç”¨äºç”¨æˆ·èº«ä»½éªŒè¯ã€‚å®ƒä¼šä»è¯·æ±‚ä½“ä¸­æ¥æ”¶ç”¨æˆ·åå’Œå¯†ç ï¼Œè®¤è¯é€šè¿‡åè¿”å› JWT ä»¤ç‰Œã€‚

```ts filename='auth/auth.controller.ts'
import { Body, Controller, Post, HttpCode, HttpStatus } from '@nestjs/common'
import { AuthService } from './auth.service'

@Controller('auth')
export class AuthController {
  constructor(private authService: AuthService) {}

  @HttpCode(HttpStatus.OK)
  @Post('login')
  signIn(@Body() signInDto: Record<string, any>) {
    return this.authService.signIn(signInDto.username, signInDto.password)
  }
}
```

<CalloutInfo>
åœ¨å®é™…å¼€å‘ä¸­ï¼Œå»ºè®®ä½¿ç”¨ DTOï¼ˆData Transfer Objectï¼Œæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰ç±»æ¥å®šä¹‰è¯·æ±‚ä½“ç»“æ„ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ `Record<string, any>` ç±»å‹ã€‚è¯¦ç»†å†…å®¹è¯·å‚è§[éªŒè¯](/techniques/validation)ç« èŠ‚ã€‚
</CalloutInfo>

## JWT ä»¤ç‰Œ

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿›å…¥è®¤è¯ç³»ç»Ÿçš„ JWT éƒ¨åˆ†ã€‚è®©æˆ‘ä»¬å…ˆå›é¡¾å¹¶ç»†åŒ–ä¸€ä¸‹éœ€æ±‚ï¼š

- å…è®¸ç”¨æˆ·é€šè¿‡ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œèº«ä»½éªŒè¯ï¼Œå¹¶è¿”å›ä¸€ä¸ª JWTï¼Œç”¨äºåç»­è®¿é—®å—ä¿æŠ¤çš„ API æ¥å£ã€‚æˆ‘ä»¬å·²ç»åŸºæœ¬å®ç°äº†è¿™ä¸ªéœ€æ±‚ã€‚è¦å®Œæˆå®ƒï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¼–å†™ç­¾å‘ JWT çš„ä»£ç ã€‚
- åˆ›å»ºåŸºäº JWT æœ‰æ•ˆæ€§ï¼ˆä½œä¸º Bearer Token æä¾›ï¼‰çš„å—ä¿æŠ¤ API è·¯ç”±ã€‚

ä¸ºæ”¯æŒ JWT ç›¸å…³åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–å®‰è£…ä¸€ä¸ªåŒ…ï¼š

```bash
$ npm install --save @nestjs/jwt
```

<CalloutInfo>
  `@nestjs/jwt` åŒ…ï¼ˆè¯¦è§[è¿™é‡Œ](https://github.com/nestjs/jwt)æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºæ“ä½œ JWT
  çš„å·¥å…·åº“ï¼Œæä¾›äº†ç”Ÿæˆå’ŒéªŒè¯ JWT ä»¤ç‰Œçš„èƒ½åŠ›ã€‚
</CalloutInfo>

ä¸ºäº†ä¿æŒæœåŠ¡çš„è‰¯å¥½æ¨¡å—åŒ–ï¼Œæˆ‘ä»¬å°†åœ¨ `authService` ä¸­å¤„ç† JWT çš„ç”Ÿæˆã€‚è¯·æ‰“å¼€ `auth` æ–‡ä»¶å¤¹ä¸‹çš„ `auth.service.ts` æ–‡ä»¶ï¼Œæ³¨å…¥ `JwtService`ï¼Œå¹¶æŒ‰ç…§å¦‚ä¸‹æ–¹å¼æ›´æ–° `signIn` æ–¹æ³•ï¼Œå®ç° JWT ä»¤ç‰Œçš„ç”Ÿæˆï¼š

```ts filename='auth/auth.service.ts'
import { Injectable, UnauthorizedException } from '@nestjs/common'
import { UsersService } from '../users/users.service'
import { JwtService } from '@nestjs/jwt'

@Injectable()
export class AuthService {
  constructor(
    private usersService: UsersService,
    private jwtService: JwtService
  ) {}

  async signIn(username: string, pass: string): Promise<{ access_token: string }> {
    const user = await this.usersService.findOne(username)
    if (user?.password !== pass) {
      throw new UnauthorizedException()
    }
    const payload = { sub: user.userId, username: user.username }
    return {
      access_token: await this.jwtService.signAsync(payload),
    }
  }
}
```

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº† `@nestjs/jwt` åº“ï¼Œå€ŸåŠ©å…¶ `signAsync()` æ–¹æ³•ï¼Œæ ¹æ® `user` å¯¹è±¡çš„éƒ¨åˆ†å±æ€§ç”Ÿæˆ JWTï¼Œå¹¶ä»¥ `{ access_token }` å½¢å¼è¿”å›ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬é‡‡ç”¨ `sub` å±æ€§å­˜å‚¨ `userId`ï¼Œä»¥ç¬¦åˆ JWT æ ‡å‡†ã€‚

æ¥ä¸‹æ¥ï¼Œéœ€è¦æ›´æ–° `AuthModule`ï¼Œå¼•å…¥æ–°çš„ä¾èµ–å¹¶é…ç½® `JwtModule`ã€‚

é¦–å…ˆï¼Œåœ¨ `auth` æ–‡ä»¶å¤¹ä¸‹æ–°å»º `constants.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```ts filename='auth/constants.ts'
export const jwtConstants = {
  secret:
    'DO NOT USE THIS VALUE. INSTEAD, CREATE A COMPLEX SECRET AND KEEP IT SAFE OUTSIDE OF THE SOURCE CODE.',
}
```

è¯¥å¸¸é‡å°†åœ¨ JWT ç­¾å‘å’ŒéªŒè¯è¿‡ç¨‹ä¸­ç”¨ä½œå¯†é’¥ã€‚

<CalloutInfo>
  **åˆ‡å‹¿å…¬å¼€æš´éœ²æ­¤å¯†é’¥**ã€‚æ­¤å¤„ä»…ä¸ºæ¼”ç¤ºä»£ç ç»“æ„è€Œæ˜æ–‡å±•ç¤ºï¼Œå®é™…ç”Ÿäº§ç¯å¢ƒä¸­**å¿…é¡»é€šè¿‡æœºå¯†ç®¡ç†ã€ç¯å¢ƒå˜é‡æˆ–é…ç½®æœåŠ¡ç­‰æ–¹å¼å¦¥å–„ä¿æŠ¤æ­¤å¯†é’¥**ã€‚
</CalloutInfo>

ç°åœ¨ï¼Œæ‰“å¼€ `auth` æ–‡ä»¶å¤¹ä¸‹çš„ `auth.module.ts`ï¼Œå¹¶æ›´æ–°ä¸ºå¦‚ä¸‹å†…å®¹ï¼š

```ts filename='auth/auth.module.ts'
import { Module } from '@nestjs/common'
import { AuthService } from './auth.service'
import { UsersModule } from '../users/users.module'
import { JwtModule } from '@nestjs/jwt'
import { AuthController } from './auth.controller'
import { jwtConstants } from './constants'

@Module({
  imports: [
    UsersModule,
    JwtModule.register({
      global: true,
      secret: jwtConstants.secret,
      signOptions: { expiresIn: '60s' },
    }),
  ],
  providers: [AuthService],
  controllers: [AuthController],
  exports: [AuthService],
})
export class AuthModule {}
```

<CalloutInfo>
  åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°† `JwtModule` æ³¨å†Œä¸ºå…¨å±€æ¨¡å—ï¼Œä¾¿äºåç»­åœ¨å…¶ä»–åœ°æ–¹ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€é‡å¤å¯¼å…¥ã€‚
</CalloutInfo>

æˆ‘ä»¬é€šè¿‡ `register()` æ–¹æ³•é…ç½® `JwtModule`ï¼Œä¼ å…¥ç›¸å…³é…ç½®å¯¹è±¡ã€‚æ›´å¤šå…³äº Nest `JwtModule` çš„ä¿¡æ¯å¯å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://github.com/nestjs/jwt/blob/master/README.md)ï¼Œé…ç½®é¡¹è¯´æ˜è¯¦è§[è¿™é‡Œ](https://github.com/auth0/node-jsonwebtoken#usage)ã€‚

æ­¤æ—¶ï¼Œä½ å¯ä»¥å†æ¬¡ä½¿ç”¨ cURL æµ‹è¯•æ¥å£ã€‚å¯ç”¨ `UsersService` ä¸­ç¡¬ç¼–ç çš„ä»»æ„ `user` å¯¹è±¡è¿›è¡ŒéªŒè¯ã€‚

```bash
$ # POST åˆ° /auth/login
$ curl -X POST http://localhost:3000/auth/login -d '{"username": "john", "password": "changeme"}' -H "Content-Type: application/json"
{"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."}
$ # æ³¨æ„ï¼šä¸Šæ–¹ JWT å·²æˆªæ–­
```

## å®ç°èº«ä»½éªŒè¯å®ˆå«ï¼ˆAuthentication Guardï¼‰

ç°åœ¨ï¼Œæˆ‘ä»¬æ¥è§£å†³æœ€åä¸€ä¸ªéœ€æ±‚ï¼šè¦æ±‚æ¯ä¸ªè¯·æ±‚éƒ½å¿…é¡»æºå¸¦æœ‰æ•ˆçš„ JWTï¼Œä»è€Œä¿æŠ¤æ¥å£å®‰å…¨ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª `AuthGuard`ï¼ˆèº«ä»½éªŒè¯å®ˆå«ï¼‰ï¼Œç”¨äºå®ç°è·¯ç”±ä¿æŠ¤ã€‚

```ts filename='auth/auth.guard.ts'
import { CanActivate, ExecutionContext, Injectable, UnauthorizedException } from '@nestjs/common'
import { JwtService } from '@nestjs/jwt'
import { jwtConstants } from './constants'
import { Request } from 'express'

@Injectable()
export class AuthGuard implements CanActivate {
  constructor(private jwtService: JwtService) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest()
    const token = this.extractTokenFromHeader(request)
    if (!token) {
      throw new UnauthorizedException()
    }
    try {
      const payload = await this.jwtService.verifyAsync(token, {
        secret: jwtConstants.secret,
      })
      // ğŸ’¡ è¿™é‡Œå°† payloadï¼ˆè½½è·ï¼‰èµ‹å€¼åˆ° request å¯¹è±¡ä¸Š
      // è¿™æ ·åœ¨è·¯ç”±å¤„ç†å™¨ä¸­å°±èƒ½ç›´æ¥è®¿é—®åˆ°ç”¨æˆ·ä¿¡æ¯
      request['user'] = payload
    } catch {
      throw new UnauthorizedException()
    }
    return true
  }

  private extractTokenFromHeader(request: Request): string | undefined {
    const [type, token] = request.headers.authorization?.split(' ') ?? []
    return type === 'Bearer' ? token : undefined
  }
}
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å—ä¿æŠ¤çš„è·¯ç”±ï¼Œå¹¶æ³¨å†Œ `AuthGuard`ï¼ˆèº«ä»½éªŒè¯å®ˆå«ï¼‰æ¥ä¿æŠ¤è¿™äº›è·¯ç”±ã€‚

è¯·æ‰“å¼€ `auth.controller.ts` æ–‡ä»¶ï¼Œå¹¶æŒ‰å¦‚ä¸‹æ–¹å¼è¿›è¡Œæ›´æ–°ï¼š

```ts filename='auth.controller.ts'
import {
  Body,
  Controller,
  Get,
  HttpCode,
  HttpStatus,
  Post,
  Request,
  UseGuards,
} from '@nestjs/common'
import { AuthGuard } from './auth.guard'
import { AuthService } from './auth.service'

@Controller('auth')
export class AuthController {
  constructor(private authService: AuthService) {}

  @HttpCode(HttpStatus.OK)
  @Post('login')
  signIn(@Body() signInDto: Record<string, any>) {
    return this.authService.signIn(signInDto.username, signInDto.password)
  }

  @UseGuards(AuthGuard)
  @Get('profile')
  getProfile(@Request() req) {
    return req.user
  }
}
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬å°†åˆšåˆšåˆ›å»ºçš„ `AuthGuard` åº”ç”¨åˆ°äº† `GET /profile` è·¯ç”±ä¸Šã€‚è¿™æ ·ï¼Œè¯¥æ¥å£å°±å®ç°äº†è®¿é—®ä¿æŠ¤ã€‚

ç¡®ä¿ä½ çš„åº”ç”¨æ­£åœ¨è¿è¡Œï¼Œå¹¶ä½¿ç”¨ `cURL` å·¥å…·æµ‹è¯•è¿™äº›æ¥å£ã€‚

```bash
$ # å°è¯•è®¿é—®å—ä¿æŠ¤çš„ GET /profile æ¥å£
$ curl http://localhost:3000/auth/profile
{"statusCode":401,"message":"Unauthorized"}

$ # è¿›è¡Œç™»å½•ï¼Œè·å– access_token
$ curl -X POST http://localhost:3000/auth/login -d '{"username": "john", "password": "changeme"}' -H "Content-Type: application/json"
{"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm..."}

$ # ä½¿ç”¨ä¸Šä¸€æ­¥è¿”å›çš„ access_token ä½œä¸º Bearer ä»¤ç‰Œè®¿é—® /profile
$ curl http://localhost:3000/auth/profile -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm..."
{"sub": 1, "username": "john", "iat": ..., "exp": ...}
```

è¯·æ³¨æ„ï¼Œåœ¨ `AuthModule`ï¼ˆè®¤è¯æ¨¡å—ï¼‰ä¸­ï¼Œæˆ‘ä»¬å°† JWT çš„è¿‡æœŸæ—¶é—´é…ç½®ä¸º `60 ç§’`ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªè¿‡æœŸæ—¶é—´è¾ƒçŸ­ï¼Œä¸»è¦ç”¨äºæ¼”ç¤º JWT çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼šå¦‚æœä½ åœ¨è®¤è¯åç­‰å¾… 60 ç§’å†è¯·æ±‚ `GET /auth/profile`ï¼Œå°†ä¼šæ”¶åˆ° `401 Unauthorized`ï¼ˆæœªæˆæƒï¼‰å“åº”ã€‚è¿™æ˜¯å› ä¸º `@nestjs/jwt` ä¼šè‡ªåŠ¨æ ¡éªŒ JWT çš„è¿‡æœŸæ—¶é—´ï¼Œæ— éœ€ä½ åœ¨åº”ç”¨ä¸­æ‰‹åŠ¨å¤„ç†ã€‚

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº† JWT èº«ä»½éªŒè¯çš„å®ç°ã€‚æ— è®ºæ˜¯ JavaScript å®¢æˆ·ç«¯ï¼ˆå¦‚ Angularã€Reactã€Vueï¼‰ï¼Œè¿˜æ˜¯å…¶ä»– JavaScript åº”ç”¨ï¼Œç°åœ¨éƒ½å¯ä»¥å®‰å…¨åœ°ä¸æˆ‘ä»¬çš„ API æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯å’Œé€šä¿¡ã€‚

## å…¨å±€å¯ç”¨èº«ä»½éªŒè¯

åœ¨å®é™…å¼€å‘ä¸­ï¼Œå¦‚æœä½ çš„ç»å¤§å¤šæ•°æ¥å£éƒ½éœ€è¦è¿›è¡Œä¿æŠ¤ï¼Œå¯ä»¥å°†èº«ä»½éªŒè¯å®ˆå«ï¼ˆAuthGuardï¼‰æ³¨å†Œä¸º[å…¨å±€å®ˆå«](/guards#binding-guards)ã€‚è¿™æ ·ï¼Œä½ æ— éœ€åœ¨æ¯ä¸ªæ§åˆ¶å™¨ä¸Šåå¤ä½¿ç”¨ `@UseGuards()` è£…é¥°å™¨ï¼Œåªéœ€ä¸ºéœ€è¦å…¬å¼€è®¿é—®çš„è·¯ç”±å•ç‹¬æ ‡è®°å³å¯ã€‚

é¦–å…ˆï¼Œä½ å¯ä»¥åœ¨ä»»æ„æ¨¡å—ï¼ˆä¾‹å¦‚ `AuthModule`ï¼‰ä¸­ï¼Œå°† `AuthGuard` æ³¨å†Œä¸ºå…¨å±€å®ˆå«ï¼Œå…·ä½“æ–¹å¼å¦‚ä¸‹ï¼š

```ts
providers: [
  {
    provide: APP_GUARD,
    useClass: AuthGuard,
  },
],
```

é…ç½®å®Œæˆåï¼ŒNest ä¼šè‡ªåŠ¨å°† `AuthGuard` åº”ç”¨äºæ‰€æœ‰æ¥å£ï¼Œæ— éœ€æ‰‹åŠ¨é€ä¸ªç»‘å®šã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æœºåˆ¶æ¥å£°æ˜å“ªäº›è·¯ç”±æ˜¯å…¬å¼€çš„ã€‚ä¸ºæ­¤ï¼Œå¯ä»¥å€ŸåŠ© `SetMetadata` è£…é¥°å™¨å·¥å‚å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰è£…é¥°å™¨ï¼š

```ts
import { SetMetadata } from '@nestjs/common'

export const IS_PUBLIC_KEY = 'isPublic'
export const Public = () => SetMetadata(IS_PUBLIC_KEY, true)
```

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯¼å‡ºäº†ä¸¤ä¸ªå¸¸é‡ï¼šä¸€ä¸ªæ˜¯å…ƒæ•°æ®é”® `IS_PUBLIC_KEY`ï¼Œå¦ä¸€ä¸ªæ˜¯è‡ªå®šä¹‰è£…é¥°å™¨ `Public`ï¼ˆä½ ä¹Ÿå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚å‘½åä¸º `SkipAuth` æˆ– `AllowAnon` ç­‰ï¼‰ã€‚

æœ‰äº†è‡ªå®šä¹‰çš„ `@Public()` è£…é¥°å™¨åï¼Œå¯ä»¥å°†å…¶ç”¨äºéœ€è¦å…¬å¼€è®¿é—®çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š

```ts
@Public()
@Get()
findAll() {
  return [];
}
```

æœ€åï¼Œæˆ‘ä»¬è¿˜éœ€è¦è®© `AuthGuard` èƒ½å¤Ÿè¯†åˆ« "isPublic" å…ƒæ•°æ®ï¼Œå¹¶åœ¨æ£€æµ‹åˆ°è¯¥æ ‡è®°æ—¶ç›´æ¥æ”¾è¡Œã€‚å¯ä»¥é€šè¿‡ `Reflector` ç±»å®ç°è¿™ä¸€åŠŸèƒ½ï¼ˆè¯¦ç»†ç”¨æ³•è§[æ­¤å¤„](/guards#putting-it-all-together)ï¼‰ã€‚

```ts
@Injectable()
export class AuthGuard implements CanActivate {
  constructor(
    private jwtService: JwtService,
    private reflector: Reflector
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
      context.getHandler(),
      context.getClass(),
    ])
    if (isPublic) {
      // ğŸ’¡ æ£€æµ‹åˆ°å…¬å¼€è·¯ç”±ï¼Œç›´æ¥æ”¾è¡Œ
      return true
    }

    const request = context.switchToHttp().getRequest()
    const token = this.extractTokenFromHeader(request)
    if (!token) {
      throw new UnauthorizedException()
    }
    try {
      const payload = await this.jwtService.verifyAsync(token, {
        secret: jwtConstants.secret,
      })
      // ğŸ’¡ å°† payload èµ‹å€¼åˆ° request å¯¹è±¡ï¼Œä¾¿äºåç»­è®¿é—®ç”¨æˆ·ä¿¡æ¯
      request['user'] = payload
    } catch {
      throw new UnauthorizedException()
    }
    return true
  }

  private extractTokenFromHeader(request: Request): string | undefined {
    const [type, token] = request.headers.authorization?.split(' ') ?? []
    return type === 'Bearer' ? token : undefined
  }
}
```

## é›†æˆ Passport

[Passport](https://github.com/jaredhanson/passport) æ˜¯ç›®å‰ç¤¾åŒºä¸­æœ€å—æ¬¢è¿çš„ Node.js èº«ä»½éªŒè¯åº“ï¼Œå·²åœ¨ä¼—å¤šç”Ÿäº§ç¯å¢ƒä¸­å¹¿æ³›åº”ç”¨ã€‚é€šè¿‡ `@nestjs/passport` æ¨¡å—ï¼Œä½ å¯ä»¥è½»æ¾åœ°å°† Passport é›†æˆåˆ° NestJS åº”ç”¨ä¸­ã€‚

æƒ³äº†è§£å¦‚ä½•åœ¨ NestJS ä¸­é›†æˆ Passportï¼Ÿè¯·å‚è€ƒæœ¬ç« çš„[è¯¦ç»†è¯´æ˜](/recipes/passport)ã€‚

## ç¤ºä¾‹

æœ¬ç« [ç¤ºä¾‹ä»£ç ](https://github.com/nestjs/nest/tree/master/sample/19-auth-jwt)æä¾›äº†å®Œæ•´çš„å®ç°ï¼Œæ¬¢è¿æŸ¥é˜…ã€‚
