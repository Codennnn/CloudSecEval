# æä¾›è€…

æä¾›è€…ï¼ˆProviderï¼‰æ˜¯ Nest çš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ã€‚è®¸å¤šåŸºç¡€çš„ Nest ç±»ï¼Œæ¯”å¦‚æœåŠ¡ï¼ˆServiceï¼‰ã€ä»“åº“ï¼ˆRepositoryï¼‰ã€å·¥å‚ï¼ˆFactoryï¼‰å’Œè¾…åŠ©ç±»ï¼ˆHelperï¼‰ï¼Œéƒ½å¯ä»¥è¢«è§†ä¸ºæä¾›è€…ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**å¯ä»¥è¢«æ³¨å…¥ä¸ºä¾èµ–é¡¹**ï¼Œè®©å¯¹è±¡ä¹‹é—´å»ºç«‹å¤šç§å…³ç³»ã€‚è¿™äº›å¯¹è±¡çš„â€œç»„è£…â€å·¥ä½œï¼Œå¤§å¤šç”± Nest çš„è¿è¡Œæ—¶ç³»ç»Ÿè‡ªåŠ¨å®Œæˆã€‚

```mermaid
graph TB
    subgraph "NestJS Provider æ¶æ„è¯¦è§£"

        subgraph "æ¨¡å—æ³¨å†Œ"
            AppModule["AppModule<br/>@Module({<br/>  controllers: [CatsController],<br/>  providers: [CatsService]<br/>})"]
        end

        subgraph "æ§åˆ¶å™¨å±‚"
            CatsController["CatsController<br/>@Controller('cats')<br/><br/>constructor(<br/>  private catsService: CatsService<br/>)<br/><br/>@Get() findAll()<br/>@Post() create()"]
        end

        subgraph "æœåŠ¡æä¾›è€…å±‚"
            CatsService["CatsService<br/>@Injectable()<br/><br/>private cats: Cat[] = []<br/><br/>create(cat: Cat)<br/>findAll(): Cat[]"]
        end

        subgraph "IoC å®¹å™¨æœºåˆ¶"
            subgraph "ä¾èµ–è§£æè¿‡ç¨‹"
                Step1["1ï¸âƒ£ æ‰«æ @Injectable()"]
                Step2["2ï¸âƒ£ åˆ›å»ºä¾èµ–å›¾"]
                Step3["3ï¸âƒ£ å®ä¾‹åŒ–é¡ºåº"]
                Step4["4ï¸âƒ£ æ³¨å…¥åˆ°æ„é€ å‡½æ•°"]
            end
        end

        subgraph "ğŸ’¡ æ³¨å…¥æ–¹å¼å¯¹æ¯”"
            Constructor2["æ„é€ å‡½æ•°æ³¨å…¥<br/>constructor(private service: Service)<br/>â€¢ æ¨èæ–¹å¼<br/>â€¢ ä¾èµ–æ˜ç¡®<br/>â€¢ å¿…éœ€ä¾èµ–"]
            Property2["âš¡ å±æ€§æ³¨å…¥<br/>@Inject('TOKEN')<br/>private service: Service<br/>â€¢ ç‰¹æ®Šåœºæ™¯<br/>â€¢ é¿å…super()ä¼ é€’"]
            Optional2["â“ å¯é€‰ä¾èµ–<br/>@Optional() @Inject('TOKEN')<br/>private config?: Config<br/>â€¢ éå¿…éœ€ä¾èµ–<br/>â€¢ æœ‰é»˜è®¤å€¼"]
        end

        subgraph "ç”Ÿå‘½å‘¨æœŸç®¡ç†"
            Singleton["å•ä¾‹æ¨¡å¼<br/>ï¼ˆé»˜è®¤ï¼‰<br/>åº”ç”¨çº§åˆ«å…±äº«"]
            Request["è¯·æ±‚ä½œç”¨åŸŸ<br/>REQUEST<br/>æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹"]
            Transient["ç¬æ—¶ä½œç”¨åŸŸ<br/>TRANSIENT<br/>æ¯æ¬¡æ³¨å…¥æ–°å®ä¾‹"]
        end

        subgraph "Provider ç±»å‹"
            TypeService["Service<br/>ä¸šåŠ¡é€»è¾‘å¤„ç†"]
            TypeRepo["Repository<br/>æ•°æ®æŒä¹…åŒ–"]
            TypeFactory["Factory<br/>å¤æ‚å¯¹è±¡åˆ›å»º"]
            TypeHelper["Helper<br/>å·¥å…·å‡½æ•°é›†åˆ"]
        end
    end

    %% ä¸»è¦æµç¨‹
    AppModule -->|"æ³¨å†Œåˆ° providers[]"| CatsService
    AppModule -->|"æ³¨å†Œåˆ° controllers[]"| CatsController
    CatsService -->|"é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥"| CatsController

    %% IoC å®¹å™¨å¤„ç†æµç¨‹
    Step1 --> Step2
    Step2 --> Step3
    Step3 --> Step4
    Step4 -->|"å®Œæˆæ³¨å…¥"| CatsController

    %% æ³¨å…¥æ–¹å¼è¯´æ˜
    CatsController -.->|"ä¸»è¦ä½¿ç”¨"| Constructor2
    CatsController -.->|"ç‰¹æ®Šæƒ…å†µ"| Property2
    CatsController -.->|"å¯é€‰åœºæ™¯"| Optional2

    %% ç”Ÿå‘½å‘¨æœŸ
    CatsService -.->|"é»˜è®¤"| Singleton
    CatsService -.->|"å¯é…ç½®"| Request
    CatsService -.->|"å¯é…ç½®"| Transient

        %% Provider åˆ†ç±»
    CatsService -.->|"å±äº"| TypeService
    TypeService -.-> TypeRepo
    TypeRepo -.-> TypeFactory
    TypeFactory -.-> TypeHelper
```

åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„ `CatsController`ã€‚æ§åˆ¶å™¨è´Ÿè´£å¤„ç† HTTP è¯·æ±‚ï¼Œå¹¶å°†æ›´å¤æ‚çš„ä»»åŠ¡å§”æ‰˜ç»™æä¾›è€…ã€‚æ‰€è°“æä¾›è€…ï¼Œå…¶å®å°±æ˜¯åœ¨ NestJS æ¨¡å—ä¸­é€šè¿‡ `providers` å£°æ˜çš„æ™®é€š JavaScript ç±»ã€‚æ›´å¤šç»†èŠ‚å¯å‚è€ƒã€Œæ¨¡å—ã€ç« èŠ‚ã€‚

<CalloutInfo>
  ç”±äº Nest å…è®¸ä½ ä»¥é¢å‘å¯¹è±¡çš„æ–¹å¼è®¾è®¡å’Œç»„ç»‡ä¾èµ–å…³ç³»ï¼Œå¼ºçƒˆå»ºè®®éµå¾ª [SOLID
  åŸåˆ™](https://en.wikipedia.org/wiki/SOLID)ã€‚
</CalloutInfo>

## æœåŠ¡çš„å®šä¹‰ä¸ä½¿ç”¨

æˆ‘ä»¬å…ˆæ¥åˆ›å»ºä¸€ä¸ªç®€å•çš„ `CatsService`ï¼Œç”¨äºæ•°æ®çš„å­˜å‚¨å’Œæ£€ç´¢ï¼Œå¹¶è¢« `CatsController` è°ƒç”¨ã€‚ç”±äºå®ƒä¸»è¦è´Ÿè´£åº”ç”¨çš„ä¸šåŠ¡é€»è¾‘ï¼Œéå¸¸é€‚åˆè¢«å®šä¹‰ä¸ºä¸€ä¸ªæœåŠ¡æä¾›è€…ã€‚

```ts filename='cats.service.ts'
import { Injectable } from '@nestjs/common'
import { Cat } from './interfaces/cat.interface'

@Injectable()
export class CatsService {
  private readonly cats: Cat[] = []

  create(cat: Cat) {
    this.cats.push(cat)
  }

  findAll(): Cat[] {
    return this.cats
  }
}
```

```js hideInDoc filename='cats.service.js'
import { Injectable } from '@nestjs/common'

@Injectable()
export class CatsService {
  constructor() {
    this.cats = []
  }

  create(cat) {
    this.cats.push(cat)
  }

  findAll() {
    return this.cats
  }
}
```

<CalloutInfo>
  <div>ä½ å¯ä»¥é€šè¿‡ CLI æ‰§è¡Œ `$ nest g service cats` å‘½ä»¤æ¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ªæœåŠ¡ã€‚</div>
</CalloutInfo>

`CatsService` æ˜¯ä¸€ä¸ªå¸¦æœ‰å±æ€§å’Œä¸¤ä¸ªæ–¹æ³•çš„åŸºç¡€ç±»ï¼Œæœ€é‡è¦çš„å˜åŒ–æ˜¯æ·»åŠ äº† `@Injectable()` è£…é¥°å™¨ã€‚è¯¥è£…é¥°å™¨ä¸ºç±»é™„åŠ å…ƒæ•°æ®ï¼Œè¡¨æ˜ `CatsService` å¯ä»¥è¢« Nest [æ§åˆ¶åè½¬ï¼ˆInversion of Controlï¼ŒIoCï¼‰](https://en.wikipedia.org/wiki/Inversion_of_control) å®¹å™¨ç®¡ç†ã€‚

æ­¤å¤–ï¼Œç¤ºä¾‹ä¸­è¿˜ç”¨åˆ°äº† `Cat` æ¥å£ï¼Œå…¶å®šä¹‰å¤§è‡´å¦‚ä¸‹ï¼š

```ts filename='interfaces/cat.interface.ts'
export interface Cat {
  name: string
  age: number
  breed: string
}
```

ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ç”¨äºè·å–çŒ«æ•°æ®çš„æœåŠ¡ç±»ï¼Œæ¥ä¸‹æ¥åœ¨ `CatsController` ä¸­ä½¿ç”¨å®ƒï¼š

```ts filename='cats.controller.ts'
import { Controller, Get, Post, Body } from '@nestjs/common'
import { CreateCatDto } from './dto/create-cat.dto'
import { CatsService } from './cats.service'
import { Cat } from './interfaces/cat.interface'

@Controller('cats')
export class CatsController {
  constructor(private catsService: CatsService) {}

  @Post()
  async create(@Body() createCatDto: CreateCatDto) {
    this.catsService.create(createCatDto)
  }

  @Get()
  async findAll(): Promise<Cat[]> {
    return this.catsService.findAll()
  }
}
```

```js hideInDoc filename='cats.controller.js'
import { Controller, Get, Post, Body, Bind, Dependencies } from '@nestjs/common'
import { CatsService } from './cats.service'

@Controller('cats')
@Dependencies(CatsService)
export class CatsController {
  constructor(catsService) {
    this.catsService = catsService
  }

  @Post()
  @Bind(Body())
  async create(createCatDto) {
    this.catsService.create(createCatDto)
  }

  @Get()
  async findAll() {
    return this.catsService.findAll()
  }
}
```

`CatsService` é€šè¿‡ç±»æ„é€ å‡½æ•°è¢«æ³¨å…¥ã€‚æ³¨æ„è¿™é‡Œä½¿ç”¨äº† `private` å…³é”®å­—ï¼Œè¿™æ˜¯ä¸€ç§ç®€å†™æ–¹å¼ï¼Œå¯ä»¥åœ¨åŒä¸€è¡Œä¸­å£°æ˜å¹¶åˆå§‹åŒ– `catsService` æˆå‘˜ï¼Œä»è€Œç®€åŒ–äº†ä»£ç ã€‚

## ä¾èµ–æ³¨å…¥æœºåˆ¶

Nest æ„å»ºäºå¼ºå¤§çš„è®¾è®¡æ¨¡å¼ â€”â€” ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰ä¹‹ä¸Šã€‚å»ºè®®é˜…è¯»å®˜æ–¹ [Angular æ–‡æ¡£](https://angular.dev/guide/di) å¯¹è¯¥æ¦‚å¿µçš„ç²¾å½©ä»‹ç»ã€‚

åœ¨ Nest ä¸­ï¼Œå¾—ç›Šäº TypeScriptï¼Œä¾èµ–ç®¡ç†å˜å¾—éå¸¸ç®€å•ï¼Œä¾èµ–ä¼šæ ¹æ®ç±»å‹è‡ªåŠ¨è§£æã€‚å¦‚ä¸‹ä¾‹ï¼ŒNest ä¼šè‡ªåŠ¨åˆ›å»ºå¹¶è¿”å› `CatsService` çš„å®ä¾‹ï¼ˆå•ä¾‹æ¨¡å¼ä¸‹è¿”å›å·²å­˜åœ¨å®ä¾‹ï¼‰ï¼Œå¹¶æ³¨å…¥åˆ°æ§åˆ¶å™¨çš„æ„é€ å‡½æ•°ä¸­ï¼š

```ts
constructor(private catsService: CatsService) {}
```

## æä¾›è€…çš„ä½œç”¨åŸŸ

æä¾›è€…é€šå¸¸æ‹¥æœ‰ä¸åº”ç”¨ç”Ÿå‘½å‘¨æœŸä¸€è‡´çš„ä½œç”¨åŸŸã€‚å½“åº”ç”¨å¯åŠ¨æ—¶ï¼Œæ¯ä¸ªä¾èµ–éƒ½å¿…é¡»è¢«è§£æï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªæä¾›è€…éƒ½ä¼šè¢«å®ä¾‹åŒ–ã€‚åº”ç”¨å…³é—­æ—¶ï¼Œæ‰€æœ‰æä¾›è€…éƒ½ä¼šè¢«é”€æ¯ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥å°†æä¾›è€…è®¾ç½®ä¸º**è¯·æ±‚ä½œç”¨åŸŸ**ï¼Œå³ç”Ÿå‘½å‘¨æœŸä¸å•ä¸ªè¯·æ±‚ç»‘å®šã€‚æ›´å¤šå†…å®¹è§[æ³¨å…¥ä½œç”¨åŸŸ](/fundamentals/injection-scopes)ç« èŠ‚ã€‚

## è‡ªå®šä¹‰æä¾›è€…

Nest å†…ç½®äº†æ§åˆ¶åè½¬ï¼ˆIoCï¼‰å®¹å™¨ï¼Œç”¨äºç®¡ç†æä¾›è€…å…³ç³»ã€‚è¿™æ˜¯ä¾èµ–æ³¨å…¥çš„åŸºç¡€ï¼Œä½†å®é™…ä¸ŠåŠŸèƒ½è¿œä¸æ­¢å¦‚æ­¤ã€‚å®šä¹‰æä¾›è€…æœ‰å¤šç§æ–¹å¼ï¼šå¯ä»¥ä½¿ç”¨æ™®é€šå€¼ã€ç±»ã€åŒæ­¥æˆ–å¼‚æ­¥å·¥å‚ç­‰ã€‚æ›´å¤šç¤ºä¾‹è§[ä¾èµ–æ³¨å…¥](/fundamentals/dependency-injection)ç« èŠ‚ã€‚

## å¯é€‰ä¾èµ–

æœ‰æ—¶ï¼Œä¾èµ–é¡¹å¹¶éå¿…é¡»ã€‚ä¾‹å¦‚ï¼Œç±»å¯èƒ½ä¾èµ–äºä¸€ä¸ªé…ç½®å¯¹è±¡ï¼Œä½†å¦‚æœæ²¡æœ‰æä¾›è¯¥å¯¹è±¡ï¼Œåˆ™åº”ä½¿ç”¨é»˜è®¤å€¼ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥ä¾èµ–è¢«è§†ä¸ºå¯é€‰ï¼Œç¼ºå°‘é…ç½®æä¾›è€…æ—¶ä¸ä¼šæŠ›å‡ºé”™è¯¯ã€‚

è¦å°†æä¾›è€…æ ‡è®°ä¸ºå¯é€‰ï¼Œå¯ä»¥åœ¨æ„é€ å‡½æ•°å‚æ•°ä¸Šä½¿ç”¨ `@Optional()` è£…é¥°å™¨ï¼š

```ts
import { Injectable, Optional, Inject } from '@nestjs/common'

@Injectable()
export class HttpService<T> {
  constructor(@Optional() @Inject('HTTP_OPTIONS') private httpClient: T) {}
}
```

ä¸Šä¾‹ä¸­ï¼Œä½¿ç”¨äº†è‡ªå®šä¹‰æä¾›è€…ï¼Œå› æ­¤éœ€è¦ä¼ å…¥ `HTTP_OPTIONS` è¿™ä¸ªè‡ªå®šä¹‰**ä»¤ç‰Œï¼ˆtokenï¼‰**ã€‚å‰é¢çš„ç¤ºä¾‹å±•ç¤ºäº†åŸºäºæ„é€ å‡½æ•°çš„æ³¨å…¥æ–¹å¼ã€‚å…³äºè‡ªå®šä¹‰æä¾›è€…åŠå…¶ä»¤ç‰Œï¼Œè¯¦è§[è‡ªå®šä¹‰æä¾›è€…](/fundamentals/custom-providers)ç« èŠ‚ã€‚

## å±æ€§æ³¨å…¥æ–¹å¼

ç›®å‰ä¸ºæ­¢æˆ‘ä»¬ç”¨åˆ°çš„éƒ½æ˜¯åŸºäºæ„é€ å‡½æ•°çš„æ³¨å…¥æ–¹å¼ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå±æ€§æ³¨å…¥ï¼ˆProperty-based Injectionï¼‰ä¹Ÿå¾ˆæœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œé¡¶å±‚ç±»ä¾èµ–å¤šä¸ªæä¾›è€…ä¸”éœ€é€šè¿‡ `super()` å±‚å±‚ä¼ é€’æ—¶ï¼Œå¯èƒ½ä¼šå˜å¾—ç¹çã€‚æ­¤æ—¶å¯ç›´æ¥åœ¨å±æ€§ä¸Šä½¿ç”¨ `@Inject()` è£…é¥°å™¨ï¼š

```ts
import { Injectable, Inject } from '@nestjs/common'

@Injectable()
export class HttpService<T> {
  @Inject('HTTP_OPTIONS')
  private readonly httpClient: T
}
```

<CalloutInfo type="warning">
  å¦‚æœç±»æ²¡æœ‰ç»§æ‰¿å…¶ä»–ç±»ï¼Œé€šå¸¸å»ºè®®ä¼˜å…ˆä½¿ç”¨**åŸºäºæ„é€ å‡½æ•°**çš„æ³¨å…¥æ–¹å¼ã€‚æ„é€ å‡½æ•°èƒ½æ¸…æ™°è¡¨æ˜æ‰€éœ€ä¾èµ–ï¼Œæœ‰åŠ©äºæå‡ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œç›¸æ¯”ç”¨
  `@Inject` æ³¨è§£çš„ç±»å±æ€§æ›´ç›´è§‚ã€‚
</CalloutInfo>

## æ³¨å†Œæä¾›è€…

ç°åœ¨æˆ‘ä»¬å·²ç»å®šä¹‰äº†ä¸€ä¸ªæä¾›è€…ï¼ˆ`CatsService`ï¼‰å’Œä¸€ä¸ªæ¶ˆè´¹è€…ï¼ˆ`CatsController`ï¼‰ï¼Œæ¥ä¸‹æ¥éœ€è¦å°†æœåŠ¡æ³¨å†Œåˆ° Nest ä¸­ï¼Œè¿™æ ·å®ƒæ‰èƒ½è¢«æ­£ç¡®æ³¨å…¥ã€‚åªéœ€ç¼–è¾‘æ¨¡å—æ–‡ä»¶ï¼ˆ`app.module.ts`ï¼‰ï¼Œå°†æœåŠ¡æ·»åŠ åˆ° `@Module()` è£…é¥°å™¨çš„ `providers` æ•°ç»„å³å¯ï¼š

```ts filename='app.module.ts'
import { Module } from '@nestjs/common'
import { CatsController } from './cats/cats.controller'
import { CatsService } from './cats/cats.service'

@Module({
  controllers: [CatsController],
  providers: [CatsService],
})
export class AppModule {}
```

è¿™æ ·ï¼ŒNest å°±èƒ½è§£æ `CatsController` çš„ä¾èµ–äº†ã€‚

æ­¤æ—¶ï¼Œæˆ‘ä»¬çš„ç›®å½•ç»“æ„åº”å¦‚ä¸‹æ‰€ç¤ºï¼š

<FileTree
  data={[
    {
      name: 'src',
      children: [
        {
          name: 'cats',
          children: [
            { name: 'dto', children: [{ name: 'create-cat.dto.ts' }] },
            { name: 'interfaces', children: [{ name: 'cat.interface.ts' }] },
            { name: 'cats.controller.ts' },
            { name: 'cats.service.ts' },
          ],
        },
        { name: 'app.module.ts' },
        { name: 'main.ts' },
      ],
    },
  ]}
/>

## æ‰‹åŠ¨å®ä¾‹åŒ–æä¾›è€…

å‰æ–‡ä»‹ç»äº† Nest å¦‚ä½•è‡ªåŠ¨å¤„ç†ä¾èµ–è§£æã€‚ä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½éœ€è¦ç»•è¿‡å†…ç½®ä¾èµ–æ³¨å…¥ç³»ç»Ÿï¼Œæ‰‹åŠ¨è·å–æˆ–å®ä¾‹åŒ–æä¾›è€…ã€‚å¸¸è§æ–¹å¼æœ‰ï¼š

- è‹¥éœ€åŠ¨æ€è·å–ç°æœ‰å®ä¾‹æˆ–å®ä¾‹åŒ–æä¾›è€…ï¼Œå¯ä½¿ç”¨[æ¨¡å—å¼•ç”¨](/fundamentals/module-ref)ã€‚
- è‹¥éœ€åœ¨ `bootstrap()` å‡½æ•°ä¸­è·å–æä¾›è€…ï¼ˆå¦‚ç‹¬ç«‹åº”ç”¨æˆ–å¯åŠ¨é˜¶æ®µç”¨é…ç½®æœåŠ¡ï¼‰ï¼Œè¯·å‚è€ƒ[ç‹¬ç«‹åº”ç”¨ï¼ˆStandalone applicationsï¼‰](/standalone-applications)ã€‚
